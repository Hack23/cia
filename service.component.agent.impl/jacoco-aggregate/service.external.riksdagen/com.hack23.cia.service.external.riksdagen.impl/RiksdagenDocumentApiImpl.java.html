<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>RiksdagenDocumentApiImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">service.component.agent.impl</a> &gt; <a href="../index.html" class="el_bundle">service.external.riksdagen</a> &gt; <a href="index.source.html" class="el_package">com.hack23.cia.service.external.riksdagen.impl</a> &gt; <span class="el_source">RiksdagenDocumentApiImpl.java</span></div><h1>RiksdagenDocumentApiImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2010-2019 James Pether SÃ¶rling
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 *	$Id$
 *  $HeadURL$
*/
package com.hack23.cia.service.external.riksdagen.impl;

import java.math.BigInteger;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;

import javax.xml.bind.JAXBElement;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.oxm.Unmarshaller;
import org.springframework.stereotype.Component;

import com.hack23.cia.model.external.riksdagen.documentcontent.impl.DocumentContentData;
import com.hack23.cia.model.external.riksdagen.dokumentlista.impl.DocumentContainerElement;
import com.hack23.cia.model.external.riksdagen.dokumentlista.impl.DocumentElement;
import com.hack23.cia.model.external.riksdagen.dokumentstatus.impl.DocumentStatusContainer;
import com.hack23.cia.model.external.riksdagen.dokumentstatus.impl.DocumentType;
import com.hack23.cia.service.external.common.api.ProcessDataStrategy;
import com.hack23.cia.service.external.common.api.XmlAgent;
import com.hack23.cia.service.external.common.api.XmlAgentException;
import com.hack23.cia.service.external.riksdagen.api.DataFailureException;
import com.hack23.cia.service.external.riksdagen.api.RiksdagenDocumentApi;

/**
 * The Class RiksdagenDocumentApiImpl.
 */
@Component
final class RiksdagenDocumentApiImpl implements RiksdagenDocumentApi {

	/** The Constant CHANGED_SINCE_KEY. */
	private static final String CHANGED_SINCE_KEY = &quot;${CHANGED_SINCE}&quot;;

	/** The Constant CHANGED_TO_KEY. */
	private static final String CHANGED_TO_KEY = &quot;${CHANGED_TO}&quot;;

	/** The Constant DOC_ID_KEY. */
	private static final String DOC_ID_KEY = &quot;${DOC_ID}&quot;;

	/** The Constant DOCUMENT_CONTENT. */
	private static final String DOCUMENT_CONTENT = &quot;https://data.riksdagen.se/dokument/${DOC_ID}/xml&quot;;

	/** The Constant DOCUMENT_LIST_CHANGED_DATE. */
	private static final String DOCUMENT_LIST_CHANGED_DATE = &quot;https://data.riksdagen.se/dokumentlista/?sok=&amp;doktyp=&amp;rm=&amp;from=${CHANGED_SINCE}&amp;tom=${CHANGED_TO}&amp;ts=&amp;bet=&amp;tempbet=&amp;nr=&amp;org=&amp;iid=&amp;webbtv=&amp;talare=&amp;exakt=&amp;planering=&amp;sort=datum&amp;sortorder=asc&amp;rapport=&amp;utformat=xml&amp;a=&quot;;

	/** The Constant DOCUMENT_LIST_TYPE. */
	private static final String DOCUMENT_LIST_TYPE = &quot;https://data.riksdagen.se/dokumentlista/?rm=&amp;typ=${TYPE}&amp;d=&amp;ts=&amp;parti=&amp;iid=&amp;bet=&amp;org=&amp;kat=&amp;sz=200&amp;sort=c&amp;utformat=xml&quot;;

	/** The Constant DOCUMENT_LIST_YEAR. */
	private static final String DOCUMENT_LIST_YEAR = &quot;https://data.riksdagen.se/dokumentlista/?rm=${YEAR}&amp;typ=&amp;d=&amp;ts=&amp;parti=&amp;iid=&amp;bet=&amp;org=&amp;kat=&amp;sz=200&amp;sort=c&amp;utformat=xml&quot;;

	/** The Constant DOCUMENT_STATUS. */
	private static final String DOCUMENT_STATUS = &quot;https://data.riksdagen.se/dokumentstatus/${ID_KEY}/xml&quot;;

	/** The Constant ERROR_PROCESSING_DOCUMENT. */
	private static final String ERROR_PROCESSING_DOCUMENT = &quot;Error processing document :{}&quot;;

	/**
	 * The Constant HTTP_DOKUMENTLISTA_RIKSDAGEN_EXTERNAL_MODEL_CIA_HACK23_COM_IMPL.
	 */
	private static final String HTTP_DOKUMENTLISTA_RIKSDAGEN_EXTERNAL_MODEL_CIA_HACK23_COM_IMPL = &quot;http://dokumentlista.riksdagen.external.model.cia.hack23.com/impl&quot;;

	/**
	 * The Constant
	 * HTTP_DOKUMENTSTATUS_RIKSDAGEN_EXTERNAL_MODEL_CIA_HACK23_COM_IMPL.
	 */
	private static final String HTTP_DOKUMENTSTATUS_RIKSDAGEN_EXTERNAL_MODEL_CIA_HACK23_COM_IMPL = &quot;http://dokumentstatus.riksdagen.external.model.cia.hack23.com/impl&quot;;

	/** The Constant ID_KEY. */
	private static final String ID_KEY = &quot;${ID_KEY}&quot;;

	/** The Constant LOADING_DOCUMENTS. */
	private static final String LOADING_DOCUMENTS = &quot;Loading documents:{}/{}&quot;;

	/** The Constant LOGGER. */
<span class="nc" id="L97">	private static final Logger LOGGER = LoggerFactory.getLogger(RiksdagenDocumentApiImpl.class);</span>

	/** The Constant PAGE_PROPERTY. */
	private static final String PAGE_PROPERTY = &quot;&amp;p=&quot;;

	/**
	 * The Constant
	 * PROBLEM_GETTING_DOCUMENT_CONTENT_FOR_ID_S_FROM_DATA_RIKSDAGEN_SE.
	 */
	private static final String PROBLEM_GETTING_DOCUMENT_CONTENT_FOR_ID_S_FROM_DATA_RIKSDAGEN_SE = &quot;Problem getting document content for id:{} from data.riksdagen.se&quot;;

	/**
	 * The Constant
	 * PROBLEM_GETTING_DOCUMENT_LIST_CHANGED_SINCE_DATE_S_CHANGED_TO_DATE_S_FROM_DATA_RIKSDAGEN_SE.
	 */
	private static final String PROBLEM_GETTING_DOCUMENT_LIST_CHANGED_SINCE_DATE_S_CHANGED_TO_DATE_S_FROM_DATA_RIKSDAGEN_SE = &quot;Problem getting document list changedSinceDate:{} , changedToDate:{} from data.riksdagen.se&quot;;

	/**
	 * The Constant
	 * PROBLEM_GETTING_DOCUMENT_LIST_FOR_DOCUMENT_TYPE_S_MAX_NUMBER_PAGES_S_FROM_DATA_RIKSDAGEN_SE.
	 */
	private static final String PROBLEM_GETTING_DOCUMENT_LIST_FOR_DOCUMENT_TYPE_S_MAX_NUMBER_PAGES_S_FROM_DATA_RIKSDAGEN_SE = &quot;Problem getting document list for documentType:{} , maxNumberPages: {} from data.riksdagen.se&quot;;

	/**
	 * The Constant PROBLEM_GETTING_DOCUMENT_LIST_FOR_YEAR_S_FROM_DATA_RIKSDAGEN_SE.
	 */
	private static final String PROBLEM_GETTING_DOCUMENT_LIST_FOR_YEAR_S_FROM_DATA_RIKSDAGEN_SE = &quot;Problem getting document list for year: {} from data.riksdagen.se&quot;;

	/** The Constant PROBLEM_GETTING_DOCUMENT_STATUS_ID_S_FROM_DATA_RIKSDAGEN_SE. */
	private static final String PROBLEM_GETTING_DOCUMENT_STATUS_ID_S_FROM_DATA_RIKSDAGEN_SE = &quot;Problem getting document status id:{}  from data.riksdagen.se&quot;;

	/**
	 * The Constant
	 * PROBLEM_PROCCESSING_DOCUMENT_BETWEEN_CHANGED_SINCE_DATE_S_AND_CHANGE_TO_DATE.
	 */
	private static final String PROBLEM_PROCCESSING_DOCUMENT_BETWEEN_CHANGED_SINCE_DATE_S_AND_CHANGE_TO_DATE = &quot;Problem proccessing document between changedSinceDate: {} and changeToDate {}&quot;;

	/** The Constant TYPE_KEY. */
	private static final String TYPE_KEY = &quot;${TYPE}&quot;;

	/** The Constant YEAR_KEY. */
	private static final String YEAR_KEY = &quot;${YEAR}&quot;;

	/** The riksdagen document list marshaller. */
	@Autowired
	@Qualifier(&quot;riksdagenDocumentListMarshaller&quot;)
	private Unmarshaller riksdagenDocumentListMarshaller;

	/** The riksdagen document status marshaller. */
	@Autowired
	@Qualifier(&quot;riksdagenDocumentStatusMarshaller&quot;)
	private Unmarshaller riksdagenDocumentStatusMarshaller;

	/** The xml agent. */
	private final XmlAgent xmlAgent;

	/**
	 * Instantiates a new riksdagen document api impl.
	 *
	 * @param xmlAgent
	 *            the xml agent
	 */
	@Autowired
	public RiksdagenDocumentApiImpl(final XmlAgent xmlAgent) {
<span class="nc" id="L161">		super();</span>
<span class="nc" id="L162">		this.xmlAgent = xmlAgent;</span>
<span class="nc" id="L163">	}</span>

	/**
	 * Fix broken url.
	 *
	 * @param nextPage
	 *            the next page
	 * @return the string
	 */
	private static String fixBrokenUrl(final String nextPage) {
<span class="nc bnc" id="L173" title="All 2 branches missed.">		if (nextPage.startsWith(&quot;//&quot;)) {</span>
<span class="nc" id="L174">			return &quot;http:&quot; + nextPage;</span>
		} else {
<span class="nc" id="L176">			return nextPage;</span>
		}
	}

	/**
	 * Process all.
	 *
	 * @param dokument
	 *            the dokument
	 * @param processStrategy
	 *            the process strategy
	 */
	private static void processAll(final List&lt;DocumentElement&gt; dokument,
			final ProcessDataStrategy&lt;DocumentElement&gt; processStrategy) {
<span class="nc bnc" id="L190" title="All 2 branches missed.">		for (final DocumentElement documentElement : dokument) {</span>

			try {
<span class="nc" id="L193">				processStrategy.process(documentElement);</span>
<span class="nc" id="L194">			} catch (final RuntimeException e) {</span>
<span class="nc" id="L195">				LOGGER.warn(ERROR_PROCESSING_DOCUMENT, documentElement.getId(), e);</span>
<span class="nc" id="L196">			}</span>
<span class="nc" id="L197">		}</span>
<span class="nc" id="L198">	}</span>

	/* (non-Javadoc)
	 * @see com.hack23.cia.service.external.riksdagen.api.RiksdagenDocumentApi#getDocumentContent(java.lang.String)
	 */
	@Override
	public DocumentContentData getDocumentContent(final String id) throws DataFailureException {
		try {
<span class="nc" id="L206">			return new DocumentContentData().withId(UrlHelper.urlEncode(id,StandardCharsets.UTF_8.toString()))</span>
<span class="nc" id="L207">					.withContent(xmlAgent.retriveContent(DOCUMENT_CONTENT.replace(DOC_ID_KEY, id)));</span>
<span class="nc" id="L208">		} catch (final XmlAgentException e) {</span>
<span class="nc" id="L209">			LOGGER.warn(PROBLEM_GETTING_DOCUMENT_CONTENT_FOR_ID_S_FROM_DATA_RIKSDAGEN_SE, id);</span>
<span class="nc" id="L210">			throw new DataFailureException(e);</span>
		}
	}

	/* (non-Javadoc)
	 * @see com.hack23.cia.service.external.riksdagen.api.RiksdagenDocumentApi#getDocumentList(com.hack23.cia.model.external.riksdagen.dokumentstatus.impl.DocumentType, int)
	 */
	@Override
	public List&lt;DocumentElement&gt; getDocumentList(final DocumentType documentType, final int maxNumberPages)
			throws DataFailureException {
		try {
<span class="nc" id="L221">			return loadDocumentList(DOCUMENT_LIST_TYPE.replace(TYPE_KEY, documentType.value()), maxNumberPages);</span>
<span class="nc" id="L222">		} catch (final XmlAgentException e) {</span>
<span class="nc" id="L223">			LOGGER.warn(PROBLEM_GETTING_DOCUMENT_LIST_FOR_DOCUMENT_TYPE_S_MAX_NUMBER_PAGES_S_FROM_DATA_RIKSDAGEN_SE,</span>
<span class="nc" id="L224">					documentType, Integer.toString(maxNumberPages));</span>
<span class="nc" id="L225">			throw new DataFailureException(e);</span>
		}
	}

	/* (non-Javadoc)
	 * @see com.hack23.cia.service.external.riksdagen.api.RiksdagenDocumentApi#getDocumentList(java.lang.Integer, int)
	 */
	@Override
	public List&lt;DocumentElement&gt; getDocumentList(final Integer year, final int maxNumberPages)
			throws DataFailureException {
		try {
<span class="nc" id="L236">			return loadDocumentList(DOCUMENT_LIST_YEAR.replace(YEAR_KEY, year.toString()), maxNumberPages);</span>
<span class="nc" id="L237">		} catch (final XmlAgentException e) {	</span>
<span class="nc" id="L238">			LOGGER.warn(PROBLEM_GETTING_DOCUMENT_LIST_FOR_YEAR_S_FROM_DATA_RIKSDAGEN_SE, year);</span>
<span class="nc" id="L239">			throw new DataFailureException(e);</span>
		}
	}

	/* (non-Javadoc)
	 * @see com.hack23.cia.service.external.riksdagen.api.RiksdagenDocumentApi#getDocumentList(java.lang.String, java.lang.String, int)
	 */
	@Override
	public List&lt;DocumentElement&gt; getDocumentList(final String changedSinceDate, final String changedToDate,
			final int maxNumberPages) throws DataFailureException {
		try {
<span class="nc" id="L250">			return loadDocumentList(DOCUMENT_LIST_CHANGED_DATE.replace(CHANGED_SINCE_KEY, changedSinceDate)</span>
<span class="nc" id="L251">					.replace(CHANGED_TO_KEY, changedToDate), maxNumberPages);</span>
<span class="nc" id="L252">		} catch (final XmlAgentException e) {</span>
<span class="nc" id="L253">			LOGGER.warn(PROBLEM_GETTING_DOCUMENT_LIST_CHANGED_SINCE_DATE_S_CHANGED_TO_DATE_S_FROM_DATA_RIKSDAGEN_SE,</span>
					changedSinceDate, changedToDate);
<span class="nc" id="L255">			throw new DataFailureException(e);</span>
		}
	}

	/* (non-Javadoc)
	 * @see com.hack23.cia.service.external.riksdagen.api.RiksdagenDocumentApi#getDocumentStatus(java.lang.String)
	 */
	@Override
	public DocumentStatusContainer getDocumentStatus(final String id) throws DataFailureException {
		try {
<span class="nc" id="L265">			final String url = DOCUMENT_STATUS.replace(ID_KEY, UrlHelper.urlEncode(id,StandardCharsets.UTF_8.toString()));</span>
<span class="nc" id="L266">			return ((JAXBElement&lt;DocumentStatusContainer&gt;) xmlAgent.unmarshallXml(riksdagenDocumentStatusMarshaller,</span>
<span class="nc" id="L267">					url, HTTP_DOKUMENTSTATUS_RIKSDAGEN_EXTERNAL_MODEL_CIA_HACK23_COM_IMPL, null, null)).getValue();</span>
<span class="nc" id="L268">		} catch (final XmlAgentException e) {</span>
<span class="nc" id="L269">			LOGGER.warn(PROBLEM_GETTING_DOCUMENT_STATUS_ID_S_FROM_DATA_RIKSDAGEN_SE, id);</span>
<span class="nc" id="L270">			throw new DataFailureException(e);</span>
		} 
	}


	/**
	 * Load and process document list.
	 *
	 * @param url
	 *            the url
	 * @param processStrategy
	 *            the process strategy
	 * @throws XmlAgentException
	 *             the xml agent exception
	 */
	private void loadAndProcessDocumentList(final String url,
			final ProcessDataStrategy&lt;DocumentElement&gt; processStrategy) throws XmlAgentException {
<span class="nc" id="L287">		final DocumentContainerElement dokumentLista = ((JAXBElement&lt;DocumentContainerElement&gt;) xmlAgent.unmarshallXml(</span>
				riksdagenDocumentListMarshaller, url, HTTP_DOKUMENTLISTA_RIKSDAGEN_EXTERNAL_MODEL_CIA_HACK23_COM_IMPL,
<span class="nc" id="L289">				null, null)).getValue();</span>

<span class="nc" id="L291">		int resultSize = dokumentLista.getDokument().size();</span>
<span class="nc" id="L292">		processAll(dokumentLista.getDokument(), processStrategy);</span>
<span class="nc" id="L293">		final BigInteger pages = dokumentLista.getTotalPages();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">		for (int i = 1; i &lt; pages.intValue(); i++) {</span>
<span class="nc" id="L295">			final DocumentContainerElement otherPagesdokumentLista = ((JAXBElement&lt;DocumentContainerElement&gt;) xmlAgent</span>
<span class="nc" id="L296">					.unmarshallXml(riksdagenDocumentListMarshaller, url + PAGE_PROPERTY + i,</span>
<span class="nc" id="L297">							HTTP_DOKUMENTLISTA_RIKSDAGEN_EXTERNAL_MODEL_CIA_HACK23_COM_IMPL, null, null)).getValue();</span>
<span class="nc" id="L298">			resultSize = resultSize + otherPagesdokumentLista.getDokument().size();</span>
<span class="nc" id="L299">			processAll(otherPagesdokumentLista.getDokument(), processStrategy);</span>
<span class="nc" id="L300">			LOGGER.info(LOADING_DOCUMENTS, resultSize, dokumentLista.getHits());</span>
		}
<span class="nc" id="L302">	}</span>

	/**
	 * Load document list.
	 *
	 * @param url
	 *            the url
	 * @param maxNumberPages
	 *            the max number pages
	 * @return the list
	 * @throws XmlAgentException
	 *             the xml agent exception
	 */
	private List&lt;DocumentElement&gt; loadDocumentList(final String url, final int maxNumberPages) throws XmlAgentException {
<span class="nc" id="L316">		final List&lt;DocumentElement&gt; result = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L318">		DocumentContainerElement dokumentLista = ((JAXBElement&lt;DocumentContainerElement&gt;) xmlAgent.unmarshallXml(</span>
				riksdagenDocumentListMarshaller, url, HTTP_DOKUMENTLISTA_RIKSDAGEN_EXTERNAL_MODEL_CIA_HACK23_COM_IMPL,
<span class="nc" id="L320">				null, null)).getValue();</span>
<span class="nc" id="L321">		result.addAll(dokumentLista.getDokument());</span>
<span class="nc" id="L322">		final BigInteger pages = dokumentLista.getTotalPages();</span>
<span class="nc bnc" id="L323" title="All 4 branches missed.">		for (int i = 1; i &lt; pages.intValue() &amp;&amp; i &lt; maxNumberPages; i++) {</span>
<span class="nc" id="L324">			dokumentLista = ((JAXBElement&lt;DocumentContainerElement&gt;) xmlAgent.unmarshallXml(</span>
<span class="nc" id="L325">					riksdagenDocumentListMarshaller, fixBrokenUrl(dokumentLista.getNextPage()),</span>
<span class="nc" id="L326">					HTTP_DOKUMENTLISTA_RIKSDAGEN_EXTERNAL_MODEL_CIA_HACK23_COM_IMPL, null, null)).getValue();</span>
<span class="nc" id="L327">			result.addAll(dokumentLista.getDokument());</span>
<span class="nc" id="L328">			LOGGER.info(LOADING_DOCUMENTS, result.size(), dokumentLista.getHits());</span>
		}

<span class="nc" id="L331">		return result;</span>
	}

	/* (non-Javadoc)
	 * @see com.hack23.cia.service.external.riksdagen.api.RiksdagenDocumentApi#processDocumentList(java.lang.String, java.lang.String, com.hack23.cia.service.external.common.api.ProcessDataStrategy)
	 */
	@Override
	public void processDocumentList(final String changedSinceDate, final String changedToDate,
			final ProcessDataStrategy&lt;DocumentElement&gt; processStrategy) throws DataFailureException {
		try {
<span class="nc" id="L341">			loadAndProcessDocumentList(DOCUMENT_LIST_CHANGED_DATE.replace(CHANGED_SINCE_KEY, changedSinceDate)</span>
<span class="nc" id="L342">					.replace(CHANGED_TO_KEY, changedToDate), processStrategy);</span>
<span class="nc" id="L343">		} catch (final XmlAgentException e) {</span>
<span class="nc" id="L344">			LOGGER.warn(PROBLEM_PROCCESSING_DOCUMENT_BETWEEN_CHANGED_SINCE_DATE_S_AND_CHANGE_TO_DATE, changedSinceDate,</span>
					changedToDate);
<span class="nc" id="L346">			throw new DataFailureException(e);</span>
<span class="nc" id="L347">		}</span>
<span class="nc" id="L348">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>