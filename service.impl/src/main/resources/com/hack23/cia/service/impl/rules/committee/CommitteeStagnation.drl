package com.hack23.cia.service.impl.rules.committee

import org.kie.api.runtime.KieRuntime

import com.hack23.cia.model.internal.application.data.committee.impl.ViewRiksdagenCommittee
import com.hack23.cia.model.internal.application.data.rules.impl.Status
import com.hack23.cia.service.impl.rules.CommitteeComplianceCheckImpl

rule "Committee with chronic stagnation - very low average documents per member"
	dialect "java"
	salience 100
    when
        // Note: avgDocumentsPerMember is cumulative (total_docs / total_members_ever),
        // not a quarterly rate. Internal documentation reports P25 â‰ˆ 1.34 docs/member/quarter.
        // Using < 1.0 as a cumulative threshold therefore corresponds to a level of output
        // that is well below the lower quartile on a per-quarter basis over a mandate,
        // and is intentionally treated as "chronic underperformance".
        $p : CommitteeComplianceCheckImpl(
            committee.active && 
            committee.currentMemberSize > 0 && 
            committee.avgDocumentsPerMember < 1.0 &&
            committee.documentsLastYear > 0
        )
    then
    	$p.addViolation( Status.CRITICAL, "CommitteeStagnation","Behavior", kcontext.getRule().getName(),"ChronicLowProductivityPerMember");
end

rule "Committee with declining output - current year significantly below historical"
	dialect "java"
	salience 75
    when
        $p : CommitteeComplianceCheckImpl(
            committee.active && 
            committee.totalDocuments > 0 &&
            committee.documentsLastYear > 0 &&
            committee.avgDocumentsPerMember > 0 &&
            committee.avgDocumentsPerMember < 2.0 &&
            committee.documentsLastYear < (committee.totalDocuments / 5)
        )
    then
    	$p.addViolation( Status.MAJOR, "CommitteeStagnation","Behavior", kcontext.getRule().getName(),"SignificantOutputDecline");
end

rule "Committee with minimal recent activity - few documents despite active status"
	dialect "java"
	salience 60
    when
        // Threshold: Large committee (10+ members) producing < 40 docs/year
        // Higher salience (60 vs 50) ensures this size-specific rule takes precedence over general low productivity rule
        $p : CommitteeComplianceCheckImpl(
            committee.active && 
            committee.currentMemberSize >= 10 &&
            committee.documentsLastYear > 0 &&
            committee.documentsLastYear < 40
        )
    then
    	$p.addViolation( Status.MAJOR, "CommitteeStagnation","Behavior", kcontext.getRule().getName(),"MinimalActivityDespiteSize");
end

rule "Committee with combined risk - low total output and low per-member productivity"
	dialect "java"
	salience 125
    when
        // Threshold adjusted: < 60 docs/year AND < 1.5 cumulative avg docs/member
        $p : CommitteeComplianceCheckImpl(
            committee.active && 
            committee.currentMemberSize > 0 && 
            committee.documentsLastYear < 60 &&
            committee.documentsLastYear > 0 &&
            committee.avgDocumentsPerMember < 1.5
        )
    then
    	$p.addViolation( Status.CRITICAL, "CommitteeStagnation","Behavior", kcontext.getRule().getName(),"CombinedLowProductivity");
end
