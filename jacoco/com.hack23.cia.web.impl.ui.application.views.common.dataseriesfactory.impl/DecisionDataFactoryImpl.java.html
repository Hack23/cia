<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DecisionDataFactoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Citizen Intelligence Agency</a> &gt; <a href="index.source.html" class="el_package">com.hack23.cia.web.impl.ui.application.views.common.dataseriesfactory.impl</a> &gt; <span class="el_source">DecisionDataFactoryImpl.java</span></div><h1>DecisionDataFactoryImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2010-2024 James Pether Sörling
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 *	$Id$
 *  $HeadURL$
*/
package com.hack23.cia.web.impl.ui.application.views.common.dataseriesfactory.impl;

import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.regex.Pattern;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import com.hack23.cia.model.external.riksdagen.dokumentstatus.impl.DocumentProposalData;
import com.hack23.cia.model.external.riksdagen.dokumentstatus.impl.DocumentStatusContainer;
import com.hack23.cia.service.api.ApplicationManager;
import com.hack23.cia.service.api.DataContainer;
import com.hack23.cia.web.impl.ui.application.views.common.dataseriesfactory.api.DecisionDataFactory;
import com.hack23.cia.web.impl.ui.application.views.common.dataseriesfactory.api.ProposalCommitteeeSummary;

/**
 * The Class DecisionDataFactoryImpl.
 */
@Service
@Transactional(propagation = Propagation.REQUIRED, readOnly = true)
public final class DecisionDataFactoryImpl implements DecisionDataFactory {

    /** Common text constants for doc type. */
    private static final String PROP = &quot;Proposition&quot;;

    /** The Constant MOTION. */
    private static final String MOTION = &quot;Motion&quot;;

    /** Known min and max length constraints from original code. */
<span class="fc" id="L52">    private static final int CHAMBER_MIN_LENGTH = &quot;avslag&quot;.length(); // 6</span>

    /** The Constant CHAMBER_MAX_LENGTH. */
<span class="fc" id="L55">    private static final int CHAMBER_MAX_LENGTH = &quot;återförvisning till utskottet&quot;.length(); // 29</span>

    /**
     * Pattern for cleaning up the 'chamber' string. Aggregates multiple .replace() calls
     * into a single regex. This pattern will remove or replace these tokens:
     *  (UTSKOTTET), ( or ), UTBSKOTTET, UBTSKOTTET, UTKOTTET
     *
     * We'll do it case-insensitively, but remember we do an uppercase pass anyway.
     */
<span class="fc" id="L64">    private static final Pattern CLEANUP_PATTERN = Pattern.compile(</span>
        &quot;(\\(UTSKOTTET\\))|(\\()|(\\))|(UTBSKOTTET)|(UBTSKOTTET)|(UTKOTTET)&quot;,
        Pattern.CASE_INSENSITIVE
    );

    /** The application manager. */
    @Autowired
    private ApplicationManager applicationManager;

    /**
     * Instantiates a new decision data factory impl.
     */
    public DecisionDataFactoryImpl() {
<span class="fc" id="L77">        super();</span>
<span class="fc" id="L78">    }</span>

    /**
     * Creates the committee summary.
     *
     * @param processedIn the processed in
     * @return the list
     */
    @Override
    public List&lt;ProposalCommitteeeSummary&gt; createCommitteeSummary(final String processedIn) {
<span class="fc" id="L88">        final List&lt;ProposalCommitteeeSummary&gt; summary = new ArrayList&lt;&gt;();</span>

        // NOTE: Still loads ALL DocumentStatusContainer rows
<span class="fc" id="L91">        final DataContainer&lt;DocumentStatusContainer, Long&gt; dataContainer =</span>
<span class="fc" id="L92">                applicationManager.getDataContainer(DocumentStatusContainer.class);</span>

        // For each doc, potentially add a summary
<span class="fc bfc" id="L95" title="All 2 branches covered.">        for (final DocumentStatusContainer document : dataContainer.getAll()) {</span>
<span class="fc" id="L96">            addProposalCommitteeeSummary(processedIn, summary, document);</span>
<span class="fc" id="L97">        }</span>
<span class="fc" id="L98">        return summary;</span>
    }

    /**
     * Check and build a summary if the document qualifies based on 'processedIn' and
     * the proposal/chamber constraints.
     *
     * @param processedIn the processed in
     * @param summary the summary
     * @param document the document
     */
    private static void addProposalCommitteeeSummary(final String processedIn,
            final List&lt;ProposalCommitteeeSummary&gt; summary, final DocumentStatusContainer document) {

        // Null checks on 'documentProposal' and 'proposal'
<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (document.getDocumentProposal() == null ||</span>
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">            document.getDocumentProposal().getProposal() == null) {</span>
<span class="fc" id="L115">            return;</span>
        }

<span class="fc" id="L118">        final DocumentProposalData proposal = document.getDocumentProposal().getProposal();</span>
<span class="fc" id="L119">        final String chamber = proposal.getChamber();</span>
        // Are we processed in the correct place?
<span class="pc bpc" id="L121" title="2 of 6 branches missed.">        if ((chamber == null) || proposal.getProcessedIn() == null || proposal.getProcessedIn().isEmpty()) {</span>
<span class="fc" id="L122">            return;</span>
        }
        // Do we have a non-empty 'committee'?
        // Does 'processedIn' match?
<span class="pc bpc" id="L126" title="1 of 6 branches missed.">        if (proposal.getCommittee() == null || proposal.getCommittee().isEmpty() || !proposal.getProcessedIn().contains(processedIn)) {</span>
<span class="fc" id="L127">            return;</span>
        }
        // Is the chamber length within the specified min/max?
<span class="fc" id="L130">        final int length = chamber.length();</span>
<span class="pc bpc" id="L131" title="2 of 4 branches missed.">        if (length &lt; CHAMBER_MIN_LENGTH || length &gt; CHAMBER_MAX_LENGTH) {</span>
<span class="nc" id="L132">            return;</span>
        }

        // If all checks pass, add the summary
<span class="fc" id="L136">        summary.add(new ProposalCommitteeeSummary(</span>
<span class="fc" id="L137">            getCommitteeShortName(proposal),</span>
<span class="fc" id="L138">            getDocumentName(document),</span>
<span class="fc" id="L139">            cleanupDecision(chamber),</span>
<span class="fc" id="L140">            document.getDocument().getHangarId(),</span>
<span class="fc" id="L141">            proposal.getWording(),</span>
<span class="fc" id="L142">            proposal.getWording2(),</span>
<span class="fc" id="L143">            proposal.getDecisionType()</span>
        ));
<span class="fc" id="L145">    }</span>

    /**
     * Cleanup the 'chamber' string by uppercasing, removing tokens via regex,
     * and normalizing &quot;UTKOTTET&quot; to &quot;UTSKOTTET&quot; if it appears alone.
     *
     * @param chamber the chamber
     * @return the string
     */
    private static String cleanupDecision(final String chamber) {
        // Convert to uppercase English
<span class="fc" id="L156">        String upper = chamber.toUpperCase(Locale.ENGLISH);</span>

        // Remove or replace known substrings with the pattern
<span class="fc" id="L159">        upper = CLEANUP_PATTERN.matcher(upper).replaceAll(&quot;&quot;);</span>

        // If we find &quot;UTKOTTET&quot; alone, replace it with &quot;UTSKOTTET&quot;
        // (We already removed parentheses above).
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">        if (upper.contains(&quot;UTKOTTET&quot;)) {</span>
<span class="nc" id="L164">            upper = upper.replace(&quot;UTKOTTET&quot;, &quot;UTSKOTTET&quot;);</span>
        }
<span class="fc" id="L166">        return upper.trim();</span>
    }

    /**
     * Extract the committee short name from 'processedIn' by removing digits
     * and certain punctuation, converting to uppercase, and truncating if comma found.
     *
     * @param proposal the proposal
     * @return the committee short name
     */
    private static String getCommitteeShortName(final DocumentProposalData proposal) {
        // e.g. &quot;UU12&quot; =&gt; &quot;UU&quot; then uppercase =&gt; &quot;UU&quot;
<span class="fc" id="L178">        final String upperCase = proposal.getProcessedIn()</span>
<span class="fc" id="L179">                                   .replaceAll(&quot;\\d&quot;, &quot;&quot;)</span>
<span class="fc" id="L180">                                   .replace(&quot;/:&quot;, &quot;&quot;)</span>
<span class="fc" id="L181">                                   .toUpperCase(Locale.ENGLISH);</span>
        // If there's a comma, only take up to that comma
<span class="fc" id="L183">        final int commaIndex = upperCase.indexOf(',');</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">        return (commaIndex &gt;= 0) ? upperCase.substring(0, commaIndex) : upperCase;</span>
    }

    /**
     * Return a human-readable doc name: &quot;Proposition&quot; if docType=&quot;prop&quot;,
     * or doc.getSubType() if subType is long enough, else &quot;Motion&quot;.
     *
     * @param document the document
     * @return the document name
     */
    private static String getDocumentName(final DocumentStatusContainer document) {
<span class="fc bfc" id="L195" title="All 2 branches covered.">        if (&quot;prop&quot;.equalsIgnoreCase(document.getDocument().getDocumentType())) {</span>
<span class="fc" id="L196">            return PROP;</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">        } else if (document.getDocument().getSubType() != null</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">                   &amp;&amp; document.getDocument().getSubType().length() &gt; MOTION.length()) {</span>
<span class="fc" id="L199">            return document.getDocument().getSubType();</span>
        } else {
<span class="nc" id="L201">            return MOTION;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>