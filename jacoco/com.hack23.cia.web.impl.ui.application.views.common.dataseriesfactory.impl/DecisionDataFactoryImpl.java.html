<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DecisionDataFactoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Citizen Intelligence Agency</a> &gt; <a href="index.source.html" class="el_package">com.hack23.cia.web.impl.ui.application.views.common.dataseriesfactory.impl</a> &gt; <span class="el_source">DecisionDataFactoryImpl.java</span></div><h1>DecisionDataFactoryImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2010-2025 James Pether Sörling
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 *	$Id$
 *  $HeadURL$
*/
package com.hack23.cia.web.impl.ui.application.views.common.dataseriesfactory.impl;

import java.util.List;
import java.util.Locale;
import java.util.Objects;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import com.hack23.cia.model.external.riksdagen.dokumentstatus.impl.DocumentProposalData;
import com.hack23.cia.model.external.riksdagen.dokumentstatus.impl.DocumentStatusContainer;
import com.hack23.cia.service.api.ApplicationManager;
import com.hack23.cia.web.impl.ui.application.views.common.dataseriesfactory.api.DecisionDataFactory;
import com.hack23.cia.web.impl.ui.application.views.common.dataseriesfactory.api.ProposalCommitteeeSummary;

/**
 * Implementation of DecisionDataFactory for processing parliamentary committee decisions.
 * Handles document status data and creates summaries of committee proposals.
 */
@Service
@Transactional(propagation = Propagation.REQUIRED, readOnly = true)
<span class="fc" id="L45">public final class DecisionDataFactoryImpl implements DecisionDataFactory {</span>

    /**  Document type constants. */
    private static final String PROPOSITION = &quot;Proposition&quot;;

    /** The Constant MOTION. */
    private static final String MOTION = &quot;Motion&quot;;

    /** The Constant PROP_TYPE. */
    private static final String PROP_TYPE = &quot;prop&quot;;

    /**  Chamber text length constraints for valid proposals. */
<span class="fc" id="L57">    private static final int CHAMBER_MIN_LENGTH = &quot;avslag&quot;.length(); // 6</span>

    /** The Constant CHAMBER_MAX_LENGTH. */
<span class="fc" id="L60">    private static final int CHAMBER_MAX_LENGTH = &quot;återförvisning till utskottet&quot;.length(); // 29</span>

    /**
     * Pattern for standardizing committee decision text.
     * Removes or replaces parliamentary specific tokens:
     * - (UTSKOTTET)
     * - Parentheses
     * - Various committee spelling variants
     */
<span class="fc" id="L69">    private static final Pattern COMMITTEE_TEXT_CLEANUP_PATTERN = Pattern.compile(</span>
        &quot;(\\(UTSKOTTET\\))|(\\()|(\\))|(UTBSKOTTET)|(UBTSKOTTET)|(UTKOTTET)&quot;,
        Pattern.CASE_INSENSITIVE
    );

    /** The application manager. */
    @Autowired
    private ApplicationManager applicationManager;

    /**
     * Creates committee summaries for a specific processing location.
     *
     * @param processedIn the location where proposals were processed
     * @return List of committee summaries
     * @throws IllegalArgumentException if processedIn is blank
     */
    @Override
    public List&lt;ProposalCommitteeeSummary&gt; createCommitteeSummary(final String processedIn) {
<span class="fc" id="L87">        validateProcessedIn(processedIn);</span>

<span class="fc" id="L89">        return applicationManager.getDataContainer(DocumentStatusContainer.class)</span>
<span class="fc" id="L90">                .getAll()</span>
<span class="fc" id="L91">                .parallelStream()</span>
<span class="fc" id="L92">                .filter(doc -&gt; isValidDocument(doc, processedIn))</span>
<span class="fc" id="L93">                .map(doc -&gt; createProposalSummary(doc))</span>
<span class="fc" id="L94">                .filter(Objects::nonNull)</span>
<span class="fc" id="L95">                .collect(Collectors.toList());</span>
    }

    /**
     * Validates the processedIn parameter.
     *
     * @param processedIn location to validate
     * @throws IllegalArgumentException if validation fails
     */
    private void validateProcessedIn(final String processedIn) {
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (StringUtils.isBlank(processedIn)) {</span>
<span class="nc" id="L106">            throw new IllegalArgumentException(&quot;ProcessedIn parameter cannot be blank&quot;);</span>
        }
<span class="fc" id="L108">    }</span>

    /**
     * Validates if a document meets the criteria for processing.
     *
     * @param document the document to validate
     * @param processedIn the required processing location
     * @return true if document is valid for processing
     */
    private boolean isValidDocument(final DocumentStatusContainer document, final String processedIn) {
<span class="pc bpc" id="L118" title="1 of 4 branches missed.">        if (document == null || document.getDocumentProposal() == null ||</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">            document.getDocumentProposal().getProposal() == null) {</span>
<span class="fc" id="L120">            return false;</span>
        }

<span class="fc" id="L123">        final DocumentProposalData proposal = document.getDocumentProposal().getProposal();</span>
<span class="fc" id="L124">        return isValidProposal(proposal, processedIn);</span>
    }

    /**
     * Validates proposal data for processing requirements.
     *
     * @param proposal the proposal to validate
     * @param processedIn the required processing location
     * @return true if proposal meets requirements
     */
    private boolean isValidProposal(final DocumentProposalData proposal, final String processedIn) {
<span class="pc bpc" id="L135" title="1 of 4 branches missed.">        if (proposal == null || StringUtils.isBlank(proposal.getChamber()) ||</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">            StringUtils.isBlank(proposal.getProcessedIn()) ||</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">            StringUtils.isBlank(proposal.getCommittee())) {</span>
<span class="fc" id="L138">            return false;</span>
        }

<span class="fc" id="L141">        final int chamberLength = proposal.getChamber().length();</span>
<span class="fc bfc" id="L142" title="All 4 branches covered.">        return chamberLength &gt;= CHAMBER_MIN_LENGTH &amp;&amp;</span>
               chamberLength &lt;= CHAMBER_MAX_LENGTH &amp;&amp;
<span class="fc bfc" id="L144" title="All 2 branches covered.">               proposal.getProcessedIn().contains(processedIn);</span>
    }

    /**
     * Creates a ProposalCommitteeeSummary from a valid document.
     *
     * @param document source document
     * @return ProposalCommitteeeSummary or null if invalid
     */
    private ProposalCommitteeeSummary createProposalSummary(final DocumentStatusContainer document) {
        try {
<span class="fc" id="L155">            final DocumentProposalData proposal = document.getDocumentProposal().getProposal();</span>
<span class="fc" id="L156">            return new ProposalCommitteeeSummary(</span>
<span class="fc" id="L157">                extractCommitteeShortName(proposal),</span>
<span class="fc" id="L158">                determineDocumentType(document),</span>
<span class="fc" id="L159">                standardizeDecisionText(proposal.getChamber()),</span>
<span class="fc" id="L160">                document.getDocument().getHangarId(),</span>
<span class="fc" id="L161">                proposal.getWording(),</span>
<span class="fc" id="L162">                proposal.getWording2(),</span>
<span class="fc" id="L163">                proposal.getDecisionType()</span>
            );
<span class="nc" id="L165">        } catch (final Exception e) {</span>
            // Log error if needed
<span class="nc" id="L167">            return null;</span>
        }
    }

    /**
     * Standardizes the decision text by removing variations and normalizing format.
     *
     * @param chamber the original chamber text
     * @return standardized decision text
     */
    private static String standardizeDecisionText(final String chamber) {
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">        if (StringUtils.isBlank(chamber)) {</span>
<span class="nc" id="L179">            return &quot;&quot;;</span>
        }

<span class="fc" id="L182">        String standardized = chamber.toUpperCase(Locale.ENGLISH);</span>
<span class="fc" id="L183">        standardized = COMMITTEE_TEXT_CLEANUP_PATTERN.matcher(standardized).replaceAll(&quot;&quot;);</span>

        // Normalize committee spelling
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">        if (standardized.contains(&quot;UTKOTTET&quot;)) {</span>
<span class="nc" id="L187">            standardized = standardized.replace(&quot;UTKOTTET&quot;, &quot;UTSKOTTET&quot;);</span>
        }

<span class="fc" id="L190">        return standardized.trim();</span>
    }

    /**
     * Extracts the standardized committee short name.
     *
     * @param proposal source proposal
     * @return committee short name
     */
    private static String extractCommitteeShortName(final DocumentProposalData proposal) {
<span class="fc" id="L200">        final String processedIn = proposal.getProcessedIn();</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">        if (StringUtils.isBlank(processedIn)) {</span>
<span class="nc" id="L202">            return &quot;&quot;;</span>
        }

<span class="fc" id="L205">        final String shortName = processedIn</span>
<span class="fc" id="L206">            .replaceAll(&quot;\\d&quot;, &quot;&quot;)</span>
<span class="fc" id="L207">            .replace(&quot;/:&quot;, &quot;&quot;)</span>
<span class="fc" id="L208">            .toUpperCase(Locale.ENGLISH);</span>

<span class="fc" id="L210">        final int commaIndex = shortName.indexOf(',');</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">        return (commaIndex &gt;= 0) ? shortName.substring(0, commaIndex) : shortName;</span>
    }

    /**
     * Determines the human-readable document type.
     *
     * @param document source document
     * @return document type string
     */
    private static String determineDocumentType(final DocumentStatusContainer document) {
<span class="fc bfc" id="L221" title="All 2 branches covered.">        if (PROP_TYPE.equalsIgnoreCase(document.getDocument().getDocumentType())) {</span>
<span class="fc" id="L222">            return PROPOSITION;</span>
        }

<span class="fc" id="L225">        final String subType = document.getDocument().getSubType();</span>
<span class="pc bpc" id="L226" title="2 of 4 branches missed.">        return (subType != null &amp;&amp; subType.length() &gt; MOTION.length())</span>
<span class="fc" id="L227">               ? subType</span>
<span class="nc" id="L228">               : MOTION;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>