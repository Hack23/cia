<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommitteeDecisionFlowPageModContentFactoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Citizen Intelligence Agency</a> &gt; <a href="index.source.html" class="el_package">com.hack23.cia.web.impl.ui.application.views.user.committee.pagemode</a> &gt; <span class="el_source">CommitteeDecisionFlowPageModContentFactoryImpl.java</span></div><h1>CommitteeDecisionFlowPageModContentFactoryImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2010-2025 James Pether SÃ¶rling
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 *	$Id$
 *  $HeadURL$
*/
package com.hack23.cia.web.impl.ui.application.views.user.committee.pagemode;

import java.time.LocalDate;
import java.time.ZoneOffset;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.annotation.Secured;
import org.springframework.stereotype.Component;

import com.hack23.cia.model.internal.application.data.committee.impl.ViewRiksdagenCommittee;
import com.hack23.cia.model.internal.application.system.impl.ApplicationEventGroup;
import com.hack23.cia.web.impl.ui.application.action.ViewAction;
import com.hack23.cia.web.impl.ui.application.views.common.chartfactory.api.DecisionFlowChartManager;
import com.hack23.cia.web.impl.ui.application.views.common.menufactory.api.pagecommands.PageCommandCommitteeConstants;
import com.hack23.cia.web.impl.ui.application.views.common.pagemode.CardInfoRowUtil;
import com.hack23.cia.web.impl.ui.application.views.common.sizing.ContentRatio;
import com.hack23.cia.web.impl.ui.application.views.pageclicklistener.DecisionFlowValueChangeListener;
import com.hack23.cia.web.widgets.charts.SankeyChart;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.Layout;
import com.vaadin.ui.MenuBar;
import com.vaadin.ui.Panel;
import com.vaadin.ui.TextArea;
import com.vaadin.ui.VerticalLayout;

/**
 * The Class ParliamentDecisionFlowPageModContentFactoryImpl.
 */
@Component
<span class="fc" id="L55">public final class CommitteeDecisionFlowPageModContentFactoryImpl extends AbstractCommitteePageModContentFactoryImpl {</span>

    /** The Constant DEFAULT_YEAR. */
    private static final String DEFAULT_YEAR = &quot;2023/24&quot;;

    /** The decision flow chart manager. */
    @Autowired
    private DecisionFlowChartManager decisionFlowChartManager;

    /**
     * Creates the content.
     *
     * @param parameters the parameters
     * @param menuBar the menu bar
     * @param panel the panel
     * @return the layout
     */
    @Secured({ &quot;ROLE_ANONYMOUS&quot;, &quot;ROLE_USER&quot;, &quot;ROLE_ADMIN&quot; })
    @Override
    public Layout createContent(final String parameters, final MenuBar menuBar, final Panel panel) {
<span class="fc" id="L75">        final VerticalLayout panelContent = createPanelContent();</span>
<span class="fc" id="L76">        final String pageId = getPageId(parameters);</span>
<span class="fc" id="L77">        final ViewRiksdagenCommittee committee = getItem(parameters);</span>

<span class="fc" id="L79">        setupMenuAndHeader(menuBar, panel, panelContent, pageId, committee);</span>
<span class="fc" id="L80">        final String selectedYear = extractSelectedYear(parameters);</span>
<span class="fc" id="L81">        final Map&lt;String, List&lt;ViewRiksdagenCommittee&gt;&gt; committeeMap = loadCommitteeMap();</span>

<span class="fc" id="L83">        addYearSelector(panelContent, selectedYear, pageId);</span>
<span class="fc" id="L84">        addDecisionFlowChart(panelContent, committee, committeeMap, selectedYear);</span>
<span class="fc" id="L85">        addDecisionSummary(panelContent, committee, selectedYear);</span>

<span class="fc" id="L87">        recordPageVisit(parameters, pageId);</span>

<span class="fc" id="L89">        return panelContent;</span>
    }

    /**
     * Creates list of available years for selection.
     * Goes from 2010/11 up to (currentYear+1)/(currentYear+2).
     *
     * @return Unmodifiable list of year strings in format &quot;YYYY/YY&quot;
     */
    private static List&lt;String&gt; createAvailableYears() {
<span class="fc" id="L99">        final int currentYear = LocalDate.now((ZoneOffset.UTC)).getYear();</span>
<span class="fc" id="L100">        return IntStream.rangeClosed(2010, currentYear + 1)</span>
<span class="fc" id="L101">            .mapToObj(year -&gt; String.format(Locale.ENGLISH,&quot;%d/%02d&quot;, year, (year + 1) % 100))</span>
<span class="fc" id="L102">            .sorted(Comparator.reverseOrder()) // Most recent years first</span>
<span class="fc" id="L103">            .collect(Collectors.collectingAndThen(</span>
<span class="fc" id="L104">                Collectors.toList(),</span>
                Collections::unmodifiableList
            ));
    }

    /**
     * Setup menu and header.
     *
     * @param menuBar the menu bar
     * @param panel the panel
     * @param panelContent the panel content
     * @param pageId the page id
     * @param committee the committee
     */
    private void setupMenuAndHeader(final MenuBar menuBar, final Panel panel, final VerticalLayout panelContent,
            final String pageId, final ViewRiksdagenCommittee committee) {
<span class="fc" id="L120">        getCommitteeMenuItemFactory().createCommitteeeMenuBar(menuBar, pageId);</span>
<span class="fc" id="L121">        CardInfoRowUtil.createPageHeader(panel, panelContent,</span>
<span class="fc" id="L122">            CommitteeViewConstants.DF_TITLE_HEADER + committee.getEmbeddedId().getDetail(),</span>
            CommitteeViewConstants.DF_TITLE,
            CommitteeViewConstants.DF_DESCRIPTION
        );
<span class="fc" id="L126">    }</span>

    /**
     * Extract selected year.
     *
     * @param parameters the parameters
     * @return the string
     */
    private String extractSelectedYear(final String parameters) {
<span class="pc bpc" id="L135" title="4 of 6 branches missed.">        if (parameters != null &amp;&amp; parameters.contains(&quot;[&quot;) &amp;&amp; parameters.contains(&quot;]&quot;)) {</span>
<span class="nc" id="L136">            return parameters.substring(</span>
<span class="nc" id="L137">                parameters.indexOf('[') + 1,</span>
<span class="nc" id="L138">                parameters.lastIndexOf(']')</span>
            );
        }
<span class="fc" id="L141">        return DEFAULT_YEAR;</span>
    }

    /**
     * Load committee map.
     *
     * @return the map
     */
    private Map&lt;String, List&lt;ViewRiksdagenCommittee&gt;&gt; loadCommitteeMap() {
<span class="fc" id="L150">        return getApplicationManager()</span>
<span class="fc" id="L151">            .getDataContainer(ViewRiksdagenCommittee.class)</span>
<span class="fc" id="L152">            .getAll()</span>
<span class="fc" id="L153">            .stream()</span>
<span class="fc" id="L154">            .collect(Collectors.groupingBy(</span>
<span class="fc" id="L155">                committee -&gt; committee.getEmbeddedId().getOrgCode().toUpperCase(Locale.ENGLISH)</span>
            ));
    }

    /**
     * Adds the year selector.
     *
     * @param panelContent the panel content
     * @param selectedYear the selected year
     * @param pageId the page id
     */
    private void addYearSelector(final VerticalLayout panelContent, final String selectedYear, final String pageId) {
<span class="fc" id="L167">        final ComboBox&lt;String&gt; yearSelector = new ComboBox&lt;&gt;(CommitteeViewConstants.DF_YEAR_SELECTOR, createAvailableYears());</span>
<span class="fc" id="L168">        yearSelector.setWidth(&quot;200px&quot;);</span>
<span class="fc" id="L169">        yearSelector.setEmptySelectionAllowed(false);</span>
<span class="fc" id="L170">        yearSelector.setSelectedItem(selectedYear);</span>
<span class="fc" id="L171">        yearSelector.addValueChangeListener(new DecisionFlowValueChangeListener(NAME, pageId));</span>

<span class="fc" id="L173">        panelContent.addComponent(yearSelector);</span>
<span class="fc" id="L174">        panelContent.setExpandRatio(yearSelector, ContentRatio.SMALL2);</span>
<span class="fc" id="L175">    }</span>

    /**
     * Adds the decision flow chart.
     *
     * @param panelContent the panel content
     * @param committee the committee
     * @param committeeMap the committee map
     * @param selectedYear the selected year
     */
    private void addDecisionFlowChart(final VerticalLayout panelContent, final ViewRiksdagenCommittee committee,
            final Map&lt;String, List&lt;ViewRiksdagenCommittee&gt;&gt; committeeMap, final String selectedYear) {
<span class="fc" id="L187">        final SankeyChart chart = decisionFlowChartManager.createCommitteeDecisionFlow(</span>
            committee, committeeMap, selectedYear
        );
<span class="fc" id="L190">        chart.setWidth(&quot;100%&quot;);</span>

<span class="fc" id="L192">        panelContent.addComponent(chart);</span>
<span class="fc" id="L193">        panelContent.setExpandRatio(chart, ContentRatio.LARGE);</span>
<span class="fc" id="L194">    }</span>

    /**
     * Adds the decision summary.
     *
     * @param panelContent the panel content
     * @param committee the committee
     * @param selectedYear the selected year
     */
    private void addDecisionSummary(final VerticalLayout panelContent,
            final ViewRiksdagenCommittee committee, final String selectedYear) {
<span class="fc" id="L205">        final TextArea summaryArea = decisionFlowChartManager.createCommitteeeDecisionSummary(</span>
            committee, selectedYear
        );
<span class="fc" id="L208">        summaryArea.setSizeFull();</span>
<span class="fc" id="L209">        summaryArea.setReadOnly(true);</span>

<span class="fc" id="L211">        panelContent.addComponent(summaryArea);</span>
<span class="fc" id="L212">        panelContent.setExpandRatio(summaryArea, ContentRatio.SMALL_GRID);</span>
<span class="fc" id="L213">    }</span>

    /**
     * Record page visit.
     *
     * @param parameters the parameters
     * @param pageId the page id
     */
    private void recordPageVisit(final String parameters, final String pageId) {
<span class="fc" id="L222">        getPageActionEventHelper().createPageEvent(</span>
            ViewAction.VISIT_COMMITTEE_VIEW,
            ApplicationEventGroup.USER,
            NAME,
            parameters,
            pageId
        );
<span class="fc" id="L229">    }</span>

    /**
     * Matches.
     *
     * @param page the page
     * @param parameters the parameters
     * @return true, if successful
     */
    @Override
    public boolean matches(final String page, final String parameters) {
<span class="fc" id="L240">    	return PageCommandCommitteeConstants.COMMAND_CHARTS_DECISION_FLOW.matches(page, parameters);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>