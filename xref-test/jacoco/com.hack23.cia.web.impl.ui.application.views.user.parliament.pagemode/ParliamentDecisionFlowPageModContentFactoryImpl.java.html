<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ParliamentDecisionFlowPageModContentFactoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Citizen Intelligence Agency</a> &gt; <a href="index.source.html" class="el_package">com.hack23.cia.web.impl.ui.application.views.user.parliament.pagemode</a> &gt; <span class="el_source">ParliamentDecisionFlowPageModContentFactoryImpl.java</span></div><h1>ParliamentDecisionFlowPageModContentFactoryImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2010-2025 James Pether SÃ¶rling
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 *	$Id$
 *  $HeadURL$
*/
package com.hack23.cia.web.impl.ui.application.views.user.parliament.pagemode;

import java.time.LocalDate;
import java.time.ZoneOffset;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.annotation.Secured;
import org.springframework.stereotype.Component;

import com.hack23.cia.model.internal.application.data.committee.impl.ViewRiksdagenCommittee;
import com.hack23.cia.model.internal.application.system.impl.ApplicationEventGroup;
import com.hack23.cia.web.impl.ui.application.action.ViewAction;
import com.hack23.cia.web.impl.ui.application.views.common.chartfactory.api.DecisionFlowChartManager;
import com.hack23.cia.web.impl.ui.application.views.common.menufactory.api.pagecommands.PageCommandParliamentRankingConstants;
import com.hack23.cia.web.impl.ui.application.views.common.pagemode.CardInfoRowUtil;
import com.hack23.cia.web.impl.ui.application.views.common.sizing.ContentRatio;
import com.hack23.cia.web.impl.ui.application.views.pageclicklistener.DecisionFlowValueChangeListener;
import com.hack23.cia.web.widgets.charts.SankeyChart;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.Layout;
import com.vaadin.ui.MenuBar;
import com.vaadin.ui.Panel;
import com.vaadin.ui.TextArea;
import com.vaadin.ui.VerticalLayout;

/**
 * The Class ParliamentDecisionFlowPageModContentFactoryImpl.
 */
@Component
<span class="fc" id="L55">public final class ParliamentDecisionFlowPageModContentFactoryImpl extends AbstractParliamentPageModContentFactoryImpl {</span>

    /** The Constant DEFAULT_YEAR. */
    private static final String DEFAULT_YEAR = &quot;2023/24&quot;;

    /** The Constant YEAR_SELECTOR_LABEL. */
    private static final String YEAR_SELECTOR_LABEL = &quot;Select year&quot;;

    /** The decision flow chart manager. */
    @Autowired
    private DecisionFlowChartManager decisionFlowChartManager;

    /**
     * Creates the content.
     *
     * @param parameters the parameters
     * @param menuBar the menu bar
     * @param panel the panel
     * @return the layout
     */
    @Secured({ &quot;ROLE_ANONYMOUS&quot;, &quot;ROLE_USER&quot;, &quot;ROLE_ADMIN&quot; })
    @Override
    public Layout createContent(final String parameters, final MenuBar menuBar, final Panel panel) {
<span class="fc" id="L78">        final VerticalLayout panelContent = createPanelContent();</span>

<span class="fc" id="L80">        setupMenuAndHeader(menuBar, panel, panelContent);</span>
<span class="fc" id="L81">        final String selectedYear = extractSelectedYear(parameters);</span>
<span class="fc" id="L82">        final Map&lt;String, List&lt;ViewRiksdagenCommittee&gt;&gt; committeeMap = loadCommitteeMap();</span>

<span class="fc" id="L84">        addYearSelector(panelContent, selectedYear);</span>
<span class="fc" id="L85">        addDecisionFlowChart(panelContent, committeeMap, selectedYear);</span>
<span class="fc" id="L86">        addDecisionSummary(panelContent, committeeMap, selectedYear);</span>

<span class="fc" id="L88">        recordPageVisit(parameters, selectedYear);</span>

<span class="fc" id="L90">        return panelContent;</span>
    }

    /**
     * Creates list of available years for selection.
     * Goes from 2010/11 up to (currentYear+1)/(currentYear+2).
     *
     * @return Unmodifiable list of year strings in format &quot;YYYY/YY&quot;
     */
    private static List&lt;String&gt; createAvailableYears() {
<span class="fc" id="L100">        final int currentYear = LocalDate.now((ZoneOffset.UTC)).getYear();</span>
<span class="fc" id="L101">        return IntStream.rangeClosed(2010, currentYear + 1)</span>
<span class="fc" id="L102">            .mapToObj(year -&gt; String.format(Locale.ENGLISH,&quot;%d/%02d&quot;, year, (year + 1) % 100))</span>
<span class="fc" id="L103">            .sorted(Comparator.reverseOrder()) // Most recent years first</span>
<span class="fc" id="L104">            .collect(Collectors.collectingAndThen(</span>
<span class="fc" id="L105">                Collectors.toList(),</span>
                Collections::unmodifiableList
            ));
    }


    /**
     * Setup menu and header.
     *
     * @param menuBar the menu bar
     * @param panel the panel
     * @param panelContent the panel content
     */
    private void setupMenuAndHeader(final MenuBar menuBar, final Panel panel, final VerticalLayout panelContent) {
<span class="fc" id="L119">        getParliamentMenuItemFactory().createParliamentTopicMenu(menuBar);</span>
<span class="fc" id="L120">        CardInfoRowUtil.createPageHeader(panel, panelContent,</span>
            ParliamentPageTitleConstants.DECISION_FLOW_TITLE,
            ParliamentPageTitleConstants.DECISION_FLOW_SUBTITLE,
            ParliamentPageTitleConstants.DECISION_FLOW_DESC);
<span class="fc" id="L124">    }</span>

    /**
     * Extract selected year.
     *
     * @param parameters the parameters
     * @return the string
     */
    private String extractSelectedYear(final String parameters) {
<span class="pc bpc" id="L133" title="4 of 6 branches missed.">        if (parameters != null &amp;&amp; parameters.contains(&quot;[&quot;) &amp;&amp; parameters.contains(&quot;]&quot;)) {</span>
<span class="nc" id="L134">            return parameters.substring(</span>
<span class="nc" id="L135">                parameters.indexOf('[') + 1,</span>
<span class="nc" id="L136">                parameters.lastIndexOf(']')</span>
            );
        }
<span class="fc" id="L139">        return DEFAULT_YEAR;</span>
    }

    /**
     * Load committee map.
     *
     * @return the map
     */
    private Map&lt;String, List&lt;ViewRiksdagenCommittee&gt;&gt; loadCommitteeMap() {
<span class="fc" id="L148">        return getApplicationManager()</span>
<span class="fc" id="L149">            .getDataContainer(ViewRiksdagenCommittee.class)</span>
<span class="fc" id="L150">            .getAll()</span>
<span class="fc" id="L151">            .stream()</span>
<span class="fc" id="L152">            .collect(Collectors.groupingBy(</span>
<span class="fc" id="L153">                committee -&gt; committee.getEmbeddedId().getOrgCode().toUpperCase(Locale.ENGLISH)</span>
            ));
    }

    /**
     * Adds the year selector.
     *
     * @param panelContent the panel content
     * @param selectedYear the selected year
     */
    private void addYearSelector(final VerticalLayout panelContent, final String selectedYear) {
<span class="fc" id="L164">        final ComboBox&lt;String&gt; yearSelector = new ComboBox&lt;&gt;(YEAR_SELECTOR_LABEL, createAvailableYears());</span>
<span class="fc" id="L165">        yearSelector.setWidth(&quot;200px&quot;);</span>
<span class="fc" id="L166">        yearSelector.setEmptySelectionAllowed(false);</span>
<span class="fc" id="L167">        yearSelector.setSelectedItem(selectedYear);</span>
<span class="fc" id="L168">        yearSelector.addValueChangeListener(new DecisionFlowValueChangeListener(NAME, &quot;&quot;));</span>

<span class="fc" id="L170">        panelContent.addComponent(yearSelector);</span>
<span class="fc" id="L171">        panelContent.setExpandRatio(yearSelector, ContentRatio.SMALL);</span>
<span class="fc" id="L172">    }</span>

    /**
     * Adds the decision flow chart.
     *
     * @param panelContent the panel content
     * @param committeeMap the committee map
     * @param selectedYear the selected year
     */
    private void addDecisionFlowChart(final VerticalLayout panelContent,
            final Map&lt;String, List&lt;ViewRiksdagenCommittee&gt;&gt; committeeMap, final String selectedYear) {
<span class="fc" id="L183">        final SankeyChart chart = decisionFlowChartManager.createAllDecisionFlow(committeeMap, selectedYear);</span>
<span class="fc" id="L184">        chart.setWidth(&quot;100%&quot;);</span>

<span class="fc" id="L186">        panelContent.addComponent(chart);</span>
<span class="fc" id="L187">        panelContent.setExpandRatio(chart, ContentRatio.LARGE);</span>
<span class="fc" id="L188">}</span>

    /**
     * Adds the decision summary.
     *
     * @param panelContent the panel content
     * @param committeeMap the committee map
     * @param selectedYear the selected year
     */
    private void addDecisionSummary(final VerticalLayout panelContent,
            final Map&lt;String, List&lt;ViewRiksdagenCommittee&gt;&gt; committeeMap, final String selectedYear) {
<span class="fc" id="L199">        final TextArea summaryArea = decisionFlowChartManager.createCommitteeeDecisionSummary(committeeMap, selectedYear);</span>
<span class="fc" id="L200">        summaryArea.setSizeFull();</span>
<span class="fc" id="L201">        summaryArea.setReadOnly(true);</span>

<span class="fc" id="L203">        panelContent.addComponent(summaryArea);</span>
<span class="fc" id="L204">        panelContent.setExpandRatio(summaryArea, ContentRatio.SMALL_GRID);</span>
<span class="fc" id="L205">    }</span>

    /**
     * Record page visit.
     *
     * @param parameters the parameters
     * @param selectedYear the selected year
     */
    private void recordPageVisit(final String parameters, final String selectedYear) {
<span class="fc" id="L214">        getPageActionEventHelper().createPageEvent(</span>
            ViewAction.VISIT_PARLIAMENT_RANKING_VIEW,
            ApplicationEventGroup.USER,
            NAME,
            parameters,
            selectedYear
        );
<span class="fc" id="L221">    }</span>

    /**
     * Matches.
     *
     * @param page the page
     * @param parameters the parameters
     * @return true, if successful
     */
    @Override
    public boolean matches(final String page, final String parameters) {
<span class="fc" id="L232">    	return PageCommandParliamentRankingConstants.COMMAND_CHARTS_DECISION_FLOW.matches(page, parameters);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>