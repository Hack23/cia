<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DecisionFlowChartManagerImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Citizen Intelligence Agency</a> &gt; <a href="index.source.html" class="el_package">com.hack23.cia.web.impl.ui.application.views.common.chartfactory.impl</a> &gt; <span class="el_source">DecisionFlowChartManagerImpl.java</span></div><h1>DecisionFlowChartManagerImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2010-2025 James Pether SÃ¶rling
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 *	$Id$
 *  $HeadURL$
*/
package com.hack23.cia.web.impl.ui.application.views.common.chartfactory.impl;

import java.util.Collection;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.function.Function;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.hack23.cia.model.internal.application.data.committee.impl.ViewRiksdagenCommittee;
import com.hack23.cia.web.impl.ui.application.views.common.chartfactory.api.DecisionFlowChartManager;
import com.hack23.cia.web.impl.ui.application.views.common.dataseriesfactory.api.DecisionDataFactory;
import com.hack23.cia.web.impl.ui.application.views.common.dataseriesfactory.api.ProposalCommitteeeSummary;
import com.hack23.cia.web.widgets.charts.SankeyChart;
import com.vaadin.ui.TextArea;

/**
 * The Class DecisionFlowChartManagerImpl.
 */
@Service
public final class DecisionFlowChartManagerImpl implements DecisionFlowChartManager {

    /** The decision data factory. */
    @Autowired
    private DecisionDataFactory decisionDataFactory;

    /**
     * Instantiates a new decision flow chart manager impl.
     */
    public DecisionFlowChartManagerImpl() {
<span class="fc" id="L54">        super();</span>
<span class="fc" id="L55">    }</span>

    /**
     * Gets the org proposal map.
     *
     * @param reportMonth the report month
     * @return the org proposal map
     */
    // Core helper methods for common operations
    private Map&lt;String, List&lt;ProposalCommitteeeSummary&gt;&gt; getOrgProposalMap(final String reportMonth) {
<span class="fc" id="L65">        return decisionDataFactory.createCommitteeSummary(reportMonth)</span>
<span class="fc" id="L66">                .stream()</span>
<span class="fc" id="L67">                .filter(Objects::nonNull)</span>
<span class="fc" id="L68">                .collect(Collectors.groupingBy(</span>
                    ProposalCommitteeeSummary::org,
<span class="fc" id="L70">                    Collectors.mapping(</span>
<span class="fc" id="L71">                        Function.identity(),</span>
<span class="fc" id="L72">                        Collectors.toList()</span>
                    )
                ));
    }

    /**
     * Find committee.
     *
     * @param committeeSummaryMap the committee summary map
     * @param orgKey the org key
     * @return the optional
     */
    private Optional&lt;ViewRiksdagenCommittee&gt; findCommittee(
            final Map&lt;String, List&lt;ViewRiksdagenCommittee&gt;&gt; committeeSummaryMap,
            final String orgKey) {
<span class="fc" id="L87">        return Optional.ofNullable(committeeSummaryMap.get(orgKey))</span>
<span class="fc" id="L88">                .flatMap(list -&gt; list.stream().findFirst());</span>
    }

    /**
     * Creates the all decision flow.
     *
     * @param committeeSummaryMap the committee summary map
     * @param reportMonth the report month
     * @return the sankey chart
     */
    @Override
    public SankeyChart createAllDecisionFlow(
            final Map&lt;String, List&lt;ViewRiksdagenCommittee&gt;&gt; committeeSummaryMap,
            final String reportMonth) {

<span class="fc" id="L103">        Objects.requireNonNull(committeeSummaryMap, &quot;Committee summary map cannot be null&quot;);</span>
<span class="fc" id="L104">        Objects.requireNonNull(reportMonth, &quot;Report month cannot be null&quot;);</span>

<span class="fc" id="L106">        final SankeyChart sankeyChart = new SankeyChart();</span>

<span class="fc" id="L108">        getOrgProposalMap(reportMonth).entrySet().stream()</span>
<span class="pc bpc" id="L109" title="2 of 4 branches missed.">            .filter(entry -&gt; entry.getKey() != null &amp;&amp; !entry.getValue().isEmpty())</span>
<span class="fc" id="L110">            .forEach(entry -&gt;</span>
<span class="fc" id="L111">                findCommittee(committeeSummaryMap, entry.getKey())</span>
<span class="fc" id="L112">                    .ifPresent(committee -&gt;</span>
<span class="fc" id="L113">                        addChartData(sankeyChart, entry.getValue(), committee)));</span>

<span class="fc" id="L115">        sankeyChart.drawChart();</span>
<span class="fc" id="L116">        return sankeyChart;</span>
    }

    /**
     * Creates the committee decision flow.
     *
     * @param viewRiksdagenCommittee the view riksdagen committee
     * @param committeeSummaryMap the committee summary map
     * @param reportMonth the report month
     * @return the sankey chart
     */
    @Override
    public SankeyChart createCommitteeDecisionFlow(
            final ViewRiksdagenCommittee viewRiksdagenCommittee,
            final Map&lt;String, List&lt;ViewRiksdagenCommittee&gt;&gt; committeeSummaryMap,
            final String reportMonth) {

<span class="fc" id="L133">        Objects.requireNonNull(viewRiksdagenCommittee, &quot;Committee cannot be null&quot;);</span>

<span class="fc" id="L135">        final SankeyChart sankeyChart = new SankeyChart();</span>
<span class="fc" id="L136">        final String targetOrg = viewRiksdagenCommittee.getEmbeddedId().getOrgCode().toUpperCase(Locale.ENGLISH);</span>

<span class="fc" id="L138">        getOrgProposalMap(reportMonth).entrySet().stream()</span>
<span class="fc" id="L139">            .filter(entry -&gt; targetOrg.equals(entry.getKey().toUpperCase(Locale.ENGLISH)))</span>
<span class="fc" id="L140">            .forEach(entry -&gt; addDocTypeDecisionDataRows(sankeyChart, entry.getValue()));</span>

<span class="fc" id="L142">        sankeyChart.drawChart();</span>
<span class="fc" id="L143">        return sankeyChart;</span>
    }

    /**
     * Creates the committeee decision summary.
     *
     * @param committeeSummaryMap the committee summary map
     * @param reportMonth the report month
     * @return the text area
     */
    @Override
    public TextArea createCommitteeeDecisionSummary(
            final Map&lt;String, List&lt;ViewRiksdagenCommittee&gt;&gt; committeeSummaryMap,
            final String reportMonth) {

<span class="fc" id="L158">        final TextArea area = new TextArea(&quot;Summary&quot;);</span>
<span class="fc" id="L159">        final StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L160">        final Map&lt;String, List&lt;ProposalCommitteeeSummary&gt;&gt; orgProposalMap = getOrgProposalMap(reportMonth);</span>

<span class="fc" id="L162">        orgProposalMap.forEach((orgKey, proposals) -&gt; {</span>
<span class="fc" id="L163">            final String orgKeyUpper = orgKey.toUpperCase(Locale.ENGLISH);</span>
<span class="fc" id="L164">            findCommittee(committeeSummaryMap, orgKeyUpper)</span>
<span class="fc" id="L165">                .ifPresent(committee -&gt; addCommiteeSummary(builder, proposals, committee));</span>
<span class="fc" id="L166">        });</span>

<span class="fc" id="L168">        area.setValue(builder.toString());</span>
<span class="fc" id="L169">        return area;</span>
    }

    /**
     * Creates the committeee decision summary.
     *
     * @param viewRiksdagenCommittee the view riksdagen committee
     * @param reportMonth the report month
     * @return the text area
     */
    @Override
    public TextArea createCommitteeeDecisionSummary(
            final ViewRiksdagenCommittee viewRiksdagenCommittee,
            final String reportMonth) {

<span class="fc" id="L184">        final TextArea area = new TextArea(&quot;Summary&quot;);</span>
<span class="fc" id="L185">        final StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L186">        final String targetOrg = viewRiksdagenCommittee.getEmbeddedId().getOrgCode().toUpperCase(Locale.ENGLISH);</span>

<span class="fc" id="L188">        final List&lt;ProposalCommitteeeSummary&gt; proposals =</span>
<span class="fc" id="L189">            getOrgProposalMap(reportMonth).get(targetOrg);</span>

<span class="fc" id="L191">        addCommiteeSummary(builder, proposals, viewRiksdagenCommittee);</span>
<span class="fc" id="L192">        area.setValue(builder.toString());</span>
<span class="fc" id="L193">        return area;</span>
    }

    /**
     * Adds the chart data.
     *
     * @param sankeyChart the sankey chart
     * @param proposals the proposals
     * @param committee the committee
     */
    private void addChartData(
            final SankeyChart sankeyChart,
            final List&lt;ProposalCommitteeeSummary&gt; proposals,
            final ViewRiksdagenCommittee committee) {

<span class="fc" id="L208">        addDocTypeDataRows(sankeyChart, proposals, committee);</span>
<span class="fc" id="L209">        addDecisionDataRows(sankeyChart, proposals, committee);</span>
<span class="fc" id="L210">    }</span>

    /**
     * Adds the doc type data rows.
     *
     * @param sankeyChart the sankey chart
     * @param proposals the proposals
     * @param committee the committee
     */
    private static void addDocTypeDataRows(
            final SankeyChart sankeyChart,
            final List&lt;ProposalCommitteeeSummary&gt; proposals,
            final ViewRiksdagenCommittee committee) {

<span class="fc" id="L224">        final String committeeName = committee.getEmbeddedId().getDetail();</span>

<span class="fc" id="L226">        Optional.ofNullable(proposals)</span>
<span class="fc" id="L227">            .stream()</span>
<span class="fc" id="L228">            .flatMap(Collection::stream)</span>
<span class="fc" id="L229">            .filter(Objects::nonNull)</span>
<span class="fc" id="L230">            .collect(Collectors.groupingBy(</span>
                ProposalCommitteeeSummary::docType,
<span class="fc" id="L232">                Collectors.collectingAndThen(</span>
<span class="fc" id="L233">                    Collectors.toList(),</span>
                    docProposals -&gt; {
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">                        if (!docProposals.get(0).docType().isEmpty()) {</span>
<span class="fc" id="L236">                            sankeyChart.addDataRow(</span>
<span class="fc" id="L237">                                docProposals.get(0).docType(),</span>
                                committeeName,
<span class="fc" id="L239">                                docProposals.size()</span>
                            );
                        }
<span class="fc" id="L242">                        return docProposals;</span>
                    }
                )
            ));
<span class="fc" id="L246">    }</span>


    /**
     * Adds the decision data rows.
     *
     * @param sankeyChart the sankey chart
     * @param proposals the proposals
     * @param committee the committee
     */
    private static void addDecisionDataRows(
            final SankeyChart sankeyChart,
            final List&lt;ProposalCommitteeeSummary&gt; proposals,
            final ViewRiksdagenCommittee committee) {

<span class="fc" id="L261">        final String committeeName = committee.getEmbeddedId().getDetail();</span>

<span class="fc" id="L263">        proposals.stream()</span>
<span class="fc" id="L264">            .collect(Collectors.groupingBy(ProposalCommitteeeSummary::decision))</span>
<span class="fc" id="L265">            .forEach((decision, decisionProposals) -&gt; {</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">                if (!decision.isEmpty()) {</span>
<span class="fc" id="L267">                    sankeyChart.addDataRow(committeeName, decision, decisionProposals.size());</span>
                }
<span class="fc" id="L269">            });</span>
<span class="fc" id="L270">    }</span>

    /**
     * Adds the doc type decision data rows.
     *
     * @param sankeyChart the sankey chart
     * @param proposals the proposals
     */
    private static void addDocTypeDecisionDataRows(
            final SankeyChart sankeyChart,
            final List&lt;ProposalCommitteeeSummary&gt; proposals) {

<span class="fc" id="L282">        Optional.ofNullable(proposals)</span>
<span class="fc" id="L283">            .stream()</span>
<span class="fc" id="L284">            .flatMap(Collection::stream)</span>
<span class="fc" id="L285">            .filter(Objects::nonNull)</span>
<span class="fc" id="L286">            .collect(Collectors.groupingBy(</span>
                ProposalCommitteeeSummary::docType,
<span class="fc" id="L288">                Collectors.collectingAndThen(</span>
<span class="fc" id="L289">                    Collectors.toList(),</span>
                    docTypeProposals -&gt; {
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">                        if (!docTypeProposals.get(0).docType().isEmpty()) {</span>
<span class="fc" id="L292">                            addDecisionRowsForDocType(</span>
                                sankeyChart,
<span class="fc" id="L294">                                docTypeProposals.get(0).docType(),</span>
                                docTypeProposals
                            );
                        }
<span class="fc" id="L298">                        return docTypeProposals;</span>
                    }
                )
            ));
<span class="fc" id="L302">    }</span>

    /**
     * Adds the decision rows for doc type.
     *
     * @param sankeyChart the sankey chart
     * @param docType the doc type
     * @param proposals the proposals
     */
    private static void addDecisionRowsForDocType(
            final SankeyChart sankeyChart,
            final String docType,
            final List&lt;ProposalCommitteeeSummary&gt; proposals) {

<span class="fc" id="L316">        proposals.stream()</span>
<span class="fc" id="L317">            .collect(Collectors.groupingBy(ProposalCommitteeeSummary::decision))</span>
<span class="fc" id="L318">            .forEach((decision, decisionProposals) -&gt; {</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">                if (!decision.isEmpty()) {</span>
<span class="fc" id="L320">                    sankeyChart.addDataRow(docType, decision, decisionProposals.size());</span>
                }
<span class="fc" id="L322">            });</span>
<span class="fc" id="L323">    }</span>

    /**
     * Adds the commitee summary.
     *
     * @param builder the builder
     * @param proposals the proposals
     * @param committee the committee
     */
    private static void addCommiteeSummary(
            final StringBuilder builder,
            final List&lt;ProposalCommitteeeSummary&gt; proposals,
            final ViewRiksdagenCommittee committee) {

<span class="pc bpc" id="L337" title="3 of 6 branches missed.">        if (committee == null || proposals == null || proposals.isEmpty()) {</span>
<span class="nc" id="L338">            return;</span>
        }

<span class="fc" id="L341">        builder.append('\n').append(committee.getEmbeddedId().getDetail());</span>

<span class="fc" id="L343">        proposals.stream()</span>
<span class="fc" id="L344">            .filter(Objects::nonNull)</span>
<span class="fc" id="L345">            .collect(Collectors.groupingBy(</span>
                ProposalCommitteeeSummary::docType,
<span class="fc" id="L347">                Collectors.collectingAndThen(</span>
<span class="fc" id="L348">                    Collectors.toList(),</span>
                    docProposals -&gt; {
<span class="fc" id="L350">                        addSummaryEntry(builder, docProposals.get(0).docType(), docProposals);</span>
<span class="fc" id="L351">                        return docProposals;</span>
                    }
                )
            ));
<span class="fc" id="L355">    }</span>

    /**
     * Adds the summary entry.
     *
     * @param builder the builder
     * @param docType the doc type
     * @param docTypeList the doc type list
     */
    private static void addSummaryEntry(
            final StringBuilder builder,
            final String docType,
            final List&lt;ProposalCommitteeeSummary&gt; docTypeList) {

<span class="fc" id="L369">        builder.append(&quot;\n ( &quot;)</span>
<span class="fc" id="L370">               .append(docTypeList.size())</span>
<span class="fc" id="L371">               .append(' ')</span>
<span class="fc" id="L372">               .append(docType)</span>
<span class="fc" id="L373">               .append(&quot; -&gt; &quot;);</span>

<span class="fc" id="L375">        docTypeList.stream()</span>
<span class="fc" id="L376">            .collect(Collectors.groupingBy(ProposalCommitteeeSummary::decision))</span>
<span class="fc" id="L377">            .forEach((decision, decisionProposals) -&gt;</span>
<span class="fc" id="L378">                addDecisionDetails(builder, decision, decisionProposals));</span>

<span class="fc" id="L380">        builder.append(')');</span>
<span class="fc" id="L381">    }</span>

    /**
     * Adds the decision details.
     *
     * @param builder the builder
     * @param decision the decision
     * @param summaries the summaries
     */
    private static void addDecisionDetails(
            final StringBuilder builder,
            final String decision,
            final List&lt;ProposalCommitteeeSummary&gt; summaries) {

<span class="pc bpc" id="L395" title="1 of 2 branches missed.">        if (!decision.isEmpty()) {</span>
<span class="fc" id="L396">            builder.append(&quot;\n   &quot;)</span>
<span class="fc" id="L397">                   .append(summaries.size())</span>
<span class="fc" id="L398">                   .append(' ')</span>
<span class="fc" id="L399">                   .append(decision)</span>
<span class="fc" id="L400">                   .append(' ');</span>

<span class="fc" id="L402">            summaries.stream()</span>
<span class="fc" id="L403">                .filter(Objects::nonNull)</span>
<span class="fc" id="L404">                .forEach(summary -&gt;</span>
<span class="fc" id="L405">                    builder.append(&quot;\n    &quot;)</span>
<span class="fc" id="L406">                          .append(summary.decision())</span>
<span class="fc" id="L407">                          .append(':')</span>
<span class="fc" id="L408">                          .append(summary.wording())</span>
<span class="fc" id="L409">                          .append(' ')</span>
<span class="fc" id="L410">                          .append(summary.wording2())</span>
<span class="fc" id="L411">                          .append(' '));</span>
        }
<span class="fc" id="L413">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>