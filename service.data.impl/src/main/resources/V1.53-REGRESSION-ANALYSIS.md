# V1.53/V1.6 Party View Regression Analysis

## Executive Summary

Four party analysis views were dropped in database changelog versions 1.53 and 1.6 but were never properly recreated. Despite this, their corresponding JPA entity classes remain in `persistence.xml`, causing application failures when these views are queried. This document analyzes the regression and outlines the reconstruction requirements.

## Affected Views

| View Name | Dropped In | JPA Entity | Columns | Complexity | Status |
|-----------|-----------|------------|---------|------------|--------|
| `view_riksdagen_party_summary` | v1.6 | `ViewRiksdagenPartySummary` | 52 | Medium | ‚úÖ **RECREATED in v1.61** |
| `view_riksdagen_party_longitudinal_performance` | v1.53 | `ViewRiksdagenPartyLongitudinalPerformance` | 70 | Very High | ‚ö†Ô∏è **PLACEHOLDER (requires reconstruction)** |
| `view_riksdagen_party_coalition_evolution` | v1.53 | `ViewRiksdagenPartyCoalitionEvolution` | 35 | High | ‚ö†Ô∏è **PLACEHOLDER (requires reconstruction)** |
| `view_riksdagen_party_electoral_trends` | v1.53 | `ViewRiksdagenPartyElectoralTrends` | 49 | High | ‚ö†Ô∏è **PLACEHOLDER (requires reconstruction)** |

**Total**: 4 views, 206 columns, 3 require complex SQL reconstruction

## Root Cause Analysis

### V1.6 Regression: view_riksdagen_party_summary

**File**: `service.data.impl/src/main/resources/db-changelog-1.6.xml`

**Timeline**:
1. Changeset `1414872417007-277`: View dropped
2. Changeset `1414872417007-277`: View recreated (aggregating from `view_riksdagen_politician`)
3. Changeset `1414872417007-278`: View dropped AGAIN and never recreated

**Evidence**:
```xml
<!-- First drop and recreate -->
<changeSet author="pether" id="1414872417007-277">
    <dropView viewName="view_riksdagen_party_summary" />
    <createView viewName="view_riksdagen_party_summary">select...</createView>
</changeSet>

<!-- Second drop, NO recreate -->
<changeSet author="pether" id="1414872417007-278">
    <dropView viewName="view_riksdagen_party_summary" />
    <!-- Missing CREATE statement -->
</changeSet>
```

**Impact**: View exists in JPA (`ViewRiksdagenPartySummary.java`) but not in database.

### V1.53 Regression: Three Party Longitudinal Views

**File**: `service.data.impl/src/main/resources/db-changelog-1.53.xml`

**Timeline**:
1. Changesets drop all 3 views with `failOnError="false"`
2. Changesets declare intent to create views with comprehensive KPIs
3. CREATE VIEW SQL is incomplete/truncated (file ends at line 1060)
4. Views were never actually created

**Evidence**:
```xml
<changeSet author="intelligence-operative" id="1.53-drop-party-performance" failOnError="false">
    <sql>DROP VIEW IF EXISTS view_riksdagen_party_longitudinal_performance CASCADE;</sql>
</changeSet>

<changeSet author="intelligence-operative" id="1.53-party-longitudinal-001" failOnError="true">
    <comment>70+ metrics with RANK, PERCENT_RANK, NTILE, LAG, LEAD, STDDEV_POP</comment>
    <createView viewName="view_riksdagen_party_longitudinal_performance">
        <![CDATA[
WITH election_cycle_calendar AS (
    -- SQL starts but is incomplete/truncated
```

**Impact**: All 3 views exist in JPA but not in database.

## Impact Assessment

### Application Failures

When application code attempts to query these views through JPA:

```java
// This will fail with view not found error
entityManager.createQuery("FROM ViewRiksdagenPartySummary", ViewRiksdagenPartySummary.class).getResultList();
```

**Error**: `org.postgresql.util.PSQLException: ERROR: relation "view_riksdagen_party_summary" does not exist`

### Persistence.xml Orphans

**File**: `model.internal.application.user.impl/src/main/resources/META-INF/persistence.xml`

All 4 JPA entities are mapped:
```xml
<class>com.hack23.cia.model.internal.application.data.party.impl.ViewRiksdagenPartySummary</class>
<class>com.hack23.cia.model.internal.application.data.party.impl.ViewRiksdagenPartyLongitudinalPerformance</class>
<class>com.hack23.cia.model.internal.application.data.party.impl.ViewRiksdagenPartyCoalitionEvolution</class>
<class>com.hack23.cia.model.internal.application.data.party.impl.ViewRiksdagenPartyElectoralTrends</class>
```

## Reconstruction Requirements

### 1. view_riksdagen_party_summary (‚úÖ COMPLETED)

**Complexity**: Medium  
**Status**: Recreated in db-changelog-1.61.xml  
**Source**: Aggregates from `view_riksdagen_politician` and `document_data`  

**Metrics**:
- Assignment aggregations (total/current, dates, days served)
- Active member counts (by role: parliament, government, committee, EU, speaker, party)
- Document statistics (total, by type, collaboration patterns)
- Member activity classification (very high, high, medium, low activity)
- Focus area classification (party-focused, committee-focused, individual-focused)

**Primary Key**: `party` (String)

### 2. view_riksdagen_party_longitudinal_performance (‚ö†Ô∏è TODO)

**Complexity**: Very High (70 columns, advanced window functions)  
**Status**: Placeholder only  
**Source**: `view_riksdagen_vote_data_ballot_party_summary_annual` (materialized view)

**Requirements**:
- Swedish parliament semester structure (September 1 - January 25 = autumn, January 26 - August 31 = spring)
- Election cycle calculations (2002-2005, 2006-2009, 2010-2013, 2014-2017, 2018-2021, 2022-2025, 2026-2029)
- Window functions for each semester-party combination:
  - `RANK()` - Rank by win_rate, participation, size, approval, productivity, discipline
  - `PERCENT_RANK()` - Percentile calculations for win_rate, participation, approval, productivity
  - `NTILE(4)` - Quartile assignments for win_rate and overall performance
  - `LAG()` - Previous semester values for win_rate, participation, members, approval, documents, rebel_rate
  - `LEAD()` - Next semester projections for win_rate, participation, members
  - `STDDEV_POP()` - Sector and party-level volatility metrics
- 3-semester moving averages (win_rate, participation)
- Z-score calculations for momentum indicators
- Performance classifications:
  - Volatility (STABLE, MODERATE, VOLATILE, HIGHLY_VOLATILE)
  - Stability (CONSISTENT, FLUCTUATING, ERRATIC)
  - Trajectory (IMPROVING, DECLINING, STABLE)
  - Forecast trends (POSITIVE, NEGATIVE, NEUTRAL)
  - Performance tiers (ELITE, HIGH, MEDIUM, LOW)
  - Early warning flags

**Primary Key**: Composite `(party, election_cycle_id, semester)`

**Embedded ID Class**: `ViewRiksdagenPartyLongitudinalPerformanceEmbeddedId`
- `party` (String)
- `election_cycle_id` (String, format: "2022-2025")
- `semester` (String, "AUTUMN" or "SPRING")

### 3. view_riksdagen_party_coalition_evolution (‚ö†Ô∏è TODO)

**Complexity**: High (35 columns, party-pair analysis)  
**Status**: Placeholder only  
**Source**: Ballot voting data, aggregated by party pairs

**Requirements**:
- Party-pair combinations (all possible pairs from active parties)
- Voting alignment analysis:
  - Joint ballots (where both parties participated)
  - Aligned ballots (where both voted the same way)
  - Alignment rate calculation
  - Vote divergence metrics
- Window functions for party-pair trends:
  - `RANK()` by alignment, activity, consistency
  - `PERCENT_RANK()` for alignment and cohesion
  - `NTILE(4)` for coalition strength quartiles
  - `LAG()` for previous semester alignment, joint_ballots, divergence
  - `LEAD()` for next semester projections
  - `STDDEV_POP()` for sector-level and pair-level volatility
- 3-semester moving average (alignment)
- Coalition classifications:
  - Strength (STRONG, MODERATE, WEAK, ADVERSARIAL)
  - Trend (STRENGTHENING, WEAKENING, STABLE)
  - Strategic shift detection (MAJOR_SHIFT, MINOR_SHIFT, STABLE)
  - Consistency (CONSISTENT, VARIABLE, ERRATIC)
- Predictive metrics:
  - Momentum z-score
  - Stability score
  - Breakup risk score
  - Realignment probability (HIGH, MEDIUM, LOW)
  - Coalition density score
  - Bridge classification (STRONG_BRIDGE, WEAK_BRIDGE, NO_BRIDGE)

**Primary Key**: Composite `(party1, party2, election_cycle_id, semester)`

**Embedded ID Class**: `ViewRiksdagenPartyCoalitionEvolutionEmbeddedId`
- `party1` (String)
- `party2` (String)
- `election_cycle_id` (String)
- `semester` (String)

### 4. view_riksdagen_party_electoral_trends (‚ö†Ô∏è TODO)

**Complexity**: High (49 columns, seat proxies, forecasting)  
**Status**: Placeholder only  
**Source**: Ballot data, member counts, document production

**Requirements**:
- Seat count proxy algorithm (since actual seat counts not available in vote_data):
  - Option 1: Count of active members voting in parliament ballots
  - Option 2: Weighted by participation rate and ballot presence
  - Option 3: Use current_assignments from view_riksdagen_party_summary
- Electoral performance metrics:
  - Ballots participated, win_rate, yes_rate, approval_rate, participation_rate
  - Documents produced, avg_rebel_rate
- Window functions:
  - `RANK()` by seats, win_rate, productivity, engagement, effectiveness
  - `PERCENT_RANK()` for seats, win_rate, productivity
  - `NTILE(4)` for size and performance quartiles
  - `LAG()` for previous semester seats, win_rate, documents, participation
  - `LEAD()` for next semester projections (seats, win_rate)
  - `STDDEV_POP()` for sector and party volatility
- 3-semester moving averages (seats, win_rate)
- Electoral classifications:
  - Trend (GAINING, LOSING, STABLE)
  - Size category (MAJOR, MEDIUM, MINOR, MICRO)
  - Volatility (STABLE, MODERATE, VOLATILE)
  - Forecast (GROWTH, DECLINE, STABLE)
  - Electoral tier (TIER_1, TIER_2, TIER_3, TIER_4)
- Composite scores:
  - Electoral score (weighted: seats, win_rate, participation)
  - Legislative effectiveness index
  - Election readiness score
  - Projected seat change
- Warning flags:
  - Electoral warning (HIGH_RISK, MODERATE_RISK, LOW_RISK, STABLE)
- Period flags:
  - is_pre_election_period (spring before election autumn)
  - is_election_period (election year autumn)
  - is_post_election_period (spring after election)

**Primary Key**: Composite `(party, election_cycle_id, semester)`

**Embedded ID Class**: `ViewRiksdagenPartyElectoralTrendsEmbeddedId`
- `party` (String)
- `election_cycle_id` (String)
- `semester` (String)

## Reconstruction Approach

### Phase 1: Foundation (‚úÖ COMPLETED in v1.61)

1. ‚úÖ Create db-changelog-1.61.xml
2. ‚úÖ Recreate `view_riksdagen_party_summary` (52 columns)
3. ‚úÖ Add validation changeset
4. ‚úÖ Include in main db-changelog.xml

### Phase 2: Complex Views (‚ö†Ô∏è REQUIRES DEDICATED EFFORT)

**Option A: Manual SQL Reconstruction**
- Estimated effort: 8-12 hours per view
- Skills required: Advanced PostgreSQL (window functions, CTEs, statistical calculations)
- Risk: High (complex logic, edge cases, semester boundaries)

**Option B: Use Intelligence-Operative Agent**
- Delegate to `intelligence-operative` custom agent
- Provide JPA entity structure and requirements
- Agent has expertise in political analysis and SQL
- Estimated effort: 2-4 hours per view (supervised)

**Option C: Incremental Recreation**
- Implement simplified versions first (core metrics only)
- Add advanced features incrementally
- Test after each addition
- Estimated effort: 4-6 hours per view

### Phase 3: Testing and Validation

For each recreated view:
1. PostgreSQL syntax validation
2. Liquibase changelog validation (`mvn liquibase:validate`)
3. Query execution plan analysis (`EXPLAIN`)
4. JPA entity mapping verification
5. Application startup testing (`ant start`)
6. Data quality spot checks
7. Update full_schema.sql
8. Generate validation report

## Dependencies

All views require these existing database objects:

**Tables**:
- `vote_data` - Ballot voting records
- `document_data` - Document production records
- `assignment_data` - Politician assignments
- `sweden_political_party` - Party master data
- `person_data` - Politician master data

**Views** (must exist first):
- `view_riksdagen_party_member` - Party membership aggregation
- `view_riksdagen_politician` - Politician-level aggregation
- `view_riksdagen_vote_data_ballot_party_summary_annual` - Materialized view with annual party voting summary

**Indexes** (recommended for performance):
- `idx_vote_data_date` - ON vote_data(ballot_date)
- `idx_vote_data_party` - ON vote_data(party)
- `idx_document_data_party_date` - ON document_data(party, made_public_date)

## Testing Strategy

### Unit Testing

For each view, create test queries in:
`service.data.impl/sample-data/framework-validation/temporal/test_1_61_party_longitudinal.csv`

Test scenarios:
1. Empty data (no votes/documents) - should return empty result
2. Single party, single semester - verify calculations
3. Multiple parties, multiple semesters - verify window function rankings
4. Edge cases: party with zero votes, missing semesters, election year transitions

### Integration Testing

1. Add view queries to application layer
2. Test through JPA entity manager
3. Verify no ClassNotFoundException or relation not found errors
4. Check query performance (should complete in < 5 seconds)

### Validation Queries

```sql
-- Verify party_summary exists with correct column count
SELECT COUNT(*) AS column_count 
FROM information_schema.columns 
WHERE table_name = 'view_riksdagen_party_summary';
-- Expected: 52

-- Verify party_summary returns data
SELECT party, total_assignments, total_documents 
FROM view_riksdagen_party_summary 
ORDER BY party 
LIMIT 5;

-- Check for NULL issues
SELECT party FROM view_riksdagen_party_summary 
WHERE total_assignments IS NULL OR party IS NULL;
-- Expected: 0 rows
```

## Recommendations

### Immediate Actions (Critical)

1. **‚úÖ COMPLETED**: Recreate `view_riksdagen_party_summary` (foundational view)
2. **IN PROGRESS**: Test party_summary through PostgreSQL and JPA
3. **NEXT**: Update full_schema.sql with party_summary

### Short-term Actions (High Priority)

4. **Delegate to intelligence-operative agent**: Reconstruct the 3 complex views
   - Provide this document as context
   - Provide JPA entity Java files
   - Request SQL generation with validation
5. **Test each view** incrementally as recreated
6. **Update documentation** in DATABASE_VIEW_INTELLIGENCE_CATALOG.md

### Long-term Actions (Medium Priority)

7. **Add automated testing** for view existence in CI/CD
8. **Create view dependency graph** to prevent future regressions
9. **Document view recreation procedures** in README-SCHEMA-MAINTENANCE.md
10. **Consider materialized views** for complex party longitudinal calculations (performance optimization)

## Conclusion

This regression affects 4 critical party analysis views, causing application failures when party longitudinal performance, coalition evolution, and electoral trends are queried. 

**Current Status (v1.61)**:
- ‚úÖ 1 of 4 views recreated (`view_riksdagen_party_summary`)
- ‚ö†Ô∏è 3 of 4 views require complex SQL reconstruction
- üìä Total: 154 columns across 3 remaining views

**Recommended Next Steps**:
1. Test and validate party_summary
2. Use intelligence-operative agent or dedicated SQL developer to reconstruct the 3 complex views
3. Full validation and testing cycle
4. Update all documentation and schema exports

**Estimated Effort**: 12-20 hours for complete resolution (all 4 views + testing + documentation)

---

**Document Version**: 1.0  
**Created**: 2026-01-19  
**Author**: Copilot  
**Related**: db-changelog-1.61.xml, issue #8224 (election year analysis)  
