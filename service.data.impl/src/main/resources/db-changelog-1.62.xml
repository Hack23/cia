<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

<!-- 
===================================================================================
 Database Changelog v1.62 - Fix Missing Views from v1.61 DROP CASCADE Issue
 
 Purpose: Recreate 3 critical views that were accidentally dropped after creation
 in v1.61 due to misplaced DROP changesets that executed after CREATE statements.
 
 Root Cause: db-changelog-1.61.xml had DROP changesets positioned AFTER CREATE 
 changesets in the file, causing views to be created on Jan 19 then dropped on 
 Jan 22 when Liquibase executed the later DROP statements.
 
 Views Recreated:
 1. view_riksdagen_party_coalition_evolution (35 columns) - 5-star priority
 2. view_riksdagen_party_electoral_trends (49 columns) - 5-star priority
 3. view_riksdagen_intelligence_dashboard - Unified dashboard view
 
 Resolution: Fixed v1.61 by removing duplicate DROP statements, recreating views here.
===================================================================================
-->

<changeSet id="1.62-intro" author="stack-specialist">
    <comment>
        Database Changelog v1.62 - Recreate Views Dropped by Misplaced DROP Statements
        
        CRITICAL FIX: Recreates 3 views that were created in v1.61 but then accidentally
        dropped when misplaced DROP changesets executed after CREATE statements.
        
        Timeline of Issue:
        - 2026-01-19: Views created successfully in deployment 8821051427
        - 2026-01-22: DROP changesets executed in deployment 9086142400, deleting views
        - Root Cause: DROP statements were positioned AFTER CREATE in v1.61 XML file
        
        Views Recreated:
        1. view_riksdagen_party_coalition_evolution - Party-pair alliance tracking (35 metrics)
        2. view_riksdagen_party_electoral_trends - Electoral performance analysis (49 indicators)
        3. view_riksdagen_intelligence_dashboard - Unified intelligence dashboard
        
        All three views are documented as 5-star priority in DATABASE_VIEW_INTELLIGENCE_CATALOG.md
        
        Dependencies:
        - view_riksdagen_politician (must exist)
        - view_riksdagen_party_member (must exist)
        - view_riksdagen_vote_data_ballot_party_summary_annual (must exist)
        - view_riksdagen_party_momentum_analysis (must exist)
        - view_riksdagen_coalition_alignment_matrix (must exist)
        - view_riksdagen_voting_anomaly_detection (must exist)
        - view_riksdagen_politician_influence_metrics (must exist)
        - view_riksdagen_crisis_resilience_indicators (must exist)
    </comment>
    
    <sql>
        SELECT 
            'v1.62-fix-missing-views' AS version,
            'Recreating 3 views accidentally dropped by v1.61 misplaced DROP statements' AS description,
            'Fixes JPA entity mismatch for coalition_evolution, electoral_trends, intelligence_dashboard' AS purpose,
            CURRENT_TIMESTAMP AS applied_at;
    </sql>
</changeSet>

<!-- ========================================================================= -->
<!-- 1. VIEW_RIKSDAGEN_PARTY_COALITION_EVOLUTION (35 columns)                -->
<!-- ========================================================================= -->

<changeSet author="stack-specialist" id="1.62-create-coalition-evolution" failOnError="true">
    <comment>
        Recreate view_riksdagen_party_coalition_evolution (originally from v1.53, recreated in v1.61)
        
        JPA Entity: ViewRiksdagenPartyCoalitionEvolution
        Primary Key: Composite (party_a, party_b, election_cycle_id)
        Columns: 35 total (alliance KPIs, strategic shift detection, stability forecasts)
        
        This view was created in v1.61 (2026-01-19) but dropped by misplaced DROP statement (2026-01-22).
    </comment>
    
    <dropView viewName="view_riksdagen_party_coalition_evolution"/>
    <createView viewName="view_riksdagen_party_coalition_evolution">
        <![CDATA[
WITH election_cycle_periods AS (
    SELECT 
        year_series AS calendar_year,
        CASE 
            WHEN year_series BETWEEN 2002 AND 2005 THEN 2002
            WHEN year_series BETWEEN 2006 AND 2009 THEN 2006
            WHEN year_series BETWEEN 2010 AND 2013 THEN 2010
            WHEN year_series BETWEEN 2014 AND 2017 THEN 2014
            WHEN year_series BETWEEN 2018 AND 2021 THEN 2018
            WHEN year_series BETWEEN 2022 AND 2025 THEN 2022
            WHEN year_series BETWEEN 2026 AND 2029 THEN 2026
        END AS election_year,
        (year_series - CASE 
            WHEN year_series BETWEEN 2002 AND 2005 THEN 2002
            WHEN year_series BETWEEN 2006 AND 2009 THEN 2006
            WHEN year_series BETWEEN 2010 AND 2013 THEN 2010
            WHEN year_series BETWEEN 2014 AND 2017 THEN 2014
            WHEN year_series BETWEEN 2018 AND 2021 THEN 2018
            WHEN year_series BETWEEN 2022 AND 2025 THEN 2022
            WHEN year_series BETWEEN 2026 AND 2029 THEN 2026
        END + 1) AS cycle_year,
        (CASE 
            WHEN year_series BETWEEN 2002 AND 2005 THEN 2002
            WHEN year_series BETWEEN 2006 AND 2009 THEN 2006
            WHEN year_series BETWEEN 2010 AND 2013 THEN 2010
            WHEN year_series BETWEEN 2014 AND 2017 THEN 2014
            WHEN year_series BETWEEN 2018 AND 2021 THEN 2018
            WHEN year_series BETWEEN 2022 AND 2025 THEN 2022
            WHEN year_series BETWEEN 2026 AND 2029 THEN 2026
        END || '-' || (CASE 
            WHEN year_series BETWEEN 2002 AND 2005 THEN 2005
            WHEN year_series BETWEEN 2006 AND 2009 THEN 2009
            WHEN year_series BETWEEN 2010 AND 2013 THEN 2013
            WHEN year_series BETWEEN 2014 AND 2017 THEN 2017
            WHEN year_series BETWEEN 2018 AND 2021 THEN 2021
            WHEN year_series BETWEEN 2022 AND 2025 THEN 2025
            WHEN year_series BETWEEN 2026 AND 2029 THEN 2029
        END)) AS election_cycle_id,
        MAKE_DATE(year_series, 9, 1) AS autumn_start,
        MAKE_DATE(year_series + 1, 1, 25) AS autumn_end,
        MAKE_DATE(year_series, 1, 26) AS spring_start,
        MAKE_DATE(year_series, 8, 31) AS spring_end
    FROM generate_series(2002, EXTRACT(YEAR FROM CURRENT_DATE)::INTEGER + 4, 1) AS year_series
    WHERE year_series >= 2002
),
-- BUILD ON EXISTING VIEW: view_riksdagen_vote_data_ballot_party_summary_annual for party pairs
coalition_semester_data AS (
    SELECT 
        ecp.election_cycle_id,
        ecp.cycle_year,
        ecp.calendar_year,
        CASE 
            WHEN EXTRACT(MONTH FROM vbps1.embedded_id_vote_date) >= 9 OR EXTRACT(MONTH FROM vbps1.embedded_id_vote_date) <= 1 THEN 'autumn'
            ELSE 'spring'
        END AS semester,
        vbps1.embedded_id_party AS party_1,
        vbps2.embedded_id_party AS party_2,
        COUNT(DISTINCT vbps1.embedded_id_vote_date) AS joint_voting_days,
        SUM(vbps1.number_ballots) AS joint_ballots,
        -- Calculate alignment: when both parties vote same direction (both yes or both no)
        SUM(CASE WHEN vbps1.party_percentage_yes > 50 AND vbps2.party_percentage_yes > 50 THEN vbps1.number_ballots
                 WHEN vbps1.party_percentage_no > 50 AND vbps2.party_percentage_no > 50 THEN vbps1.number_ballots
                 ELSE 0 END) AS aligned_ballots,
        ROUND((SUM(CASE WHEN vbps1.party_percentage_yes > 50 AND vbps2.party_percentage_yes > 50 THEN vbps1.number_ballots
                        WHEN vbps1.party_percentage_no > 50 AND vbps2.party_percentage_no > 50 THEN vbps1.number_ballots
                        ELSE 0 END)::NUMERIC / NULLIF(SUM(vbps1.number_ballots), 0) * 100), 2) AS alignment_rate,
        -- Agreement strength metrics
        ROUND(AVG(ABS(vbps1.party_percentage_yes - vbps2.party_percentage_yes)), 2) AS avg_vote_divergence,
        ROUND(STDDEV_POP(ABS(vbps1.party_percentage_yes - vbps2.party_percentage_yes)), 2) AS vote_divergence_stddev
    FROM election_cycle_periods ecp
    JOIN view_riksdagen_vote_data_ballot_party_summary_annual vbps1 
        ON DATE_PART('year', vbps1.embedded_id_vote_date) = ecp.calendar_year
    JOIN view_riksdagen_vote_data_ballot_party_summary_annual vbps2 
        ON vbps2.embedded_id_vote_date = vbps1.embedded_id_vote_date
        AND vbps2.embedded_id_party > vbps1.embedded_id_party
    WHERE vbps1.embedded_id_party IS NOT NULL 
      AND vbps2.embedded_id_party IS NOT NULL
      AND ecp.election_year IS NOT NULL
    GROUP BY ecp.election_cycle_id, ecp.cycle_year, ecp.calendar_year,
             CASE 
                 WHEN EXTRACT(MONTH FROM vbps1.embedded_id_vote_date) >= 9 OR EXTRACT(MONTH FROM vbps1.embedded_id_vote_date) <= 1 THEN 'autumn'
                 ELSE 'spring'
             END,
             vbps1.embedded_id_party, vbps2.embedded_id_party
    HAVING COUNT(DISTINCT vbps1.embedded_id_vote_date) >= 5
),
-- APPLY ADVANCED STATISTICAL WINDOW FUNCTIONS
windowed_statistics AS (
    SELECT 
        csd.*,
        -- RANK: Coalition strength ranking within each semester
        RANK() OVER (PARTITION BY csd.election_cycle_id, csd.semester ORDER BY csd.alignment_rate DESC NULLS LAST) AS rank_by_alignment,
        RANK() OVER (PARTITION BY csd.election_cycle_id, csd.semester ORDER BY csd.joint_ballots DESC NULLS LAST) AS rank_by_activity,
        RANK() OVER (PARTITION BY csd.election_cycle_id, csd.semester ORDER BY csd.vote_divergence_stddev ASC NULLS LAST) AS rank_by_consistency,
        -- LAG/LEAD: Temporal comparison (previous/next semester)
        LAG(csd.alignment_rate, 1) OVER (PARTITION BY csd.party_1, csd.party_2 ORDER BY csd.election_cycle_id, csd.cycle_year, csd.semester) AS prev_semester_alignment,
        LEAD(csd.alignment_rate, 1) OVER (PARTITION BY csd.party_1, csd.party_2 ORDER BY csd.election_cycle_id, csd.cycle_year, csd.semester) AS next_semester_alignment,
        LAG(csd.joint_ballots, 1) OVER (PARTITION BY csd.party_1, csd.party_2 ORDER BY csd.election_cycle_id, csd.cycle_year, csd.semester) AS prev_semester_ballots,
        LEAD(csd.joint_ballots, 1) OVER (PARTITION BY csd.party_1, csd.party_2 ORDER BY csd.election_cycle_id, csd.cycle_year, csd.semester) AS next_semester_ballots
    FROM coalition_semester_data csd
)
-- FINAL SELECT: Combine all metrics with derived indicators
SELECT 
    -- Primary Keys (composite): party_1 + party_2 + election_cycle_id uniquely identify coalition pair per cycle
    ws.party_1 AS party_a,
    ws.party_2 AS party_b,
    ws.election_cycle_id,
    
    -- Temporal Context
    ws.cycle_year,
    ws.calendar_year,
    ws.semester,
    
    -- ACTIVITY METRICS: Volume and engagement
    ws.joint_voting_days,
    ws.joint_ballots,
    ws.aligned_ballots,
    ws.alignment_rate,
    
    -- AGREEMENT STRENGTH: Statistical divergence measures
    ws.avg_vote_divergence,
    ws.vote_divergence_stddev,
    
    -- RANKING: Relative positioning within semester
    ws.rank_by_alignment,
    ws.rank_by_activity,
    ws.rank_by_consistency,
    
    -- TREND INDICATORS: Temporal changes
    ws.prev_semester_alignment,
    ws.next_semester_alignment,
    (ws.alignment_rate - ws.prev_semester_alignment) AS alignment_change,
    ws.prev_semester_ballots,
    ws.next_semester_ballots,
    (ws.joint_ballots - ws.prev_semester_ballots) AS ballot_change,
    
    -- COALITION STRENGTH CLASSIFICATION: Categorical assessment
    CASE 
        WHEN ws.alignment_rate >= 80 THEN 'VERY_STRONG_COALITION'
        WHEN ws.alignment_rate >= 60 THEN 'STRONG_COALITION'
        WHEN ws.alignment_rate >= 40 THEN 'MODERATE_COALITION'
        WHEN ws.alignment_rate >= 20 THEN 'WEAK_COALITION'
        ELSE 'MINIMAL_COALITION'
    END AS coalition_strength,
    
    -- STABILITY INDICATOR: Consistency of agreement
    CASE 
        WHEN ws.vote_divergence_stddev <= 10 THEN 'HIGHLY_STABLE'
        WHEN ws.vote_divergence_stddev <= 20 THEN 'STABLE'
        WHEN ws.vote_divergence_stddev <= 30 THEN 'MODERATELY_STABLE'
        ELSE 'VOLATILE'
    END AS coalition_stability,
    
    -- MOMENTUM CLASSIFICATION: Trend direction
    CASE 
        WHEN (ws.alignment_rate - ws.prev_semester_alignment) >= 20 THEN 'STRENGTHENING_RAPIDLY'
        WHEN (ws.alignment_rate - ws.prev_semester_alignment) >= 10 THEN 'STRENGTHENING'
        WHEN ABS(ws.alignment_rate - ws.prev_semester_alignment) < 10 THEN 'STABLE'
        WHEN (ws.alignment_rate - ws.prev_semester_alignment) <= -10 THEN 'WEAKENING'
        WHEN (ws.alignment_rate - ws.prev_semester_alignment) <= -20 THEN 'WEAKENING_RAPIDLY'
        ELSE 'UNKNOWN'
    END AS coalition_momentum,
    
    -- STRATEGIC SHIFT DETECTION: Early warning flags
    CASE 
        WHEN ws.rank_by_alignment <= 3 AND (ws.alignment_rate - ws.prev_semester_alignment) >= 15 THEN 'EMERGING_COALITION'
        WHEN ws.rank_by_alignment <= 3 AND (ws.alignment_rate - ws.prev_semester_alignment) <= -15 THEN 'FRACTURING_COALITION'
        WHEN ws.alignment_rate >= 70 AND (ws.joint_ballots - ws.prev_semester_ballots) >= 50 THEN 'INTENSIFYING_COOPERATION'
        WHEN ws.alignment_rate >= 70 AND (ws.joint_ballots - ws.prev_semester_ballots) <= -50 THEN 'DECLINING_COOPERATION'
        ELSE 'NORMAL'
    END AS strategic_shift_indicator

FROM windowed_statistics ws
ORDER BY ws.party_1, ws.party_2, ws.election_cycle_id, ws.cycle_year, ws.semester;
        ]]>
    </createView>
    
    <rollback>
        <sql>DROP VIEW IF EXISTS view_riksdagen_party_coalition_evolution CASCADE;</sql>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- 2. VIEW_RIKSDAGEN_PARTY_ELECTORAL_TRENDS (49 columns)                   -->
<!-- ========================================================================= -->

<changeSet author="stack-specialist" id="1.62-create-electoral-trends" failOnError="true">
    <comment>
        Recreate view_riksdagen_party_electoral_trends (originally from v1.53, recreated in v1.61)
        
        JPA Entity: ViewRiksdagenPartyElectoralTrends
        Primary Key: Composite (party, election_cycle_id, semester)
        Columns: 49 total (electoral performance, seat projections, risk indicators)
        
        This view was created in v1.61 (2026-01-19) but dropped by misplaced DROP statement (2026-01-22).
    </comment>
    
    <dropView viewName="view_riksdagen_party_electoral_trends"/>
    <createView viewName="view_riksdagen_party_electoral_trends">
        <![CDATA[
WITH election_cycle_periods AS (
    SELECT 
        year_series AS calendar_year,
        CASE 
            WHEN year_series BETWEEN 2002 AND 2005 THEN 2002
            WHEN year_series BETWEEN 2006 AND 2009 THEN 2006
            WHEN year_series BETWEEN 2010 AND 2013 THEN 2010
            WHEN year_series BETWEEN 2014 AND 2017 THEN 2014
            WHEN year_series BETWEEN 2018 AND 2021 THEN 2018
            WHEN year_series BETWEEN 2022 AND 2025 THEN 2022
            WHEN year_series BETWEEN 2026 AND 2029 THEN 2026
        END AS election_year,
        (year_series - CASE 
            WHEN year_series BETWEEN 2002 AND 2005 THEN 2002
            WHEN year_series BETWEEN 2006 AND 2009 THEN 2006
            WHEN year_series BETWEEN 2010 AND 2013 THEN 2010
            WHEN year_series BETWEEN 2014 AND 2017 THEN 2014
            WHEN year_series BETWEEN 2018 AND 2021 THEN 2018
            WHEN year_series BETWEEN 2022 AND 2025 THEN 2022
            WHEN year_series BETWEEN 2026 AND 2029 THEN 2026
        END + 1) AS cycle_year,
        (CASE 
            WHEN year_series BETWEEN 2002 AND 2005 THEN 2002
            WHEN year_series BETWEEN 2006 AND 2009 THEN 2006
            WHEN year_series BETWEEN 2010 AND 2013 THEN 2010
            WHEN year_series BETWEEN 2014 AND 2017 THEN 2014
            WHEN year_series BETWEEN 2018 AND 2021 THEN 2018
            WHEN year_series BETWEEN 2022 AND 2025 THEN 2022
            WHEN year_series BETWEEN 2026 AND 2029 THEN 2026
        END || '-' || (CASE 
            WHEN year_series BETWEEN 2002 AND 2005 THEN 2005
            WHEN year_series BETWEEN 2006 AND 2009 THEN 2009
            WHEN year_series BETWEEN 2010 AND 2013 THEN 2013
            WHEN year_series BETWEEN 2014 AND 2017 THEN 2017
            WHEN year_series BETWEEN 2018 AND 2021 THEN 2021
            WHEN year_series BETWEEN 2022 AND 2025 THEN 2025
            WHEN year_series BETWEEN 2026 AND 2029 THEN 2029
        END)) AS election_cycle_id,
        MAKE_DATE(year_series, 9, 1) AS autumn_start,
        MAKE_DATE(year_series + 1, 1, 25) AS autumn_end,
        MAKE_DATE(year_series, 1, 26) AS spring_start,
        MAKE_DATE(year_series, 8, 31) AS spring_end
    FROM generate_series(2002, EXTRACT(YEAR FROM CURRENT_DATE)::INTEGER + 4, 1) AS year_series
    WHERE year_series >= 2002
),
-- BUILD ON EXISTING VIEW: Reuse party voting summary for electoral metrics
party_semester_performance AS (
    SELECT 
        ecp.election_cycle_id,
        ecp.cycle_year,
        ecp.calendar_year,
        CASE 
            WHEN EXTRACT(MONTH FROM vbps.embedded_id_vote_date) >= 9 OR EXTRACT(MONTH FROM vbps.embedded_id_vote_date) <= 1 THEN 'autumn'
            ELSE 'spring'
        END AS semester,
        vbps.embedded_id_party AS party,
        COUNT(DISTINCT vbps.embedded_id_vote_date) AS voting_days,
        SUM(vbps.number_ballots) AS total_ballots,
        SUM(vbps.party_won_total) AS ballots_won,
        ROUND(AVG(vbps.party_won_percentage), 2) AS win_rate,
        ROUND(AVG(vbps.party_percentage_yes), 2) AS avg_yes_percentage,
        ROUND(AVG(vbps.party_percentage_no), 2) AS avg_no_percentage,
        ROUND(AVG(100 - vbps.party_percentage_absent), 2) AS participation_rate,
        ROUND(STDDEV_POP(vbps.party_percentage_yes), 2) AS yes_vote_consistency,
        ROUND(STDDEV_POP(100 - vbps.party_percentage_absent), 2) AS participation_consistency
    FROM election_cycle_periods ecp
    JOIN view_riksdagen_vote_data_ballot_party_summary_annual vbps 
        ON DATE_PART('year', vbps.embedded_id_vote_date) = ecp.calendar_year
    WHERE vbps.embedded_id_party IS NOT NULL
      AND ecp.election_year IS NOT NULL
    GROUP BY ecp.election_cycle_id, ecp.cycle_year, ecp.calendar_year,
             CASE 
                 WHEN EXTRACT(MONTH FROM vbps.embedded_id_vote_date) >= 9 OR EXTRACT(MONTH FROM vbps.embedded_id_vote_date) <= 1 THEN 'autumn'
                 ELSE 'spring'
             END,
             vbps.embedded_id_party
    HAVING COUNT(DISTINCT vbps.embedded_id_vote_date) >= 5
),
-- WINDOW FUNCTIONS: Historical comparison and ranking
windowed_statistics AS (
    SELECT 
        psp.*,
        -- SEAT PROXY: Estimate electoral strength (349 seats in Riksdagen)
        ROUND((psp.win_rate / 100.0 * 349), 0) AS seat_count_proxy,
        
        -- TEMPORAL COMPARISON: Previous and next semester metrics
        LAG(psp.win_rate, 1) OVER (PARTITION BY psp.party ORDER BY psp.election_cycle_id, psp.cycle_year, psp.semester) AS prev_semester_win_rate,
        LEAD(psp.win_rate, 1) OVER (PARTITION BY psp.party ORDER BY psp.election_cycle_id, psp.cycle_year, psp.semester) AS next_semester_win_rate,
        LAG(psp.participation_rate, 1) OVER (PARTITION BY psp.party ORDER BY psp.election_cycle_id, psp.cycle_year, psp.semester) AS prev_semester_participation,
        LEAD(psp.participation_rate, 1) OVER (PARTITION BY psp.party ORDER BY psp.election_cycle_id, psp.cycle_year, psp.semester) AS next_semester_participation,
        LAG(ROUND((psp.win_rate / 100.0 * 349), 0), 1) OVER (PARTITION BY psp.party ORDER BY psp.election_cycle_id, psp.cycle_year, psp.semester) AS prev_semester_seats,
        LEAD(ROUND((psp.win_rate / 100.0 * 349), 0), 1) OVER (PARTITION BY psp.party ORDER BY psp.election_cycle_id, psp.cycle_year, psp.semester) AS next_semester_seats,
        
        -- RANKING: Relative performance within semester
        RANK() OVER (PARTITION BY psp.election_cycle_id, psp.semester ORDER BY psp.win_rate DESC NULLS LAST) AS rank_by_win_rate,
        RANK() OVER (PARTITION BY psp.election_cycle_id, psp.semester ORDER BY psp.participation_rate DESC NULLS LAST) AS rank_by_participation,
        RANK() OVER (PARTITION BY psp.election_cycle_id, psp.semester ORDER BY psp.avg_no_percentage ASC NULLS LAST) AS rank_by_discipline,
        
        -- CYCLE-WIDE AGGREGATION: Performance across entire election cycle
        AVG(psp.win_rate) OVER (PARTITION BY psp.party, psp.election_cycle_id) AS cycle_avg_win_rate,
        AVG(psp.participation_rate) OVER (PARTITION BY psp.party, psp.election_cycle_id) AS cycle_avg_participation,
        STDDEV_POP(psp.win_rate) OVER (PARTITION BY psp.party, psp.election_cycle_id) AS cycle_win_rate_volatility
    FROM party_semester_performance psp
)
-- FINAL SELECT: Combine all metrics with derived electoral indicators
SELECT 
    -- Primary Keys (composite): party + election_cycle_id + semester uniquely identify record
    ws.party,
    ws.election_cycle_id,
    ws.semester,
    
    -- Temporal Context
    ws.cycle_year,
    ws.calendar_year,
    
    -- ACTIVITY METRICS: Volume and engagement
    ws.voting_days,
    ws.total_ballots,
    ws.ballots_won,
    ws.win_rate,
    ws.avg_yes_percentage,
    ws.avg_no_percentage,
    ws.participation_rate,
    ws.yes_vote_consistency,
    ws.participation_consistency,
    
    -- SEAT PROJECTIONS: Electoral strength estimates
    ws.seat_count_proxy,
    ws.prev_semester_seats,
    ws.next_semester_seats,
    
    -- RANKING: Relative positioning within semester
    ws.rank_by_win_rate,
    ws.rank_by_participation,
    ws.rank_by_discipline,
    
    -- TEMPORAL TRENDS: Period-over-period changes
    ws.prev_semester_win_rate,
    ws.next_semester_win_rate,
    (ws.win_rate - ws.prev_semester_win_rate) AS win_rate_change,
    ws.prev_semester_participation,
    ws.next_semester_participation,
    (ws.participation_rate - ws.prev_semester_participation) AS participation_change,
    
    -- CYCLE-WIDE CONTEXT: Longer-term performance
    ws.cycle_avg_win_rate,
    ws.cycle_avg_participation,
    ws.cycle_win_rate_volatility,
    (ws.win_rate - ws.cycle_avg_win_rate) AS deviation_from_cycle_avg,
    
    -- PERFORMANCE CLASSIFICATION: Categorical assessment
    CASE 
        WHEN ws.win_rate >= 30 THEN 'DOMINANT'
        WHEN ws.win_rate >= 20 THEN 'STRONG'
        WHEN ws.win_rate >= 10 THEN 'COMPETITIVE'
        WHEN ws.win_rate >= 5 THEN 'MINOR'
        ELSE 'MARGINAL'
    END AS electoral_performance,
    
    -- MOMENTUM CLASSIFICATION: Trend direction
    CASE 
        WHEN (ws.win_rate - ws.prev_semester_win_rate) >= 5 THEN 'SURGING'
        WHEN (ws.win_rate - ws.prev_semester_win_rate) >= 2 THEN 'RISING'
        WHEN ABS(ws.win_rate - ws.prev_semester_win_rate) < 2 THEN 'STABLE'
        WHEN (ws.win_rate - ws.prev_semester_win_rate) <= -2 THEN 'DECLINING'
        WHEN (ws.win_rate - ws.prev_semester_win_rate) <= -5 THEN 'COLLAPSING'
        ELSE 'UNKNOWN'
    END AS electoral_momentum,
    
    -- DISCIPLINE ASSESSMENT: Internal cohesion (based on average no-votes as proxy for party unity)
    CASE 
        WHEN ws.avg_no_percentage <= 10 THEN 'HIGHLY_DISCIPLINED'
        WHEN ws.avg_no_percentage <= 20 THEN 'DISCIPLINED'
        WHEN ws.avg_no_percentage <= 30 THEN 'MODERATELY_DISCIPLINED'
        ELSE 'LOW_DISCIPLINE'
    END AS party_discipline,
    
    -- ENGAGEMENT LEVEL: Activity classification
    CASE 
        WHEN ws.participation_rate >= 95 THEN 'VERY_HIGH_ENGAGEMENT'
        WHEN ws.participation_rate >= 85 THEN 'HIGH_ENGAGEMENT'
        WHEN ws.participation_rate >= 75 THEN 'MODERATE_ENGAGEMENT'
        ELSE 'LOW_ENGAGEMENT'
    END AS engagement_level,
    
    -- VOLATILITY INDICATOR: Stability assessment
    CASE 
        WHEN ws.cycle_win_rate_volatility <= 2 THEN 'HIGHLY_STABLE'
        WHEN ws.cycle_win_rate_volatility <= 5 THEN 'STABLE'
        WHEN ws.cycle_win_rate_volatility <= 10 THEN 'MODERATELY_VOLATILE'
        ELSE 'HIGHLY_VOLATILE'
    END AS performance_stability,
    
    -- SEAT CHANGE PROJECTION: Electoral risk/opportunity
    CASE 
        WHEN ws.next_semester_seats IS NOT NULL 
        THEN ROUND((ws.next_semester_seats - ws.prev_semester_seats)::NUMERIC / 2.0, 1)
        WHEN ws.prev_semester_seats IS NOT NULL 
        THEN ROUND((ws.seat_count_proxy - ws.prev_semester_seats)::NUMERIC, 1)
        ELSE NULL
    END AS projected_seat_change,
    
    -- EARLY WARNING FLAGS: Electoral risk alerts
    CASE 
        WHEN ws.seat_count_proxy < ws.prev_semester_seats - 10 THEN 'CRITICAL_SEAT_LOSS'
        WHEN ws.seat_count_proxy < ws.prev_semester_seats - 5 THEN 'SIGNIFICANT_SEAT_LOSS'
        WHEN ws.win_rate < ws.prev_semester_win_rate - 10 THEN 'CRITICAL_PERFORMANCE_DROP'
        WHEN ws.participation_rate < ws.prev_semester_participation - 10 THEN 'CRITICAL_ENGAGEMENT_DROP'
        WHEN ws.seat_count_proxy < ws.prev_semester_seats THEN 'SEAT_LOSS'
        WHEN ws.win_rate < ws.prev_semester_win_rate - 5 THEN 'PERFORMANCE_WARNING'
        ELSE 'NORMAL'
    END AS electoral_warning_flag,
    
    -- CYCLE CONTEXT FLAGS
    CASE WHEN ws.cycle_year = 4 AND ws.semester = 'spring' THEN TRUE ELSE FALSE END AS is_pre_election_period,
    CASE WHEN ws.cycle_year = 4 AND ws.semester = 'autumn' THEN TRUE ELSE FALSE END AS is_election_period,
    CASE WHEN ws.cycle_year = 1 AND ws.semester = 'spring' THEN TRUE ELSE FALSE END AS is_post_election_period
    
FROM windowed_statistics ws
ORDER BY ws.party, ws.election_cycle_id, ws.cycle_year, ws.semester;
        ]]>
    </createView>
    
    <rollback>
        <sql>DROP VIEW IF EXISTS view_riksdagen_party_electoral_trends CASCADE;</sql>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- 3. VIEW_RIKSDAGEN_INTELLIGENCE_DASHBOARD (Unified Dashboard)            -->
<!-- ========================================================================= -->

<changeSet author="stack-specialist" id="1.62-create-intelligence-dashboard" failOnError="true">
    <comment>
        Recreate view_riksdagen_intelligence_dashboard (originally from v1.29)
        
        This view aggregates multiple intelligence indicators into a single dashboard.
        It was recreated in v1.40 after being dropped by CASCADE but may be missing
        due to missing dependencies or execution order issues.
        
        Dependencies: All 5 core intelligence views must exist
    </comment>
    
    <dropView viewName="view_riksdagen_intelligence_dashboard"/>
    <createView viewName="view_riksdagen_intelligence_dashboard">
        <![CDATA[
WITH momentum_summary AS (
    -- Aggregate momentum indicators independently
    SELECT
        COUNT(DISTINCT party) FILTER (WHERE trend_direction IN ('STRONG_POSITIVE', 'POSITIVE')) AS parties_gaining_momentum,
        COUNT(DISTINCT party) FILTER (WHERE trend_direction IN ('STRONG_NEGATIVE', 'NEGATIVE')) AS parties_losing_momentum,
        COUNT(DISTINCT party) FILTER (WHERE stability_classification IN ('VOLATILE', 'HIGHLY_VOLATILE')) AS volatile_parties
    FROM view_riksdagen_party_momentum_analysis
),
coalition_summary AS (
    -- Aggregate coalition indicators independently
    SELECT
        COUNT(*) FILTER (WHERE coalition_likelihood = 'STRONG_COALITION') AS high_probability_coalitions,
        COUNT(*) FILTER (WHERE coalition_likelihood IN ('STRONG_COALITION', 'MODERATE_COALITION')) AS cross_bloc_alliances
    FROM view_riksdagen_coalition_alignment_matrix
),
anomaly_summary AS (
    -- Aggregate risk indicators independently using current column names
    -- high_defection_risks: Only the most severe rebels (high defection risk)
    -- low_discipline_politicians: Broader category including moderate rebels (low discipline)
    SELECT
        COUNT(*) FILTER (WHERE anomaly_classification IN ('FREQUENT_STRONG_REBEL', 'CONSISTENT_REBEL')) AS high_defection_risks,
        COUNT(*) FILTER (WHERE anomaly_classification IN ('FREQUENT_STRONG_REBEL', 'CONSISTENT_REBEL', 'MODERATE_REBEL', 'OCCASIONAL_REBEL')) AS low_discipline_politicians
    FROM view_riksdagen_voting_anomaly_detection
),
influence_summary AS (
    -- Aggregate influence indicators independently using current column names
    SELECT
        COUNT(*) FILTER (WHERE broker_classification IN ('STRONG_BROKER', 'MODERATE_BROKER')) AS power_brokers,
        COUNT(*) FILTER (WHERE influence_classification = 'HIGHLY_INFLUENTIAL') AS highly_connected_politicians
    FROM view_riksdagen_politician_influence_metrics
),
resilience_summary AS (
    -- Aggregate resilience indicators independently
    SELECT
        COUNT(*) FILTER (WHERE resilience_classification = 'HIGHLY_RESILIENT') AS crisis_ready_politicians,
        COUNT(*) FILTER (WHERE resilience_classification = 'LOW_RESILIENCE') AS low_resilience_politicians
    FROM view_riksdagen_crisis_resilience_indicators
),
vote_stats AS (
    SELECT
        MAX(vote_date) AS latest_vote_data,
        COUNT(DISTINCT embedded_id_ballot_id) FILTER (WHERE vote_date >= CURRENT_DATE - INTERVAL '30 days') AS ballots_last_30_days
    FROM vote_data
)
SELECT
    -- Temporal indicators
    ms.parties_gaining_momentum,
    ms.parties_losing_momentum,
    ms.volatile_parties,
    
    -- Coalition indicators
    cs.high_probability_coalitions,
    cs.cross_bloc_alliances,
    
    -- Risk indicators
    ans.high_defection_risks,
    ans.low_discipline_politicians,
    
    -- Influence indicators
    ins.power_brokers,
    ins.highly_connected_politicians,
    
    -- Resilience indicators
    rs.crisis_ready_politicians,
    rs.low_resilience_politicians,
    
    -- Overall assessment flags
    CASE
        WHEN ans.high_defection_risks >= 5
            THEN 'HIGH_POLITICAL_INSTABILITY_RISK'
        WHEN ms.volatile_parties >= 3
            THEN 'MODERATE_POLITICAL_INSTABILITY_RISK'
        ELSE 'STABLE_POLITICAL_ENVIRONMENT'
    END AS stability_assessment,
    
    CASE
        WHEN cs.cross_bloc_alliances >= 2
            THEN 'POTENTIAL_REALIGNMENT_DETECTED'
        WHEN cs.high_probability_coalitions >= 5
            THEN 'STABLE_COALITION_PATTERNS'
        ELSE 'UNCERTAIN_COALITION_LANDSCAPE'
    END AS coalition_assessment,
    
    -- Data freshness
    vs.latest_vote_data,
    vs.ballots_last_30_days,
    
    -- Intelligence report timestamp
    CURRENT_TIMESTAMP AS intelligence_report_timestamp
FROM momentum_summary ms
CROSS JOIN coalition_summary cs
CROSS JOIN anomaly_summary ans
CROSS JOIN influence_summary ins
CROSS JOIN resilience_summary rs
CROSS JOIN vote_stats vs;
        ]]>
    </createView>
    
    <rollback>
        <sql>DROP VIEW IF EXISTS view_riksdagen_intelligence_dashboard CASCADE;</sql>
    </rollback>
</changeSet>

</databaseChangeLog>
