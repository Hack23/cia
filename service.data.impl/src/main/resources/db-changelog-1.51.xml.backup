<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

<!-- 
  Riksmöte-Based Parliamentary Session Analysis Views v1.51
  Author: Political Analyst & Intelligence Operative  
  Date: 2026-01-13
  GitHub Issue: Historical Election Cycle Trend Views for All Elections (2002-Present)
  
  This changelog creates riksmöte (parliamentary session) analysis views using the rm column.
  Swedish Riksdag sessions run September to August (e.g., "2025/26" = Sept 2025 - Aug 2026).
  
  Views created:
  1. view_riksdagen_riksmote_summary - Overall session metrics
  2. view_riksdagen_politician_riksmote_performance - Politician tracking per session
  3. view_riksdagen_party_riksmote_trends - Party evolution across sessions
  
  Key differences from original implementation:
  - Uses rm (riksmöte) column instead of calendar year ranges
  - Parliamentary sessions, not arbitrary 4-year election cycles
  - Proper JPA entity models with JAXB annotations
-->

<!-- ========================================================================= -->
<!-- View 1: Riksmöte Summary - Overall Session Metrics                       -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="create-riksmote-summary-1.51-001" failOnError="true">
    <comment>
        Create view_riksdagen_riksmote_summary
        
        Provides comprehensive metrics for each riksmöte (parliamentary session).
        Uses the rm column which contains values like "2025/26", "2024/25", etc.
        Sessions run from September to August, aligned with Swedish parliamentary calendar.
        
        Intelligence Value: ⭐⭐⭐⭐ HIGH
        Enables session-based longitudinal analysis of Swedish democracy
    </comment>
    
    <createView viewName="view_riksdagen_riksmote_summary">
        <![CDATA[
SELECT 
    rm AS riksmote,
    COUNT(DISTINCT embedded_id_ballot_id) AS total_ballots,
    COUNT(DISTINCT embedded_id_intressent_id) AS active_politicians,
    COUNT(*) AS total_votes,
    COUNT(*) FILTER (WHERE vote = 'Ja') AS yes_votes,
    COUNT(*) FILTER (WHERE vote = 'Nej') AS no_votes,
    COUNT(*) FILTER (WHERE vote = 'Avstår') AS abstain_votes,
    COUNT(*) FILTER (WHERE vote = 'Frånvarande') AS absent_votes,
    ROUND(AVG(born_year), 0) AS avg_born_year,
    ROUND(100.0 * COUNT(*) FILTER (WHERE gender = 'MAN') / NULLIF(COUNT(*), 0), 2) AS percentage_male,
    ROUND(100.0 * COUNT(*) FILTER (WHERE gender = 'KVINNA') / NULLIF(COUNT(*), 0), 2) AS percentage_female,
    ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Ja') / NULLIF(COUNT(*), 0), 2) AS avg_yes_rate,
    ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Nej') / NULLIF(COUNT(*), 0), 2) AS avg_no_rate,
    ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Avstår') / NULLIF(COUNT(*), 0), 2) AS avg_abstain_rate,
    ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Frånvarande') / NULLIF(COUNT(*), 0), 2) AS avg_absent_rate,
    COUNT(DISTINCT party) AS active_parties,
    MIN(vote_date) AS session_first_vote,
    MAX(vote_date) AS session_last_vote,
    -- Election year indicator (elections typically held in September)
    CASE 
        WHEN rm IN ('2025/26', '2021/22', '2017/18', '2013/14', '2009/10', '2005/06', '2001/02') 
        THEN true 
        ELSE false 
    END AS is_election_year
FROM vote_data
WHERE rm IS NOT NULL
GROUP BY rm
ORDER BY rm DESC;
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_riksdagen_riksmote_summary"/>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- View 2: Politician Riksmöte Performance - Individual Tracking            -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="create-politician-riksmote-performance-1.51-002" failOnError="true">
    <comment>
        Create view_riksdagen_politician_riksmote_performance
        
        Tracks individual politician performance metrics across riksmöte sessions.
        Enables career trajectory analysis based on parliamentary sessions.
        
        Intelligence Value: ⭐⭐⭐⭐⭐ VERY HIGH
        Critical for politician scorecards and performance tracking
    </comment>
    
    <createView viewName="view_riksdagen_politician_riksmote_performance">
        <![CDATA[
SELECT 
    rm AS riksmote,
    embedded_id_intressent_id AS person_id,
    MAX(first_name) AS first_name,
    MAX(last_name) AS last_name,
    MAX(party) AS party,
    MAX(gender) AS gender,
    MAX(born_year) AS born_year,
    COUNT(DISTINCT embedded_id_ballot_id) AS ballot_participation,
    COUNT(*) AS total_votes_cast,
    COUNT(*) FILTER (WHERE vote = 'Ja') AS yes_votes,
    COUNT(*) FILTER (WHERE vote = 'Nej') AS no_votes,
    COUNT(*) FILTER (WHERE vote = 'Avstår') AS abstain_votes,
    COUNT(*) FILTER (WHERE vote = 'Frånvarande') AS absent_votes,
    ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Ja') / NULLIF(COUNT(*), 0), 2) AS yes_rate,
    ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Nej') / NULLIF(COUNT(*), 0), 2) AS no_rate,
    ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Avstår') / NULLIF(COUNT(*), 0), 2) AS abstain_rate,
    ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Frånvarande') / NULLIF(COUNT(*), 0), 2) AS absent_rate,
    ROUND(100.0 - (100.0 * COUNT(*) FILTER (WHERE vote = 'Frånvarande') / NULLIF(COUNT(*), 0)), 2) AS attendance_score
FROM vote_data
WHERE rm IS NOT NULL 
    AND embedded_id_intressent_id IS NOT NULL
GROUP BY rm, embedded_id_intressent_id
ORDER BY rm DESC, attendance_score DESC NULLS LAST;
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_riksdagen_politician_riksmote_performance"/>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- View 3: Party Riksmöte Trends - Party Evolution Analysis                 -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="create-party-riksmote-trends-1.51-003" failOnError="true">
    <comment>
        Create view_riksdagen_party_riksmote_trends
        
        Analyzes party evolution across riksmöte sessions including size,
        voting behavior, and market share trends.
        
        Intelligence Value: ⭐⭐⭐⭐⭐ VERY HIGH
        Essential for coalition analysis and electoral forecasting
    </comment>
    
    <createView viewName="view_riksdagen_party_riksmote_trends">
        <![CDATA[
WITH party_session_stats AS (
    SELECT
        rm AS riksmote,
        party,
        COUNT(DISTINCT embedded_id_intressent_id) AS party_size,
        COUNT(DISTINCT embedded_id_ballot_id) AS ballots_participated,
        COUNT(*) AS total_party_votes,
        COUNT(*) FILTER (WHERE vote = 'Ja') AS party_yes_votes,
        COUNT(*) FILTER (WHERE vote = 'Nej') AS party_no_votes,
        COUNT(*) FILTER (WHERE vote = 'Avstår') AS party_abstain_votes,
        COUNT(*) FILTER (WHERE vote = 'Frånvarande') AS party_absent_votes,
        ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Ja') / NULLIF(COUNT(*), 0), 2) AS party_yes_rate,
        ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Nej') / NULLIF(COUNT(*), 0), 2) AS party_no_rate,
        ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Frånvarande') / NULLIF(COUNT(*), 0), 2) AS party_absent_rate,
        ROUND(100.0 - (100.0 * COUNT(*) FILTER (WHERE vote = 'Frånvarande') / NULLIF(COUNT(*), 0)), 2) AS party_attendance_rate
    FROM vote_data
    WHERE rm IS NOT NULL 
        AND party IS NOT NULL
    GROUP BY rm, party
),
party_with_market_share AS (
    SELECT
        pss.*,
        SUM(party_size) OVER (PARTITION BY riksmote) AS total_politicians_in_session,
        ROUND(100.0 * party_size / NULLIF(SUM(party_size) OVER (PARTITION BY riksmote), 0), 2) AS party_market_share
    FROM party_session_stats pss
)
SELECT
    riksmote,
    party,
    party_size,
    ballots_participated,
    total_party_votes,
    party_yes_votes,
    party_no_votes,
    party_abstain_votes,
    party_absent_votes,
    party_yes_rate,
    party_no_rate,
    party_absent_rate,
    party_attendance_rate,
    party_market_share,
    -- Party size ranking within session
    RANK() OVER (PARTITION BY riksmote ORDER BY party_size DESC) AS size_rank,
    RANK() OVER (PARTITION BY riksmote ORDER BY party_attendance_rate DESC) AS attendance_rank
FROM party_with_market_share
ORDER BY riksmote DESC, party_size DESC;
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_riksdagen_party_riksmote_trends"/>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- View 4: Riksmöte Comparative Analysis - Advanced Window Functions        -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="create-riksmote-comparative-analysis-1.51-004-advanced" failOnError="true">
    <comment>
        Create view_riksdagen_riksmote_comparative_analysis
        
        Advanced statistical analysis using LAG(), LEAD(), z-scores, and historical baselines.
        Compares each riksmöte against previous sessions and historical averages.
        
        Intelligence Value: ⭐⭐⭐⭐⭐ VERY HIGH
        Critical for detecting anomalies and tracking parliamentary evolution
    </comment>
    
    <createView viewName="view_riksdagen_riksmote_comparative_analysis">
        <![CDATA[
WITH riksmote_stats AS (
    SELECT 
        rm AS riksmote,
        COUNT(DISTINCT embedded_id_ballot_id) AS total_ballots,
        COUNT(DISTINCT embedded_id_intressent_id) AS active_politicians,
        ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Ja') / NULLIF(COUNT(*), 0), 2) AS avg_yes_rate,
        ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Frånvarande') / NULLIF(COUNT(*), 0), 2) AS avg_absent_rate,
        COUNT(DISTINCT party) AS active_parties
    FROM vote_data
    WHERE rm IS NOT NULL
    GROUP BY rm
),
riksmote_with_comparisons AS (
    SELECT
        riksmote,
        total_ballots,
        active_politicians,
        avg_yes_rate,
        avg_absent_rate,
        active_parties,
        -- Period-over-period comparisons using LAG()
        LAG(total_ballots, 1) OVER (ORDER BY riksmote) AS prev_riksmote_ballots,
        LAG(avg_yes_rate, 1) OVER (ORDER BY riksmote) AS prev_riksmote_yes_rate,
        LEAD(total_ballots, 1) OVER (ORDER BY riksmote DESC) AS next_riksmote_ballots,
        -- Historical context
        FIRST_VALUE(total_ballots) OVER (ORDER BY riksmote) AS baseline_ballots,
        LAST_VALUE(total_ballots) OVER (ORDER BY riksmote ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS latest_ballots,
        AVG(total_ballots) OVER () AS historical_avg_ballots,
        STDDEV(total_ballots) OVER () AS historical_stddev_ballots,
        -- Ranking
        RANK() OVER (ORDER BY total_ballots DESC) AS ballot_productivity_rank,
        RANK() OVER (ORDER BY avg_absent_rate ASC) AS attendance_quality_rank
    FROM riksmote_stats
)
SELECT
    riksmote,
    total_ballots,
    active_politicians,
    avg_yes_rate,
    avg_absent_rate,
    active_parties,
    prev_riksmote_ballots,
    prev_riksmote_yes_rate,
    next_riksmote_ballots,
    baseline_ballots,
    latest_ballots,
    ROUND(historical_avg_ballots, 2) AS historical_avg_ballots,
    ROUND(historical_stddev_ballots, 2) AS historical_stddev_ballots,
    -- Change calculations
    ROUND(100.0 * (total_ballots - prev_riksmote_ballots) / NULLIF(prev_riksmote_ballots, 0), 2) AS ballot_change_pct,
    ROUND(avg_yes_rate - prev_riksmote_yes_rate, 2) AS yes_rate_change,
    -- Z-score for anomaly detection
    ROUND((total_ballots - historical_avg_ballots) / NULLIF(historical_stddev_ballots, 0), 2) AS ballot_zscore,
    -- Rankings
    ballot_productivity_rank,
    attendance_quality_rank,
    -- Classification based on z-score
    CASE 
        WHEN ABS((total_ballots - historical_avg_ballots) / NULLIF(historical_stddev_ballots, 0)) > 2 THEN 'ANOMALOUS'
        WHEN (total_ballots - historical_avg_ballots) / NULLIF(historical_stddev_ballots, 0) > 1 THEN 'ABOVE_AVERAGE'
        WHEN (total_ballots - historical_avg_ballots) / NULLIF(historical_stddev_ballots, 0) < -1 THEN 'BELOW_AVERAGE'
        ELSE 'TYPICAL'
    END AS activity_classification
FROM riksmote_with_comparisons
ORDER BY riksmote DESC;
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_riksdagen_riksmote_comparative_analysis"/>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- View 5: Politician Riksmöte Rankings - PERCENT_RANK & NTILE              -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="create-politician-riksmote-rankings-1.51-005-advanced" failOnError="true">
    <comment>
        Create view_riksdagen_politician_riksmote_rankings
        
        Advanced politician performance rankings using PERCENT_RANK() and NTILE().
        Identifies top/bottom performers and classifies politicians into quartiles.
        
        Intelligence Value: ⭐⭐⭐⭐⭐ VERY HIGH
        Essential for politician scorecards and Hall of Fame/Shame identification
    </comment>
    
    <createView viewName="view_riksdagen_politician_riksmote_rankings">
        <![CDATA[
WITH politician_stats AS (
    SELECT 
        rm AS riksmote,
        embedded_id_intressent_id AS person_id,
        MAX(first_name) AS first_name,
        MAX(last_name) AS last_name,
        MAX(party) AS party,
        COUNT(DISTINCT embedded_id_ballot_id) AS ballot_participation,
        ROUND(100.0 - (100.0 * COUNT(*) FILTER (WHERE vote = 'Frånvarande') / NULLIF(COUNT(*), 0)), 2) AS attendance_score,
        ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Ja') / NULLIF(COUNT(*), 0), 2) AS yes_rate,
        STDDEV(CASE WHEN vote = 'Ja' THEN 1.0 ELSE 0.0 END) OVER (PARTITION BY rm, embedded_id_intressent_id) AS vote_volatility
    FROM vote_data
    WHERE rm IS NOT NULL 
        AND embedded_id_intressent_id IS NOT NULL
    GROUP BY rm, embedded_id_intressent_id
)
SELECT
    riksmote,
    person_id,
    first_name,
    last_name,
    party,
    ballot_participation,
    attendance_score,
    yes_rate,
    -- Percentile rankings (0.0 to 1.0 scale)
    ROUND(PERCENT_RANK() OVER (PARTITION BY riksmote ORDER BY attendance_score DESC)::numeric, 4) AS attendance_percentile,
    ROUND(PERCENT_RANK() OVER (PARTITION BY riksmote ORDER BY ballot_participation DESC)::numeric, 4) AS participation_percentile,
    -- Quartile groupings (1-4)
    NTILE(4) OVER (PARTITION BY riksmote ORDER BY attendance_score DESC) AS attendance_quartile,
    NTILE(4) OVER (PARTITION BY riksmote ORDER BY ballot_participation DESC) AS participation_quartile,
    -- Session-wide rankings
    RANK() OVER (PARTITION BY riksmote ORDER BY attendance_score DESC) AS session_attendance_rank,
    RANK() OVER (PARTITION BY riksmote ORDER BY ballot_participation DESC) AS session_participation_rank,
    -- Party-level rankings
    RANK() OVER (PARTITION BY riksmote, party ORDER BY attendance_score DESC) AS party_attendance_rank,
    RANK() OVER (PARTITION BY riksmote, party ORDER BY ballot_participation DESC) AS party_participation_rank,
    -- Performance tier classification
    CASE 
        WHEN PERCENT_RANK() OVER (PARTITION BY riksmote ORDER BY attendance_score DESC) < 0.05 THEN 'HALL_OF_FAME'
        WHEN PERCENT_RANK() OVER (PARTITION BY riksmote ORDER BY attendance_score DESC) < 0.25 THEN 'EXCELLENT'
        WHEN PERCENT_RANK() OVER (PARTITION BY riksmote ORDER BY attendance_score DESC) < 0.75 THEN 'GOOD'
        WHEN PERCENT_RANK() OVER (PARTITION BY riksmote ORDER BY attendance_score DESC) < 0.95 THEN 'NEEDS_IMPROVEMENT'
        ELSE 'HALL_OF_SHAME'
    END AS performance_tier,
    -- Party MVP designation
    CASE 
        WHEN RANK() OVER (PARTITION BY riksmote, party ORDER BY attendance_score DESC) = 1 THEN true
        ELSE false
    END AS is_party_mvp,
    -- Consistency rating (based on vote volatility)
    CASE 
        WHEN vote_volatility < 0.2 THEN 'VERY_CONSISTENT'
        WHEN vote_volatility < 0.3 THEN 'CONSISTENT'
        WHEN vote_volatility < 0.4 THEN 'MODERATE'
        ELSE 'INCONSISTENT'
    END AS consistency_rating
FROM politician_stats
ORDER BY riksmote DESC, attendance_score DESC NULLS LAST;
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_riksdagen_politician_riksmote_rankings"/>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- View 6: Party Riksmöte Momentum - Moving Averages & Velocity             -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="create-party-riksmote-momentum-1.51-006-advanced" failOnError="true">
    <comment>
        Create view_riksdagen_party_riksmote_momentum
        
        Party momentum analysis using moving averages, velocity, and acceleration metrics.
        Enables coalition forecasting and party trajectory analysis.
        
        Intelligence Value: ⭐⭐⭐⭐⭐ VERY HIGH
        Critical for electoral forecasting and coalition potential assessment
    </comment>
    
    <createView viewName="view_riksdagen_party_riksmote_momentum">
        <![CDATA[
WITH party_session_data AS (
    SELECT
        rm AS riksmote,
        party,
        COUNT(DISTINCT embedded_id_intressent_id) AS party_size,
        ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Frånvarande') / NULLIF(COUNT(*), 0), 2) AS absent_rate
    FROM vote_data
    WHERE rm IS NOT NULL AND party IS NOT NULL
    GROUP BY rm, party
),
party_with_trends AS (
    SELECT
        riksmote,
        party,
        party_size,
        absent_rate,
        -- Market share calculation
        ROUND(100.0 * party_size / NULLIF(SUM(party_size) OVER (PARTITION BY riksmote), 0), 2) AS market_share,
        -- Previous session metrics using LAG()
        LAG(party_size, 1) OVER (PARTITION BY party ORDER BY riksmote) AS prev_session_size,
        LAG(party_size, 2) OVER (PARTITION BY party ORDER BY riksmote) AS prev_2_session_size,
        -- Moving averages (3-session window)
        AVG(party_size) OVER (PARTITION BY party ORDER BY riksmote ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS moving_avg_size_3session,
        -- Standard deviation for volatility
        STDDEV(party_size) OVER (PARTITION BY party ORDER BY riksmote ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS size_volatility_3session
    FROM party_session_data
)
SELECT
    riksmote,
    party,
    party_size,
    absent_rate,
    market_share,
    prev_session_size,
    ROUND(moving_avg_size_3session, 2) AS moving_avg_size_3session,
    ROUND(size_volatility_3session, 2) AS size_volatility,
    -- Velocity (rate of change)
    ROUND(party_size - prev_session_size, 0) AS size_change_1session,
    ROUND(100.0 * (party_size - prev_session_size) / NULLIF(prev_session_size, 0), 2) AS size_change_pct,
    -- Acceleration (change in velocity)
    ROUND((party_size - prev_session_size) - (prev_session_size - prev_2_session_size), 0) AS size_acceleration,
    -- Momentum classification
    CASE 
        WHEN (party_size - prev_session_size) > 10 THEN 'SURGING'
        WHEN (party_size - prev_session_size) > 5 THEN 'RISING'
        WHEN (party_size - prev_session_size) > 0 THEN 'GROWING'
        WHEN (party_size - prev_session_size) < -10 THEN 'COLLAPSING'
        WHEN (party_size - prev_session_size) < -5 THEN 'FALLING'
        WHEN (party_size - prev_session_size) < 0 THEN 'DECLINING'
        ELSE 'STABLE'
    END AS momentum_classification,
    -- Trajectory analysis
    CASE 
        WHEN (party_size - prev_session_size) > 0 
            AND ((party_size - prev_session_size) - (prev_session_size - prev_2_session_size)) > 0 
            THEN 'ACCELERATING_GROWTH'
        WHEN (party_size - prev_session_size) > 0 
            AND ((party_size - prev_session_size) - (prev_session_size - prev_2_session_size)) < 0 
            THEN 'DECELERATING_GROWTH'
        WHEN (party_size - prev_session_size) < 0 
            AND ((party_size - prev_session_size) - (prev_session_size - prev_2_session_size)) < 0 
            THEN 'ACCELERATING_DECLINE'
        WHEN (party_size - prev_session_size) < 0 
            AND ((party_size - prev_session_size) - (prev_session_size - prev_2_session_size)) > 0 
            THEN 'DECELERATING_DECLINE'
        ELSE 'STABLE'
    END AS trajectory,
    -- Coalition potential score (market share + momentum)
    ROUND(market_share + COALESCE(size_change_pct, 0) * 0.5, 2) AS coalition_potential_score,
    -- Size ranking within session
    RANK() OVER (PARTITION BY riksmote ORDER BY party_size DESC) AS size_rank
FROM party_with_trends
ORDER BY riksmote DESC, party_size DESC;
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_riksdagen_party_riksmote_momentum"/>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- View 7: Riksmöte Volatility Analysis - Coefficient of Variation          -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="create-riksmote-volatility-analysis-1.51-007-advanced" failOnError="true">
    <comment>
        Create view_riksdagen_riksmote_volatility_analysis
        
        Behavioral volatility analysis using coefficient of variation and stability scores.
        Identifies erratic performers and behavioral consistency patterns.
        
        Intelligence Value: ⭐⭐⭐⭐ HIGH
        Important for risk assessment and behavioral pattern recognition
    </comment>
    
    <createView viewName="view_riksdagen_riksmote_volatility_analysis">
        <![CDATA[
WITH politician_session_votes AS (
    SELECT
        rm AS riksmote,
        embedded_id_intressent_id AS person_id,
        MAX(first_name) AS first_name,
        MAX(last_name) AS last_name,
        MAX(party) AS party,
        COUNT(*) AS total_votes,
        AVG(CASE WHEN vote = 'Ja' THEN 1.0 ELSE 0.0 END) AS avg_yes_vote,
        STDDEV(CASE WHEN vote = 'Ja' THEN 1.0 ELSE 0.0 END) AS stddev_yes_vote,
        AVG(CASE WHEN vote = 'Frånvarande' THEN 1.0 ELSE 0.0 END) AS avg_absent,
        STDDEV(CASE WHEN vote = 'Frånvarande' THEN 1.0 ELSE 0.0 END) AS stddev_absent
    FROM vote_data
    WHERE rm IS NOT NULL AND embedded_id_intressent_id IS NOT NULL
    GROUP BY rm, embedded_id_intressent_id
    HAVING COUNT(*) >= 10  -- Minimum sample size for statistical validity
),
party_session_volatility AS (
    SELECT
        riksmote,
        party,
        AVG(stddev_yes_vote) AS party_avg_vote_volatility,
        STDDEV(stddev_yes_vote) AS party_vote_volatility_stddev
    FROM politician_session_votes
    WHERE party IS NOT NULL
    GROUP BY riksmote, party
)
SELECT
    psv.riksmote,
    psv.person_id,
    psv.first_name,
    psv.last_name,
    psv.party,
    psv.total_votes,
    ROUND(psv.avg_yes_vote::numeric, 4) AS avg_yes_rate,
    ROUND(psv.stddev_yes_vote::numeric, 4) AS vote_stddev,
    ROUND(psv.avg_absent::numeric, 4) AS avg_absent_rate,
    -- Coefficient of Variation (normalized volatility metric)
    ROUND((100.0 * psv.stddev_yes_vote / NULLIF(psv.avg_yes_vote, 0))::numeric, 2) AS vote_coefficient_of_variation,
    ROUND((100.0 * psv.stddev_absent / NULLIF(psv.avg_absent, 0))::numeric, 2) AS absent_coefficient_of_variation,
    -- Stability score (0-100, higher = more stable)
    ROUND((100.0 - (100.0 * psv.stddev_yes_vote / NULLIF(psv.avg_yes_vote + 1, 0)))::numeric, 2) AS vote_stability_score,
    ROUND((100.0 - (100.0 * psv.stddev_absent / NULLIF(psv.avg_absent + 1, 0)))::numeric, 2) AS attendance_stability_score,
    -- Party context
    ROUND(pv.party_avg_vote_volatility::numeric, 4) AS party_avg_volatility,
    -- Volatility relative to party
    CASE 
        WHEN psv.stddev_yes_vote > pv.party_avg_vote_volatility + pv.party_vote_volatility_stddev 
            THEN 'HIGHLY_VOLATILE'
        WHEN psv.stddev_yes_vote > pv.party_avg_vote_volatility 
            THEN 'ABOVE_PARTY_AVG'
        WHEN psv.stddev_yes_vote < pv.party_avg_vote_volatility - pv.party_vote_volatility_stddev 
            THEN 'VERY_STABLE'
        ELSE 'TYPICAL'
    END AS volatility_relative_to_party,
    -- Risk assessment
    CASE 
        WHEN psv.stddev_yes_vote > 0.4 THEN 'HIGH_RISK'
        WHEN psv.stddev_yes_vote > 0.3 THEN 'MODERATE_RISK'
        ELSE 'LOW_RISK'
    END AS behavioral_risk_level,
    -- Performance pattern classification
    CASE 
        WHEN psv.avg_yes_vote > 0.7 AND psv.stddev_yes_vote < 0.2 THEN 'CONSISTENTLY_EXCELLENT'
        WHEN psv.avg_yes_vote > 0.5 AND psv.stddev_yes_vote < 0.3 THEN 'RELIABLE_PERFORMER'
        WHEN psv.stddev_yes_vote > 0.4 THEN 'ERRATIC_PERFORMER'
        WHEN psv.avg_yes_vote < 0.3 AND psv.stddev_yes_vote < 0.2 THEN 'CONSISTENTLY_OPPOSED'
        ELSE 'MODERATE_PERFORMER'
    END AS performance_pattern
FROM politician_session_votes psv
LEFT JOIN party_session_volatility pv 
    ON psv.riksmote = pv.riksmote AND psv.party = pv.party
ORDER BY psv.riksmote DESC, psv.stddev_yes_vote DESC;
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_riksdagen_riksmote_volatility_analysis"/>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- View 8: Committee Riksmöte Activity - DENSE_RANK & Productivity Tiers    -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="create-committee-riksmote-activity-1.51-008-advanced" failOnError="true">
    <comment>
        Create view_riksdagen_committee_riksmote_activity
        
        Committee productivity analysis using DENSE_RANK() and NTILE() for tier classification.
        Tracks committee workload and activity levels across riksmöte sessions.
        
        Intelligence Value: ⭐⭐⭐⭐ HIGH
        Essential for legislative productivity monitoring and committee effectiveness
    </comment>
    
    <createView viewName="view_riksdagen_committee_riksmote_activity">
        <![CDATA[
WITH committee_ballot_stats AS (
    SELECT
        rm AS riksmote,
        COALESCE(beteckning, 'UNKNOWN') AS committee_designation,
        COUNT(DISTINCT embedded_id_ballot_id) AS committee_ballots,
        COUNT(DISTINCT embedded_id_intressent_id) AS committee_members,
        ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Ja') / NULLIF(COUNT(*), 0), 2) AS yes_rate,
        ROUND(100.0 * COUNT(*) FILTER (WHERE vote = 'Frånvarande') / NULLIF(COUNT(*), 0), 2) AS absent_rate,
        STDDEV(CASE WHEN vote = 'Ja' THEN 1.0 ELSE 0.0 END) AS vote_volatility
    FROM vote_data
    WHERE rm IS NOT NULL
    GROUP BY rm, beteckning
)
SELECT
    riksmote,
    committee_designation,
    committee_ballots,
    committee_members,
    yes_rate,
    absent_rate,
    ROUND(vote_volatility::numeric, 4) AS vote_volatility,
    -- Dense ranking (no gaps for ties)
    DENSE_RANK() OVER (PARTITION BY riksmote ORDER BY committee_ballots DESC) AS productivity_dense_rank,
    -- Quartile classification
    NTILE(4) OVER (PARTITION BY riksmote ORDER BY committee_ballots DESC) AS productivity_quartile,
    -- Activity level tiers
    CASE 
        WHEN NTILE(4) OVER (PARTITION BY riksmote ORDER BY committee_ballots DESC) = 1 THEN 'VERY_ACTIVE'
        WHEN NTILE(4) OVER (PARTITION BY riksmote ORDER BY committee_ballots DESC) = 2 THEN 'ACTIVE'
        WHEN NTILE(4) OVER (PARTITION BY riksmote ORDER BY committee_ballots DESC) = 3 THEN 'MODERATE'
        ELSE 'LOW_ACTIVITY'
    END AS activity_level,
    -- Trend indicators (comparing to previous session)
    LAG(committee_ballots, 1) OVER (PARTITION BY committee_designation ORDER BY riksmote) AS prev_session_ballots,
    CASE 
        WHEN committee_ballots > LAG(committee_ballots, 1) OVER (PARTITION BY committee_designation ORDER BY riksmote) * 1.1 
            THEN 'INCREASING'
        WHEN committee_ballots < LAG(committee_ballots, 1) OVER (PARTITION BY committee_designation ORDER BY riksmote) * 0.9 
            THEN 'DECREASING'
        ELSE 'STABLE'
    END AS activity_trend,
    -- Percentile ranking
    ROUND(PERCENT_RANK() OVER (PARTITION BY riksmote ORDER BY committee_ballots DESC)::numeric, 4) AS productivity_percentile,
    -- Members per ballot ratio (efficiency metric)
    ROUND(committee_members::numeric / NULLIF(committee_ballots, 0), 2) AS members_per_ballot_ratio
FROM committee_ballot_stats
WHERE committee_designation != 'UNKNOWN'
ORDER BY riksmote DESC, committee_ballots DESC;
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_riksdagen_committee_riksmote_activity"/>
    </rollback>
</changeSet>

</databaseChangeLog>
