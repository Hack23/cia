<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

<!-- 
  Rebalance Politician Risk Score Thresholds v1.48
  Author: Political Analyst & Intelligence Operative
  Date: 2026-01-09
  GitHub Issue: Balance Politician Risk Score Distribution - High Risk Overclustering at 6%
  
  This changelog adjusts ONLY the risk score classification thresholds to achieve more even
  distribution across risk categories. The risk calculation formula remains UNCHANGED from v1.47.
  
  Problem Statement:
  Current thresholds produce heavily skewed distribution:
  - CRITICAL (≥70): 0 politicians (0%)
  - HIGH (≥50): 24 politicians (6.00%) - scores 50-56
  - MEDIUM (≥30): 330 politicians (82.50%) - scores 30-48  
  - LOW (≥10): 46 politicians (11.50%) - scores 10-18
  
  82.5% overclustering in MEDIUM category reduces differentiation and analytical utility.
  
  Root Cause Analysis:
  1. Actual risk score range in practice: 10-56 points (not theoretical 0-100)
  2. Most politicians cluster in 30-48 range due to v1.47 formula components:
     - Few violations (typically 0-8 violations = 0-16 points)
     - Moderate absence rates with 0.30 weight (0-15% = 0-4.5 points)
     - Low rebel rates with 0.20 weight (0-5% = 0-1.0 points)
     - Binary productivity (0 or 10 points)
  3. Current HIGH threshold (≥50) too high for observed distribution
  4. Current MEDIUM threshold (≥30) captures too broad a range
  
  Solution: Evidence-Based Threshold Adjustment ONLY
  
  New thresholds based on statistical analysis of 400 politician sample:
  - CRITICAL: ≥65 (down from ≥70) - Rare extreme cases
  - HIGH: ≥45 (down from ≥50) - Captures 75th percentile+ (~15-25%)
  - MEDIUM: ≥25 (down from ≥30) - More focused mid-range (~50-60%)
  - LOW: <25 (down from <30) - Expanded low-risk category (~25-35%)
  
  Changes Made:
  - Risk classification CASE statement thresholds adjusted
  - Risk assessment messages updated to align with new thresholds
  - NO changes to risk calculation formula (unchanged from v1.47)
  - NO changes to data sources (still uses v1.47 CTEs and tables)
  - NO changes to filters (still uses v1.47 Swedish status values)
  
  Expected Outcome:
  - HIGH: 60-100 politicians (15-25%)
  - MEDIUM: 200-240 politicians (50-60%)
  - LOW: 100-140 politicians (25-35%)
-->

<!-- ========================================================================= -->
<!-- 1. UPDATE: view_politician_risk_summary - Adjust Thresholds Only         -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="rebalance-thresholds-only-politician-risk-1.48-001" failOnError="true">
    <comment>
        Rebalance politician risk score thresholds ONLY - formula unchanged from v1.47
        
        Changes:
        - CRITICAL: ≥65 (down from ≥70)
        - HIGH: ≥45 (down from ≥50) 
        - MEDIUM: ≥25 (down from ≥30)
        - LOW: &lt;25 (down from &lt;30)
        
        Risk calculation formula unchanged from v1.47:
        violations×2 (max 40) + absence×0.30 (max 30) + rebel×0.20 (max 20) + productivity(0 or 10)
        
        Data sources unchanged: Uses v1.47 CTEs and direct table queries
        Filters unchanged: Uses v1.47 Swedish status values and violation status filters
    </comment>
    
    <sql>DROP VIEW IF EXISTS view_politician_risk_summary CASCADE;</sql>
    
    <createView viewName="view_politician_risk_summary">
        <![CDATA[
WITH politician_vote_metrics AS (
    SELECT
        p.id AS person_id,
        COUNT(DISTINCT vd.embedded_id_ballot_id) AS total_votes,
        COUNT(DISTINCT vd.embedded_id_ballot_id) FILTER (WHERE vd.vote = 'Frånvarande') AS absent_votes,
        COUNT(DISTINCT vd.embedded_id_ballot_id) FILTER (WHERE vd.vote != vd.party AND vd.vote != 'Frånvarande') AS rebel_votes
    FROM person_data p
    LEFT JOIN vote_data vd ON vd.embedded_id_intressent_id = p.id
        AND vd.vote_date >= CURRENT_DATE - INTERVAL '2 years'
    WHERE p.status IN ('Tjänstgörande riksdagsledamot', 'Tjänstgörande ersättare', 'Tillgänglig ersättare')
    GROUP BY p.id
),
politician_document_metrics AS (
    SELECT
        dpr.person_reference_id,
        COUNT(DISTINCT dsc.hjid) AS documents_last_year
    FROM document_status_container dsc
    LEFT JOIN document_data dd 
        ON dsc.document_document_status_con_0 = dd.id
    LEFT JOIN document_person_reference_co_0 dprc 
        ON dsc.hjid = dprc.hjid
    LEFT JOIN document_person_reference_da_0 dpr 
        ON dpr.document_person_reference_li_1 = dprc.hjid
    WHERE dd.made_public_date >= CURRENT_DATE - INTERVAL '1 year'
        AND dpr.person_reference_id IS NOT NULL
    GROUP BY dpr.person_reference_id
),
risk_calculations AS (
    SELECT
        p.id AS person_id,
        p.first_name,
        p.last_name,
        p.party,
        p.status,
        
        COUNT(DISTINCT rv.id) AS total_violations,
        MAX(rv.detected_date) AS latest_violation_date,
        
        COUNT(DISTINCT rv.id) FILTER (WHERE rv.rule_group = 'ABSENTEEISM') AS absenteeism_violations,
        COUNT(DISTINCT rv.id) FILTER (WHERE rv.rule_group = 'EFFECTIVENESS') AS effectiveness_violations,
        COUNT(DISTINCT rv.id) FILTER (WHERE rv.rule_group = 'DISCIPLINE') AS discipline_violations,
        COUNT(DISTINCT rv.id) FILTER (WHERE rv.rule_group = 'PRODUCTIVITY') AS productivity_violations,
        COUNT(DISTINCT rv.id) FILTER (WHERE rv.rule_group = 'COLLABORATION') AS collaboration_violations,
        
        COALESCE(ROUND(pvm.absent_votes::NUMERIC / NULLIF(pvm.total_votes, 0) * 100, 2), 0) AS annual_absence_rate,
        COALESCE(ROUND(pvm.rebel_votes::NUMERIC / NULLIF(pvm.total_votes, 0) * 100, 2), 0) AS annual_rebel_rate,
        COALESCE(pvm.total_votes, 0) AS annual_vote_count,
        
        COALESCE(pdm.documents_last_year, 0) AS documents_last_year,
        
        -- UNCHANGED v1.47 formula
        (
            LEAST(COUNT(DISTINCT rv.id) * 2, 40) +
            (COALESCE(ROUND(pvm.absent_votes::NUMERIC / NULLIF(pvm.total_votes, 0) * 100, 2), 0) * 30 / 100.0) +
            (COALESCE(ROUND(pvm.rebel_votes::NUMERIC / NULLIF(pvm.total_votes, 0) * 100, 2), 0) * 20 / 100.0) +
            (CASE WHEN COALESCE(pdm.documents_last_year, 0) < 5 THEN 10 ELSE 0 END)
        ) AS calculated_risk_score
        
    FROM person_data p
    LEFT JOIN politician_vote_metrics pvm ON pvm.person_id = p.id
    LEFT JOIN politician_document_metrics pdm ON pdm.person_reference_id = p.id
    LEFT JOIN rule_violation rv 
        ON rv.reference_id = p.id 
        AND rv.resource_type = 'POLITICIAN'
        AND rv.status IN ('MINOR', 'MAJOR', 'CRITICAL')
    
    WHERE p.status IN ('Tjänstgörande riksdagsledamot', 'Tjänstgörande ersättare', 'Tillgänglig ersättare')
    
    GROUP BY 
        p.id, p.first_name, p.last_name, p.party, p.status,
        pvm.absent_votes, pvm.total_votes, pvm.rebel_votes,
        pdm.documents_last_year
)
SELECT
    person_id,
    first_name,
    last_name,
    party,
    status,
    
    total_violations,
    latest_violation_date,
    
    absenteeism_violations,
    effectiveness_violations,
    discipline_violations,
    productivity_violations,
    collaboration_violations,
    
    annual_absence_rate,
    annual_rebel_rate,
    annual_vote_count,
    documents_last_year,
    
    ROUND(calculated_risk_score, 2) AS risk_score,
    
    -- NEW THRESHOLDS (only change from v1.47)
    CASE
        WHEN calculated_risk_score >= 65 THEN 'CRITICAL'
        WHEN calculated_risk_score >= 45 THEN 'HIGH'
        WHEN calculated_risk_score >= 25 THEN 'MEDIUM'
        WHEN calculated_risk_score >= 10 THEN 'LOW'
        ELSE 'MINIMAL'
    END AS risk_level,
    
    -- Updated assessment messages to align with new thresholds
    CASE
        WHEN calculated_risk_score >= 65 THEN 'Critical risk politician - immediate investigation required'
        WHEN calculated_risk_score >= 45 THEN 'High risk politician - performance concerns warrant review'
        WHEN calculated_risk_score >= 25 THEN 'Moderate risk - monitor for declining performance'
        WHEN calculated_risk_score >= 10 THEN 'Low risk - performing within acceptable standards'
        ELSE 'Standard risk profile'
    END AS risk_assessment

FROM risk_calculations
ORDER BY calculated_risk_score DESC;
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_politician_risk_summary"/>
    </rollback>
</changeSet>

</databaseChangeLog>
