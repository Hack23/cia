<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

<!-- 
  OSINT Performance Tracking Views v1.30
  Author: Political Analyst & Intelligence Operative
  Date: 2025-11-15
  
  This changelog implements aggregated metrics views for OSINT performance tracking,
  enabling efficient monitoring of politician behavioral trends, party effectiveness,
  and temporal risk patterns to support the intelligence frameworks defined in
  RISK_RULES_INTOP_OSINT.md.
  
  Intelligence Frameworks Supported:
  1. Temporal Analysis - Daily/Monthly/Annual trends tracking
  2. Comparative Analysis - Peer comparison, historical baselines
  3. Pattern Recognition - Behavioral clusters, correlation detection
  4. Predictive Intelligence - Trend extrapolation, risk escalation
  
  Time Window Strategy:
  - Monthly aggregation: Captures granular behavioral patterns for trend analysis
  - Annual aggregation: Provides strategic overview of long-term changes
  - 3-year historical window: Balances data relevance with pattern detection needs
  - Rolling periods: Enable time-series analysis for predictive modeling
-->

<!-- ========================================================================= -->
<!-- 1. POLITICIAN BEHAVIORAL TRENDS VIEW                                      -->
<!-- Intelligence Value: VERY HIGH - Individual behavioral pattern analysis    -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="osint-2025111501-politician-behavioral-trends" failOnError="true">
    <comment>
        Politician Behavioral Trends View
        
        Intelligence Purpose:
        - Track time-series behavioral patterns for each politician
        - Monitor absence rates, voting effectiveness, party discipline
        - Identify behavioral changes and anomalies over time
        - Support predictive analysis of future behavior
        
        Use Cases:
        - Individual politician risk assessment
        - Behavioral trend forecasting
        - Anomaly detection in voting patterns
        - Performance tracking over electoral cycles
        
        RISK_RULES_INTOP_OSINT.md Support:
        - Rule P-01 to P-24: Individual politician behavior monitoring
        - Temporal Analysis: Monthly granularity for trend detection
        - Pattern Recognition: Behavioral cluster identification
    </comment>
    
    <createView viewName="view_politician_behavioral_trends">
        <![CDATA[
WITH monthly_voting_data AS (
    SELECT
        embedded_id_intressent_id AS person_id,
        DATE_TRUNC('month', embedded_id_vote_date) AS period_start,
        MAX(first_name) AS first_name,
        MAX(last_name) AS last_name,
        MAX(party) AS party,
        SUM(number_ballots) AS total_ballots,
        SUM(total_votes) AS total_votes,
        ROUND(AVG(avg_percentage_absent), 2) AS avg_absence_rate,
        ROUND(AVG(avg_percentage_yes), 2) AS avg_yes_rate,
        ROUND(AVG(avg_percentage_no), 2) AS avg_no_rate,
        ROUND(AVG(avg_percentage_abstain), 2) AS avg_abstain_rate,
        ROUND(AVG(won_percentage), 2) AS avg_win_rate,
        ROUND(AVG(rebel_percentage), 2) AS avg_rebel_rate
    FROM view_riksdagen_vote_data_ballot_politician_summary_daily
    WHERE embedded_id_vote_date >= CURRENT_DATE - INTERVAL '3 years'
    GROUP BY embedded_id_intressent_id, DATE_TRUNC('month', embedded_id_vote_date)
),
violation_counts AS (
    SELECT
        reference_id AS person_id,
        DATE_TRUNC('month', detected_date) AS period_start,
        COUNT(*) AS violation_count,
        COUNT(DISTINCT rule_group) AS violation_types,
        MAX(detected_date) AS latest_violation_date
    FROM rule_violation
    WHERE resource_type = 'POLITICIAN'
        AND status = 'ACTIVE'
        AND detected_date >= CURRENT_DATE - INTERVAL '3 years'
    GROUP BY reference_id, DATE_TRUNC('month', detected_date)
),
trend_calculations AS (
    SELECT
        mvd.person_id,
        mvd.period_start,
        mvd.first_name,
        mvd.last_name,
        mvd.party,
        mvd.total_ballots,
        mvd.total_votes,
        mvd.avg_absence_rate,
        mvd.avg_yes_rate,
        mvd.avg_no_rate,
        mvd.avg_abstain_rate,
        mvd.avg_win_rate,
        mvd.avg_rebel_rate,
        COALESCE(vc.violation_count, 0) AS violation_count,
        COALESCE(vc.violation_types, 0) AS violation_types,
        
        -- Previous period values for trend calculation
        LAG(mvd.avg_absence_rate, 1) OVER (PARTITION BY mvd.person_id ORDER BY mvd.period_start) AS prev_absence_rate,
        LAG(mvd.avg_win_rate, 1) OVER (PARTITION BY mvd.person_id ORDER BY mvd.period_start) AS prev_win_rate,
        LAG(mvd.avg_rebel_rate, 1) OVER (PARTITION BY mvd.person_id ORDER BY mvd.period_start) AS prev_rebel_rate,
        
        -- 3-month moving averages for smoothing
        ROUND(AVG(mvd.avg_absence_rate) OVER (
            PARTITION BY mvd.person_id 
            ORDER BY mvd.period_start 
            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
        ), 2) AS ma_3month_absence,
        
        ROUND(AVG(mvd.avg_win_rate) OVER (
            PARTITION BY mvd.person_id 
            ORDER BY mvd.period_start 
            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
        ), 2) AS ma_3month_win_rate,
        
        ROUND(AVG(mvd.avg_rebel_rate) OVER (
            PARTITION BY mvd.person_id 
            ORDER BY mvd.period_start 
            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
        ), 2) AS ma_3month_rebel_rate
    FROM monthly_voting_data mvd
    LEFT JOIN violation_counts vc 
        ON mvd.person_id = vc.person_id 
        AND mvd.period_start = vc.period_start
)
SELECT
    person_id,
    period_start,
    DATE_TRUNC('month', period_start + INTERVAL '1 month' - INTERVAL '1 day') AS period_end,
    first_name,
    last_name,
    party,
    total_ballots,
    total_votes,
    avg_absence_rate,
    avg_yes_rate,
    avg_no_rate,
    avg_abstain_rate,
    avg_win_rate,
    avg_rebel_rate,
    violation_count,
    violation_types,
    
    -- Trend indicators (change from previous period)
    ROUND(avg_absence_rate - prev_absence_rate, 2) AS absence_trend,
    ROUND(avg_win_rate - prev_win_rate, 2) AS win_rate_trend,
    ROUND(avg_rebel_rate - prev_rebel_rate, 2) AS rebel_rate_trend,
    
    -- Moving averages for smoothed trends
    ma_3month_absence,
    ma_3month_win_rate,
    ma_3month_rebel_rate,
    
    -- Behavioral classification
    CASE
        WHEN avg_absence_rate >= 30 THEN 'HIGH_ABSENTEEISM'
        WHEN avg_absence_rate >= 15 THEN 'MODERATE_ABSENTEEISM'
        WHEN avg_absence_rate >= 5 THEN 'LOW_ABSENTEEISM'
        ELSE 'EXCELLENT_ATTENDANCE'
    END AS attendance_status,
    
    CASE
        WHEN avg_win_rate >= 80 THEN 'HIGHLY_EFFECTIVE'
        WHEN avg_win_rate >= 60 THEN 'EFFECTIVE'
        WHEN avg_win_rate >= 40 THEN 'MODERATELY_EFFECTIVE'
        ELSE 'LOW_EFFECTIVENESS'
    END AS effectiveness_status,
    
    CASE
        WHEN avg_rebel_rate >= 20 THEN 'HIGH_INDEPENDENCE'
        WHEN avg_rebel_rate >= 10 THEN 'MODERATE_INDEPENDENCE'
        WHEN avg_rebel_rate >= 5 THEN 'LOW_INDEPENDENCE'
        ELSE 'PARTY_LOYAL'
    END AS discipline_status,
    
    -- Intelligence assessment
    CASE
        WHEN avg_absence_rate >= 30 OR avg_rebel_rate >= 20 OR violation_count >= 3
            THEN 'ELEVATED_RISK'
        WHEN avg_absence_rate >= 15 OR avg_rebel_rate >= 10 OR violation_count >= 1
            THEN 'MODERATE_RISK'
        WHEN avg_win_rate >= 70 AND avg_absence_rate < 10
            THEN 'HIGH_PERFORMER'
        ELSE 'STANDARD_BEHAVIOR'
    END AS behavioral_assessment
    
FROM trend_calculations
WHERE total_ballots >= 5  -- Minimum activity threshold
ORDER BY person_id, period_start DESC;
        ]]>
    </createView>
</changeSet>

<!-- ========================================================================= -->
<!-- 2. PARTY EFFECTIVENESS TRENDS VIEW                                        -->
<!-- Intelligence Value: VERY HIGH - Organizational performance over time      -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="osint-2025111502-party-effectiveness-trends" failOnError="true">
    <comment>
        Party Effectiveness Trends View
        
        Intelligence Purpose:
        - Monitor party-level performance metrics over time
        - Track win rates, productivity, and collaboration patterns
        - Identify organizational strengths and weaknesses
        - Support coalition formation analysis
        
        Use Cases:
        - Party performance benchmarking
        - Coalition viability assessment
        - Electoral strategy analysis
        - Organizational health monitoring
        
        RISK_RULES_INTOP_OSINT.md Support:
        - Rule Pa-01 to Pa-10: Party-level behavior monitoring
        - Temporal Analysis: Quarterly trends for strategic assessment
        - Comparative Analysis: Cross-party benchmarking
    </comment>
    
    <createView viewName="view_party_effectiveness_trends">
        <![CDATA[
WITH quarterly_party_voting AS (
    SELECT
        party,
        DATE_TRUNC('quarter', embedded_id_vote_date) AS period_start,
        COUNT(DISTINCT embedded_id_intressent_id) AS active_members,
        SUM(number_ballots) AS total_ballots,
        SUM(total_votes) AS total_votes,
        ROUND(AVG(avg_percentage_absent), 2) AS avg_absence_rate,
        ROUND(AVG(won_percentage), 2) AS avg_win_rate,
        ROUND(AVG(rebel_percentage), 2) AS avg_rebel_rate,
        ROUND(AVG(avg_percentage_yes), 2) AS avg_yes_rate
    FROM view_riksdagen_vote_data_ballot_politician_summary_daily
    WHERE embedded_id_vote_date >= CURRENT_DATE - INTERVAL '3 years'
        AND party IS NOT NULL
    GROUP BY party, DATE_TRUNC('quarter', embedded_id_vote_date)
),
party_documents AS (
    SELECT
        party_short_code AS party,
        DATE_TRUNC('quarter', made_public_date) AS period_start,
        COUNT(*) AS documents_produced,
        COUNT(DISTINCT CASE WHEN document_type = 'Motion' THEN doc_id END) AS motions_count,
        COUNT(DISTINCT person_reference_id) AS active_document_authors
    FROM view_riksdagen_politician_document
    WHERE made_public_date >= CURRENT_DATE - INTERVAL '3 years'
        AND party_short_code IS NOT NULL
    GROUP BY party_short_code, DATE_TRUNC('quarter', made_public_date)
),
party_violations AS (
    SELECT
        pd.party,
        DATE_TRUNC('quarter', rv.detected_date) AS period_start,
        COUNT(DISTINCT rv.id) AS violation_count,
        COUNT(DISTINCT rv.reference_id) AS members_with_violations
    FROM rule_violation rv
    JOIN person_data pd ON rv.reference_id = pd.id
    WHERE rv.resource_type = 'POLITICIAN'
        AND rv.status = 'ACTIVE'
        AND rv.detected_date >= CURRENT_DATE - INTERVAL '3 years'
        AND pd.party IS NOT NULL
    GROUP BY pd.party, DATE_TRUNC('quarter', rv.detected_date)
),
trend_analysis AS (
    SELECT
        qpv.party,
        qpv.period_start,
        qpv.active_members,
        qpv.total_ballots,
        qpv.total_votes,
        qpv.avg_absence_rate,
        qpv.avg_win_rate,
        qpv.avg_rebel_rate,
        qpv.avg_yes_rate,
        COALESCE(pds.documents_produced, 0) AS documents_produced,
        COALESCE(pds.motions_count, 0) AS motions_count,
        COALESCE(pds.active_document_authors, 0) AS active_document_authors,
        COALESCE(pvs.violation_count, 0) AS violation_count,
        COALESCE(pvs.members_with_violations, 0) AS members_with_violations,
        
        -- Previous period for trend calculation
        LAG(qpv.avg_win_rate, 1) OVER (PARTITION BY qpv.party ORDER BY qpv.period_start) AS prev_win_rate,
        LAG(qpv.avg_absence_rate, 1) OVER (PARTITION BY qpv.party ORDER BY qpv.period_start) AS prev_absence_rate,
        LAG(qpv.active_members, 1) OVER (PARTITION BY qpv.party ORDER BY qpv.period_start) AS prev_members,
        
        -- 4-quarter moving averages
        ROUND(AVG(qpv.avg_win_rate) OVER (
            PARTITION BY qpv.party 
            ORDER BY qpv.period_start 
            ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
        ), 2) AS ma_4quarter_win_rate,
        
        ROUND(AVG(qpv.avg_absence_rate) OVER (
            PARTITION BY qpv.party 
            ORDER BY qpv.period_start 
            ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
        ), 2) AS ma_4quarter_absence
    FROM quarterly_party_voting qpv
    LEFT JOIN party_documents pds 
        ON qpv.party = pds.party 
        AND qpv.period_start = pds.period_start
    LEFT JOIN party_violations pvs 
        ON qpv.party = pvs.party 
        AND qpv.period_start = pvs.period_start
)
SELECT
    party,
    period_start,
    DATE_TRUNC('quarter', period_start + INTERVAL '3 months' - INTERVAL '1 day') AS period_end,
    EXTRACT(YEAR FROM period_start) AS year,
    EXTRACT(QUARTER FROM period_start) AS quarter,
    active_members,
    total_ballots,
    total_votes,
    avg_absence_rate,
    avg_win_rate,
    avg_rebel_rate,
    avg_yes_rate,
    documents_produced,
    motions_count,
    active_document_authors,
    violation_count,
    members_with_violations,
    
    -- Trend indicators
    ROUND(avg_win_rate - prev_win_rate, 2) AS win_rate_trend,
    ROUND(avg_absence_rate - prev_absence_rate, 2) AS absence_trend,
    active_members - prev_members AS member_change,
    
    -- Moving averages
    ma_4quarter_win_rate,
    ma_4quarter_absence,
    
    -- Productivity metrics
    ROUND(CAST(documents_produced AS NUMERIC) / NULLIF(active_members, 0), 2) AS docs_per_member,
    ROUND(CAST(total_votes AS NUMERIC) / NULLIF(active_members, 0), 2) AS votes_per_member,
    ROUND(CAST(violation_count AS NUMERIC) / NULLIF(active_members, 0), 2) AS violations_per_member,
    
    -- Performance classification
    CASE
        WHEN avg_win_rate >= 75 AND avg_absence_rate < 10 THEN 'HIGH_PERFORMANCE'
        WHEN avg_win_rate >= 60 AND avg_absence_rate < 15 THEN 'GOOD_PERFORMANCE'
        WHEN avg_win_rate >= 45 OR avg_absence_rate < 20 THEN 'MODERATE_PERFORMANCE'
        ELSE 'LOW_PERFORMANCE'
    END AS performance_level,
    
    CASE
        WHEN documents_produced >= 50 THEN 'HIGHLY_PRODUCTIVE'
        WHEN documents_produced >= 20 THEN 'PRODUCTIVE'
        WHEN documents_produced >= 10 THEN 'MODERATELY_PRODUCTIVE'
        ELSE 'LOW_PRODUCTIVITY'
    END AS productivity_level,
    
    -- Intelligence assessment
    CASE
        WHEN avg_win_rate >= 70 AND avg_absence_rate < 12 AND violation_count <= 2
            THEN 'Strong organizational effectiveness'
        WHEN avg_win_rate >= 55 AND avg_absence_rate < 18
            THEN 'Solid party performance'
        WHEN avg_absence_rate >= 20 OR violation_count >= 5
            THEN 'Performance concerns detected'
        ELSE 'Standard party operations'
    END AS effectiveness_assessment
    
FROM trend_analysis
ORDER BY party, period_start DESC;
        ]]>
    </createView>
</changeSet>

<!-- ========================================================================= -->
<!-- 3. RISK SCORE EVOLUTION VIEW                                              -->
<!-- Intelligence Value: CRITICAL - Historical risk tracking and prediction    -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="osint-2025111503-risk-score-evolution" failOnError="true">
    <comment>
        Risk Score Evolution View
        
        Intelligence Purpose:
        - Track historical changes in politician risk scores
        - Monitor severity transitions (escalation/de-escalation)
        - Identify risk patterns and triggers
        - Support predictive risk modeling
        
        Use Cases:
        - Early warning of risk escalation
        - Risk mitigation effectiveness tracking
        - Intervention timing optimization
        - Risk trajectory forecasting
        
        RISK_RULES_INTOP_OSINT.md Support:
        - All 45 risk rules: Comprehensive risk monitoring
        - Temporal Analysis: Risk score time-series
        - Predictive Intelligence: Trend extrapolation for forecasting
    </comment>
    
    <createView viewName="view_risk_score_evolution">
        <![CDATA[
WITH monthly_risk_base AS (
    SELECT
        p.id AS person_id,
        p.first_name,
        p.last_name,
        p.party,
        DATE_TRUNC('month', vd.embedded_id_vote_date) AS assessment_period,
        
        -- Vote-based metrics
        ROUND(AVG(vd.avg_percentage_absent), 2) AS absence_rate,
        ROUND(AVG(vd.won_percentage), 2) AS win_rate,
        ROUND(AVG(vd.rebel_percentage), 2) AS rebel_rate,
        SUM(vd.number_ballots) AS ballot_count,
        
        -- Document productivity
        COUNT(DISTINCT vpd.id) AS document_count
        
    FROM person_data p
    LEFT JOIN view_riksdagen_vote_data_ballot_politician_summary_daily vd
        ON p.id = vd.embedded_id_intressent_id
        AND vd.embedded_id_vote_date >= CURRENT_DATE - INTERVAL '3 years'
    LEFT JOIN view_riksdagen_politician_document vpd
        ON p.id = vpd.person_reference_id
        AND vpd.made_public_date >= CURRENT_DATE - INTERVAL '3 years'
        AND DATE_TRUNC('month', vpd.made_public_date) = DATE_TRUNC('month', vd.embedded_id_vote_date)
    WHERE p.status = 'active'
    GROUP BY p.id, p.first_name, p.last_name, p.party, DATE_TRUNC('month', vd.embedded_id_vote_date)
),
monthly_violations AS (
    SELECT
        reference_id AS person_id,
        DATE_TRUNC('month', detected_date) AS assessment_period,
        COUNT(*) AS violation_count,
        COUNT(DISTINCT rule_group) AS violation_categories,
        STRING_AGG(DISTINCT rule_group, ', ' ORDER BY rule_group) AS violation_types
    FROM rule_violation
    WHERE resource_type = 'POLITICIAN'
        AND status = 'ACTIVE'
        AND detected_date >= CURRENT_DATE - INTERVAL '3 years'
    GROUP BY reference_id, DATE_TRUNC('month', detected_date)
),
risk_calculations AS (
    SELECT
        mrb.person_id,
        mrb.first_name,
        mrb.last_name,
        mrb.party,
        mrb.assessment_period,
        mrb.absence_rate,
        mrb.win_rate,
        mrb.rebel_rate,
        mrb.ballot_count,
        mrb.document_count,
        COALESCE(mv.violation_count, 0) AS violation_count,
        COALESCE(mv.violation_categories, 0) AS violation_categories,
        COALESCE(mv.violation_types, '') AS violation_types,
        
        -- Calculate risk score using CIA platform methodology
        ROUND(
            LEAST(COALESCE(mv.violation_count, 0) * 2, 40) +
            (COALESCE(mrb.absence_rate, 0) * 20 / 100.0) +
            ((100 - COALESCE(mrb.win_rate, 50)) * 20 / 100.0) +
            (COALESCE(mrb.rebel_rate, 0) * 10 / 100.0) +
            CASE WHEN mrb.document_count < 5 THEN 10 ELSE 0 END
        , 2) AS calculated_risk_score,
        
        -- Previous period values for trend
        LAG(
            ROUND(
                LEAST(COALESCE(mv.violation_count, 0) * 2, 40) +
                (COALESCE(mrb.absence_rate, 0) * 20 / 100.0) +
                ((100 - COALESCE(mrb.win_rate, 50)) * 20 / 100.0) +
                (COALESCE(mrb.rebel_rate, 0) * 10 / 100.0) +
                CASE WHEN mrb.document_count < 5 THEN 10 ELSE 0 END
            , 2)
        , 1) OVER (PARTITION BY mrb.person_id ORDER BY mrb.assessment_period) AS prev_risk_score
        
    FROM monthly_risk_base mrb
    LEFT JOIN monthly_violations mv 
        ON mrb.person_id = mv.person_id 
        AND mrb.assessment_period = mv.assessment_period
    WHERE mrb.ballot_count >= 5  -- Minimum activity threshold
)
SELECT
    person_id,
    first_name,
    last_name,
    party,
    assessment_period,
    DATE_TRUNC('month', assessment_period + INTERVAL '1 month' - INTERVAL '1 day') AS assessment_period_end,
    absence_rate,
    win_rate,
    rebel_rate,
    ballot_count,
    document_count,
    violation_count,
    violation_categories,
    violation_types,
    calculated_risk_score AS risk_score,
    prev_risk_score,
    
    -- Risk change metrics
    ROUND(calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score), 2) AS risk_score_change,
    
    CASE
        WHEN calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) >= 10 
            THEN 'SIGNIFICANT_INCREASE'
        WHEN calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) >= 5 
            THEN 'MODERATE_INCREASE'
        WHEN calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) > 0 
            THEN 'SLIGHT_INCREASE'
        WHEN calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) <= -10 
            THEN 'SIGNIFICANT_DECREASE'
        WHEN calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) <= -5 
            THEN 'MODERATE_DECREASE'
        WHEN calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) < 0 
            THEN 'SLIGHT_DECREASE'
        ELSE 'STABLE'
    END AS risk_trend,
    
    -- Severity classification
    CASE
        WHEN calculated_risk_score >= 70 THEN 'CRITICAL'
        WHEN calculated_risk_score >= 50 THEN 'HIGH'
        WHEN calculated_risk_score >= 30 THEN 'MODERATE'
        WHEN calculated_risk_score >= 15 THEN 'LOW'
        ELSE 'MINIMAL'
    END AS risk_severity,
    
    CASE
        WHEN COALESCE(prev_risk_score, 0) > 0 THEN
            CASE
                WHEN prev_risk_score < 30 AND calculated_risk_score >= 30 THEN 'ESCALATION_TO_MODERATE'
                WHEN prev_risk_score < 50 AND calculated_risk_score >= 50 THEN 'ESCALATION_TO_HIGH'
                WHEN prev_risk_score < 70 AND calculated_risk_score >= 70 THEN 'ESCALATION_TO_CRITICAL'
                WHEN prev_risk_score >= 70 AND calculated_risk_score < 70 THEN 'DEESCALATION_FROM_CRITICAL'
                WHEN prev_risk_score >= 50 AND calculated_risk_score < 50 THEN 'DEESCALATION_FROM_HIGH'
                WHEN prev_risk_score >= 30 AND calculated_risk_score < 30 THEN 'DEESCALATION_FROM_MODERATE'
                ELSE 'NO_SEVERITY_TRANSITION'
            END
        ELSE 'INITIAL_ASSESSMENT'
    END AS severity_transition,
    
    -- Intelligence assessment
    CASE
        WHEN calculated_risk_score >= 70 
            THEN 'CRITICAL: Immediate attention required'
        WHEN calculated_risk_score >= 50 AND calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) >= 5
            THEN 'HIGH RISK: Escalating trend detected'
        WHEN calculated_risk_score >= 50
            THEN 'HIGH RISK: Monitor closely'
        WHEN calculated_risk_score >= 30 AND calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) >= 10
            THEN 'MODERATE RISK: Rapid escalation warning'
        WHEN calculated_risk_score >= 30
            THEN 'MODERATE RISK: Standard monitoring'
        WHEN prev_risk_score >= 50 AND calculated_risk_score < 30
            THEN 'IMPROVING: Effective risk mitigation'
        ELSE 'LOW RISK: Normal operations'
    END AS risk_assessment
    
FROM risk_calculations
ORDER BY person_id, assessment_period DESC;
        ]]>
    </createView>
</changeSet>

<!-- ========================================================================= -->
<!-- 4. COMMITTEE PRODUCTIVITY MATRIX VIEW                                     -->
<!-- Intelligence Value: HIGH - Legislative effectiveness monitoring           -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="osint-2025111504-committee-productivity-matrix" failOnError="true">
    <comment>
        Committee Productivity Matrix View
        
        Intelligence Purpose:
        - Monitor committee output and effectiveness by period
        - Benchmark committee performance against historical data
        - Identify productive vs. underperforming committees
        - Track legislative workflow efficiency
        
        Use Cases:
        - Committee effectiveness assessment
        - Resource allocation optimization
        - Legislative process monitoring
        - Institutional performance tracking
        
        RISK_RULES_INTOP_OSINT.md Support:
        - Rule C-01 to C-04: Committee performance monitoring
        - Comparative Analysis: Cross-committee benchmarking
        - Temporal Analysis: Productivity trends over time
    </comment>
    
    <createView viewName="view_committee_productivity_matrix">
        <![CDATA[
WITH committee_documents AS (
    SELECT
        org AS committee_code,
        DATE_TRUNC('quarter', made_public_date) AS period_start,
        COUNT(*) AS total_documents,
        COUNT(DISTINCT CASE WHEN document_type = 'UtskottsbetÃ¤nkande' THEN doc_id END) AS committee_reports,
        COUNT(DISTINCT CASE WHEN document_type = 'Motion' THEN doc_id END) AS motions_handled,
        COUNT(DISTINCT person_reference_id) AS active_members,
        MIN(made_public_date) AS first_document_date,
        MAX(made_public_date) AS last_document_date
    FROM view_riksdagen_politician_document
    WHERE made_public_date >= CURRENT_DATE - INTERVAL '3 years'
        AND org IS NOT NULL
        AND org LIKE '%U'  -- Committee codes end with 'U'
    GROUP BY org, DATE_TRUNC('quarter', made_public_date)
),
committee_info AS (
    SELECT DISTINCT
        org_code AS committee_code,
        org AS committee_name,
        detail AS committee_category
    FROM view_riksdagen_committee
    WHERE org_code IS NOT NULL
),
productivity_benchmarks AS (
    SELECT
        period_start,
        AVG(total_documents) AS avg_documents_per_committee,
        STDDEV(total_documents) AS stddev_documents,
        MAX(total_documents) AS max_documents,
        MIN(total_documents) AS min_documents,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY total_documents) AS median_documents
    FROM committee_documents
    GROUP BY period_start
),
productivity_analysis AS (
    SELECT
        cd.committee_code,
        ci.committee_name,
        ci.committee_category,
        cd.period_start,
        cd.total_documents,
        cd.committee_reports,
        cd.motions_handled,
        cd.active_members,
        cd.first_document_date,
        cd.last_document_date,
        pb.avg_documents_per_committee,
        pb.median_documents,
        pb.max_documents,
        pb.min_documents,
        
        -- Previous period for trend
        LAG(cd.total_documents, 1) OVER (PARTITION BY cd.committee_code ORDER BY cd.period_start) AS prev_documents,
        LAG(cd.active_members, 1) OVER (PARTITION BY cd.committee_code ORDER BY cd.period_start) AS prev_members,
        
        -- 4-quarter moving average
        ROUND(AVG(cd.total_documents) OVER (
            PARTITION BY cd.committee_code 
            ORDER BY cd.period_start 
            ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
        ), 2) AS ma_4quarter_documents
        
    FROM committee_documents cd
    LEFT JOIN committee_info ci ON cd.committee_code = ci.committee_code
    LEFT JOIN productivity_benchmarks pb ON cd.period_start = pb.period_start
)
SELECT
    committee_code,
    committee_name,
    committee_category,
    period_start,
    DATE_TRUNC('quarter', period_start + INTERVAL '3 months' - INTERVAL '1 day') AS period_end,
    EXTRACT(YEAR FROM period_start) AS year,
    EXTRACT(QUARTER FROM period_start) AS quarter,
    total_documents,
    committee_reports,
    motions_handled,
    active_members,
    
    -- Productivity metrics
    ROUND(CAST(total_documents AS NUMERIC) / NULLIF(active_members, 0), 2) AS documents_per_member,
    ROUND(CAST(committee_reports AS NUMERIC) / NULLIF(active_members, 0), 2) AS reports_per_member,
    
    -- Trend indicators
    total_documents - COALESCE(prev_documents, total_documents) AS document_change,
    ROUND(
        (CAST(total_documents - COALESCE(prev_documents, total_documents) AS NUMERIC) / 
        NULLIF(prev_documents, 0)) * 100, 2
    ) AS document_change_pct,
    
    -- Moving average
    ma_4quarter_documents,
    
    -- Benchmarking
    ROUND(avg_documents_per_committee, 2) AS period_avg_documents,
    ROUND(median_documents, 2) AS period_median_documents,
    max_documents AS period_max_documents,
    min_documents AS period_min_documents,
    
    ROUND(total_documents - avg_documents_per_committee, 2) AS vs_average,
    ROUND(
        ((CAST(total_documents AS NUMERIC) / NULLIF(avg_documents_per_committee, 0)) - 1) * 100, 2
    ) AS vs_average_pct,
    
    -- Performance classification
    CASE
        WHEN total_documents >= avg_documents_per_committee * 1.5 THEN 'HIGHLY_PRODUCTIVE'
        WHEN total_documents >= avg_documents_per_committee * 1.2 THEN 'ABOVE_AVERAGE'
        WHEN total_documents >= avg_documents_per_committee * 0.8 THEN 'AVERAGE'
        WHEN total_documents >= avg_documents_per_committee * 0.5 THEN 'BELOW_AVERAGE'
        ELSE 'UNDERPERFORMING'
    END AS productivity_level,
    
    CASE
        WHEN total_documents - COALESCE(prev_documents, total_documents) >= 10 THEN 'STRONG_INCREASE'
        WHEN total_documents - COALESCE(prev_documents, total_documents) >= 5 THEN 'MODERATE_INCREASE'
        WHEN total_documents - COALESCE(prev_documents, total_documents) > 0 THEN 'SLIGHT_INCREASE'
        WHEN total_documents - COALESCE(prev_documents, total_documents) <= -10 THEN 'STRONG_DECREASE'
        WHEN total_documents - COALESCE(prev_documents, total_documents) <= -5 THEN 'MODERATE_DECREASE'
        WHEN total_documents - COALESCE(prev_documents, total_documents) < 0 THEN 'SLIGHT_DECREASE'
        ELSE 'STABLE'
    END AS productivity_trend,
    
    -- Intelligence assessment
    CASE
        WHEN total_documents >= avg_documents_per_committee * 1.5 AND active_members >= 10
            THEN 'Exceptional committee productivity and engagement'
        WHEN total_documents >= avg_documents_per_committee * 1.2
            THEN 'Above-average committee performance'
        WHEN total_documents < avg_documents_per_committee * 0.5
            THEN 'Committee productivity concerns - investigation recommended'
        WHEN total_documents - COALESCE(prev_documents, total_documents) <= -10
            THEN 'Significant productivity decline detected'
        ELSE 'Standard committee operations'
    END AS productivity_assessment,
    
    first_document_date,
    last_document_date,
    EXTRACT(DAY FROM (last_document_date - first_document_date)) AS activity_span_days
    
FROM productivity_analysis
WHERE committee_code IS NOT NULL
ORDER BY period_start DESC, total_documents DESC;
        ]]>
    </createView>
</changeSet>

<!-- ========================================================================= -->
<!-- 5. PERFORMANCE INDEXES                                                    -->
<!-- Optimize query performance for OSINT intelligence operations              -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="osint-2025111505-performance-indexes" failOnError="true">
    <comment>
        Performance Indexes for OSINT Intelligence Queries
        
        These indexes optimize the most common temporal queries used in
        intelligence analysis and dashboard operations.
    </comment>
    
    <sql>
        -- Index for politician behavioral trends time-range queries
        CREATE INDEX IF NOT EXISTS idx_vote_summary_daily_date_person 
            ON view_riksdagen_vote_data_ballot_politician_summary_daily(embedded_id_vote_date DESC, embedded_id_intressent_id);
        
        -- Index for rule violation temporal queries
        CREATE INDEX IF NOT EXISTS idx_rule_violation_date_resource 
            ON rule_violation(detected_date DESC, reference_id, resource_type) 
            WHERE status = 'ACTIVE';
        
        -- Index for document temporal queries
        CREATE INDEX IF NOT EXISTS idx_politician_document_date_org 
            ON view_riksdagen_politician_document(made_public_date DESC, org, party_short_code);
    </sql>
</changeSet>

</databaseChangeLog>
