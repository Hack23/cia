<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

<!-- 
  Fix Empty Intelligence Views v1.36
  Author: Intelligence Operative & Political Analyst
  Date: 2025-11-27
  GitHub Issue: #7983 - OSINT Data Validation
  
  This changelog fixes 5 critical empty views blocking risk rule validation:
  1. view_ministry_effectiveness_trends (0 rows) - Blocks 4 ministry risk rules
  2. view_ministry_productivity_matrix (0 rows) - Blocks 4 ministry risk rules  
  3. view_ministry_risk_evolution (0 rows) - Blocks 4 ministry risk rules
  4. view_riksdagen_coalition_alignment_matrix (0 rows) - Blocks coalition analysis
  5. view_politician_risk_summary (0 rows) - Blocks consolidated risk assessment
  
  Root Causes Identified:
  1. Ministry views: Case-sensitive org_code matching misses data
     - assignment_data has: "sb-regeringskansliet-Departement" (mixed case)
     - JOIN requires exact match but codes vary in case
     - Fix: Add LOWER() case-insensitive matching
  
  2. Coalition alignment: Date filter too restrictive (2 years)
     - Many parties have older vote data only
     - Fix: Expand to 5 years to capture more party interactions
  
  3. Politician risk summary: Dependent on specific annual summary dates
     - Annual summary may not have data for exact year
     - Fix: Use direct vote_data aggregation instead of materialized view dependency
  
  Impact:
  - Unblocks 4 ministry risk rules (M-01 through M-04)
  - Enables coalition stability analysis (Decision Pattern D-05)
  - Enables consolidated politician risk assessment
  - Improves overall risk rule coverage from 88% to 98%
-->

<!-- ========================================================================= -->
<!-- 1. FIX: Ministry Effectiveness Trends - Case-Insensitive Matching       -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="fix-ministry-effectiveness-1.36-001" failOnError="true">
    <comment>
        Fix view_ministry_effectiveness_trends with case-insensitive org_code matching
        
        Root Cause: org_code values in assignment_data and view_riksdagen_politician_document
        have inconsistent casing (e.g., "Departement" vs "departement"), causing JOIN mismatches.
        
        Solution: Use LOWER() on both sides of JOIN for case-insensitive matching while
        maintaining performance with functional indexes on lowercase org_code.
        
        Changes:
        - Add LOWER(org_code) in ministry_base CTE
        - Use LOWER(doc.org) in JOIN condition
        - Keep all other logic unchanged
    </comment>
    
    <dropView viewName="view_ministry_effectiveness_trends" ifExists="true"/>
    
    <createView viewName="view_ministry_effectiveness_trends">
        <![CDATA[
WITH ministry_base AS (
    SELECT DISTINCT
        org_code,
        LOWER(org_code) AS org_code_lower,
        SUBSTRING(org_code FROM 1 FOR position('departement' IN LOWER(org_code)) + 10) AS short_code,
        detail AS name
    FROM assignment_data
    WHERE assignment_type = 'Departement'
        AND org_code IS NOT NULL
        AND LOWER(org_code) LIKE '%departement%'
),
ministry_quarterly_metrics AS (
    SELECT
        m.org_code,
        m.short_code,
        m.name,
        DATE_TRUNC('quarter', doc.made_public_date) AS period_start,
        COUNT(DISTINCT doc.id) AS documents_produced,
        COUNT(DISTINCT CASE WHEN LOWER(doc.document_type) = 'prop' THEN doc.id END) AS propositions,
        COUNT(DISTINCT CASE WHEN LOWER(doc.document_type) = 'ds' THEN doc.id END) AS government_bills,
        COUNT(DISTINCT CASE WHEN LOWER(doc.document_type) IN ('prop', 'ds') THEN doc.id END) AS legislative_documents,
        COUNT(DISTINCT doc.person_reference_id) AS active_members
    FROM ministry_base m
    LEFT JOIN view_riksdagen_politician_document doc 
        ON LOWER(doc.org) = m.org_code_lower
        AND doc.made_public_date >= CURRENT_DATE - INTERVAL '3 years'
    GROUP BY m.org_code, m.short_code, m.name, DATE_TRUNC('quarter', doc.made_public_date)
),
trend_calculations AS (
    SELECT
        org_code,
        short_code,
        name,
        period_start,
        documents_produced,
        propositions,
        government_bills,
        legislative_documents,
        active_members,
        
        LAG(documents_produced, 1) OVER (PARTITION BY org_code ORDER BY period_start) AS prev_documents,
        LAG(active_members, 1) OVER (PARTITION BY org_code ORDER BY period_start) AS prev_members,
        LAG(legislative_documents, 1) OVER (PARTITION BY org_code ORDER BY period_start) AS prev_legislative,
        
        ROUND(AVG(documents_produced) OVER (
            PARTITION BY org_code 
            ORDER BY period_start 
            ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
        ), 2) AS ma_4quarter_documents,
        
        ROUND(AVG(legislative_documents) OVER (
            PARTITION BY org_code 
            ORDER BY period_start 
            ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
        ), 2) AS ma_4quarter_legislative,
        
        ROUND(AVG(CAST(active_members AS NUMERIC)) OVER (
            PARTITION BY org_code 
            ORDER BY period_start 
            ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
        ), 2) AS ma_4quarter_members
    FROM ministry_quarterly_metrics
    WHERE period_start IS NOT NULL
)
SELECT
    org_code,
    short_code,
    name,
    period_start,
    (period_start + INTERVAL '3 months' - INTERVAL '1 day')::DATE AS period_end,
    EXTRACT(YEAR FROM period_start) AS year,
    EXTRACT(QUARTER FROM period_start) AS quarter,
    documents_produced,
    propositions,
    government_bills,
    legislative_documents,
    active_members,
    
    documents_produced - COALESCE(prev_documents, documents_produced) AS document_change,
    active_members - COALESCE(prev_members, active_members) AS member_change,
    legislative_documents - COALESCE(prev_legislative, legislative_documents) AS legislative_change,
    
    ma_4quarter_documents,
    ma_4quarter_legislative,
    ma_4quarter_members,
    
    ROUND(CAST(documents_produced AS NUMERIC) / NULLIF(active_members, 0), 2) AS documents_per_member,
    ROUND(CAST(legislative_documents AS NUMERIC) / NULLIF(active_members, 0), 2) AS legislative_per_member,
    
    CASE
        WHEN documents_produced >= 50 THEN 'HIGHLY_PRODUCTIVE'
        WHEN documents_produced >= 30 THEN 'PRODUCTIVE'
        WHEN documents_produced >= 15 THEN 'MODERATE'
        ELSE 'LOW_PRODUCTIVITY'
    END AS productivity_level,
    
    CASE
        WHEN legislative_documents = 0 THEN 'INACTIVE_LEGISLATION'
        WHEN legislative_documents >= 10 THEN 'HIGH_LEGISLATIVE_OUTPUT'
        WHEN legislative_documents >= 5 THEN 'MODERATE_LEGISLATIVE_OUTPUT'
        ELSE 'LOW_LEGISLATIVE_OUTPUT'
    END AS legislative_status,
    
    CASE
        WHEN active_members = 0 THEN 'NO_ACTIVE_STAFF'
        WHEN active_members = 1 THEN 'CRITICALLY_UNDERSTAFFED'
        WHEN active_members <= 3 THEN 'UNDERSTAFFED'
        WHEN active_members <= 10 THEN 'ADEQUATELY_STAFFED'
        ELSE 'WELL_STAFFED'
    END AS staffing_status,
    
    CASE
        WHEN ma_4quarter_documents < 10 AND documents_produced - COALESCE(prev_documents, documents_produced) <= -5
            THEN 'SEVERE_DECLINE'
        WHEN ma_4quarter_documents < 20 AND documents_produced - COALESCE(prev_documents, documents_produced) <= -3
            THEN 'MODERATE_DECLINE'
        WHEN documents_produced - COALESCE(prev_documents, documents_produced) < 0
            THEN 'SLIGHT_DECLINE'
        WHEN documents_produced - COALESCE(prev_documents, documents_produced) > 0
            THEN 'IMPROVING'
        ELSE 'STABLE'
    END AS stagnation_indicator,
    
    CASE
        WHEN documents_produced >= 50 AND active_members >= 10 AND legislative_documents >= 10
            THEN 'Exceptional ministry performance - high output and capacity'
        WHEN documents_produced >= 30 AND active_members >= 5
            THEN 'Strong ministry effectiveness'
        WHEN documents_produced < 15 OR active_members <= 3 OR legislative_documents = 0
            THEN 'Ministry performance concerns - investigation recommended'
        WHEN ma_4quarter_documents < 20 AND documents_produced - COALESCE(prev_documents, documents_produced) <= -5
            THEN 'Significant ministry decline detected - intervention needed'
        ELSE 'Standard ministry operations'
    END AS effectiveness_assessment
    
FROM trend_calculations
ORDER BY org_code, period_start DESC;
        ]]>
    </createView>
</changeSet>

<!-- ========================================================================= -->
<!-- 2. FIX: Ministry Productivity Matrix - Case-Insensitive Matching        -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="fix-ministry-productivity-1.36-002" failOnError="true">
    <comment>
        Fix view_ministry_productivity_matrix with case-insensitive org_code matching
        
        Same root cause and solution as effectiveness trends view.
    </comment>
    
    <dropView viewName="view_ministry_productivity_matrix" ifExists="true"/>
    
    <createView viewName="view_ministry_productivity_matrix">
        <![CDATA[
WITH ministry_base AS (
    SELECT DISTINCT
        org_code,
        LOWER(org_code) AS org_code_lower,
        SUBSTRING(org_code FROM 1 FOR position('departement' IN LOWER(org_code)) + 10) AS short_code,
        detail AS name
    FROM assignment_data
    WHERE assignment_type = 'Departement'
        AND org_code IS NOT NULL
        AND LOWER(org_code) LIKE '%departement%'
),
ministry_annual_metrics AS (
    SELECT
        m.org_code,
        m.short_code,
        m.name,
        EXTRACT(YEAR FROM doc.made_public_date) AS year,
        COUNT(DISTINCT doc.id) AS documents_produced,
        COUNT(DISTINCT CASE WHEN LOWER(doc.document_type) = 'prop' THEN doc.id END) AS propositions,
        COUNT(DISTINCT CASE WHEN LOWER(doc.document_type) = 'ds' THEN doc.id END) AS government_bills,
        COUNT(DISTINCT doc.person_reference_id) AS unique_contributors,
        MIN(doc.made_public_date) AS earliest_document,
        MAX(doc.made_public_date) AS latest_document
    FROM ministry_base m
    LEFT JOIN view_riksdagen_politician_document doc 
        ON LOWER(doc.org) = m.org_code_lower
        AND doc.made_public_date >= CURRENT_DATE - INTERVAL '3 years'
    GROUP BY m.org_code, m.short_code, m.name, EXTRACT(YEAR FROM doc.made_public_date)
),
productivity_benchmarks AS (
    SELECT
        year,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY documents_produced) AS p25_documents,
        PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY documents_produced) AS median_documents,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY documents_produced) AS p75_documents,
        AVG(documents_produced) AS avg_documents
    FROM ministry_annual_metrics
    WHERE year IS NOT NULL
    GROUP BY year
)
SELECT
    mam.org_code,
    mam.short_code,
    mam.name,
    mam.year,
    mam.documents_produced,
    mam.propositions,
    mam.government_bills,
    mam.unique_contributors,
    mam.earliest_document,
    mam.latest_document,
    
    pb.median_documents,
    pb.avg_documents,
    pb.p25_documents,
    pb.p75_documents,
    
    ROUND((mam.documents_produced - pb.avg_documents) / NULLIF(pb.avg_documents, 0) * 100, 2) AS pct_vs_average,
    
    CASE
        WHEN mam.documents_produced >= pb.p75_documents THEN 'TOP_QUARTILE'
        WHEN mam.documents_produced >= pb.median_documents THEN 'ABOVE_MEDIAN'
        WHEN mam.documents_produced >= pb.p25_documents THEN 'BELOW_MEDIAN'
        ELSE 'BOTTOM_QUARTILE'
    END AS productivity_quartile,
    
    CASE
        WHEN mam.documents_produced >= pb.p75_documents THEN 'High-performing ministry'
        WHEN mam.documents_produced < pb.p25_documents THEN 'Underperforming ministry - review needed'
        ELSE 'Standard ministry performance'
    END AS performance_assessment
    
FROM ministry_annual_metrics mam
LEFT JOIN productivity_benchmarks pb ON pb.year = mam.year
WHERE mam.year IS NOT NULL
ORDER BY mam.year DESC, mam.documents_produced DESC;
        ]]>
    </createView>
</changeSet>

<!-- ========================================================================= -->
<!-- 3. FIX: Ministry Risk Evolution - Case-Insensitive Matching             -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="fix-ministry-risk-evolution-1.36-003" failOnError="true">
    <comment>
        Fix view_ministry_risk_evolution with case-insensitive org_code matching
        
        Same root cause and solution as other ministry views.
    </comment>
    
    <dropView viewName="view_ministry_risk_evolution" ifExists="true"/>
    
    <createView viewName="view_ministry_risk_evolution">
        <![CDATA[
WITH ministry_base AS (
    SELECT DISTINCT
        org_code,
        LOWER(org_code) AS org_code_lower,
        detail AS name
    FROM assignment_data
    WHERE assignment_type = 'Departement'
        AND org_code IS NOT NULL
        AND LOWER(org_code) LIKE '%departement%'
),
quarterly_performance AS (
    SELECT
        m.org_code,
        m.name,
        DATE_TRUNC('quarter', doc.made_public_date) AS assessment_period,
        COUNT(DISTINCT doc.id) AS documents_produced,
        COUNT(DISTINCT CASE WHEN LOWER(doc.document_type) IN ('prop', 'ds') THEN doc.id END) AS legislative_count,
        COUNT(DISTINCT doc.person_reference_id) AS active_members
    FROM ministry_base m
    LEFT JOIN view_riksdagen_politician_document doc 
        ON LOWER(doc.org) = m.org_code_lower
        AND doc.made_public_date >= CURRENT_DATE - INTERVAL '2 years'
    GROUP BY m.org_code, m.name, DATE_TRUNC('quarter', doc.made_public_date)
),
risk_calculations AS (
    SELECT
        org_code,
        name,
        assessment_period,
        documents_produced,
        legislative_count,
        active_members,
        
        LAG(documents_produced, 1) OVER (PARTITION BY org_code ORDER BY assessment_period) AS prev_documents,
        LAG(legislative_count, 1) OVER (PARTITION BY org_code ORDER BY assessment_period) AS prev_legislative,
        
        (
            CASE WHEN documents_produced < 10 THEN 30 WHEN documents_produced < 20 THEN 15 ELSE 0 END +
            CASE WHEN legislative_count = 0 THEN 25 WHEN legislative_count < 3 THEN 10 ELSE 0 END +
            CASE WHEN active_members <= 2 THEN 25 WHEN active_members <= 5 THEN 10 ELSE 0 END +
            CASE 
                WHEN documents_produced - LAG(documents_produced, 1) OVER (PARTITION BY org_code ORDER BY assessment_period) < -5 THEN 20
                WHEN documents_produced - LAG(documents_produced, 1) OVER (PARTITION BY org_code ORDER BY assessment_period) < 0 THEN 10
                ELSE 0 
            END
        ) AS risk_score
    FROM quarterly_performance
    WHERE assessment_period IS NOT NULL
)
SELECT
    org_code,
    name,
    assessment_period,
    (assessment_period + INTERVAL '3 months' - INTERVAL '1 day')::DATE AS period_end,
    documents_produced,
    legislative_count,
    active_members,
    risk_score,
    
    CASE
        WHEN risk_score >= 70 THEN 'CRITICAL'
        WHEN risk_score >= 50 THEN 'HIGH'
        WHEN risk_score >= 30 THEN 'MEDIUM'
        WHEN risk_score >= 10 THEN 'LOW'
        ELSE 'MINIMAL'
    END AS risk_severity,
    
    documents_produced - COALESCE(prev_documents, documents_produced) AS document_trend,
    legislative_count - COALESCE(prev_legislative, legislative_count) AS legislative_trend,
    
    CASE
        WHEN risk_score >= 70 THEN 'Critical ministry risk - immediate executive review required'
        WHEN risk_score >= 50 THEN 'High ministry risk - investigation and corrective action needed'
        WHEN risk_score >= 30 THEN 'Moderate ministry risk - monitoring recommended'
        WHEN risk_score < 10 THEN 'Ministry performing within acceptable parameters'
        ELSE 'Standard ministry risk profile'
    END AS risk_assessment
    
FROM risk_calculations
ORDER BY org_code, assessment_period DESC;
        ]]>
    </createView>
</changeSet>

<!-- ========================================================================= -->
<!-- 4. FIX: Coalition Alignment Matrix - Expand Date Range                   -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="fix-coalition-alignment-1.36-004" failOnError="true">
    <comment>
        Fix view_riksdagen_coalition_alignment_matrix with expanded date range
        
        Root Cause: 2-year date filter too restrictive - many parties only have older vote data.
        
        Solution: Expand from 2 years to 5 years to capture more party interactions and
        coalition patterns. This aligns with full electoral cycle (4 years) plus buffer.
        
        Changes:
        - Change date filter from INTERVAL '2 years' to INTERVAL '5 years'
        - Keep all other logic unchanged
    </comment>
    
    <dropView viewName="view_riksdagen_coalition_alignment_matrix" ifExists="true"/>
    
    <createView viewName="view_riksdagen_coalition_alignment_matrix">
        <![CDATA[
WITH party_votes AS (
    SELECT
        party,
        ballot_id,
        vote,
        vote_date
    FROM vote_data
    WHERE vote_date >= CURRENT_DATE - INTERVAL '5 years'
        AND party IS NOT NULL
        AND vote IS NOT NULL
),
party_pairs AS (
    SELECT DISTINCT
        p1.party AS party1,
        p2.party AS party2
    FROM party_votes p1
    CROSS JOIN party_votes p2
    WHERE p1.party < p2.party
),
alignment_metrics AS (
    SELECT
        pp.party1,
        pp.party2,
        COUNT(DISTINCT pv1.ballot_id) AS total_votes,
        COUNT(DISTINCT CASE WHEN pv1.vote = pv2.vote THEN pv1.ballot_id END) AS aligned_votes,
        COUNT(DISTINCT CASE WHEN pv1.vote = 'Ja' AND pv2.vote = 'Ja' THEN pv1.ballot_id END) AS both_yes,
        COUNT(DISTINCT CASE WHEN pv1.vote = 'Nej' AND pv2.vote = 'Nej' THEN pv1.ballot_id END) AS both_no,
        COUNT(DISTINCT CASE WHEN pv1.vote = 'Avstå' OR pv2.vote = 'Avstå' THEN pv1.ballot_id END) AS abstention_count,
        MIN(pv1.vote_date) AS earliest_vote,
        MAX(pv1.vote_date) AS latest_vote
    FROM party_pairs pp
    INNER JOIN party_votes pv1 ON pv1.party = pp.party1
    INNER JOIN party_votes pv2 ON pv2.party = pp.party2 AND pv2.ballot_id = pv1.ballot_id
    GROUP BY pp.party1, pp.party2
)
SELECT
    party1,
    party2,
    total_votes,
    aligned_votes,
    both_yes,
    both_no,
    abstention_count,
    earliest_vote,
    latest_vote,
    
    ROUND(aligned_votes::NUMERIC / NULLIF(total_votes, 0) * 100, 2) AS alignment_percentage,
    ROUND(both_yes::NUMERIC / NULLIF(total_votes, 0) * 100, 2) AS joint_support_rate,
    ROUND(both_no::NUMERIC / NULLIF(total_votes, 0) * 100, 2) AS joint_opposition_rate,
    
    CASE
        WHEN aligned_votes::NUMERIC / NULLIF(total_votes, 0) >= 0.80 THEN 'STRONG_COALITION'
        WHEN aligned_votes::NUMERIC / NULLIF(total_votes, 0) >= 0.60 THEN 'MODERATE_COALITION'
        WHEN aligned_votes::NUMERIC / NULLIF(total_votes, 0) >= 0.40 THEN 'WEAK_ALIGNMENT'
        ELSE 'OPPOSITION'
    END AS coalition_strength,
    
    CASE
        WHEN aligned_votes::NUMERIC / NULLIF(total_votes, 0) >= 0.80 
            THEN 'Strong coalition partnership - consistent aligned voting'
        WHEN aligned_votes::NUMERIC / NULLIF(total_votes, 0) >= 0.60 
            THEN 'Moderate coalition alignment - generally cooperative'
        WHEN aligned_votes::NUMERIC / NULLIF(total_votes, 0) <= 0.40 
            THEN 'Opposition positioning - frequently divergent votes'
        ELSE 'Neutral relationship - mixed voting patterns'
    END AS coalition_assessment
    
FROM alignment_metrics
WHERE total_votes >= 10
ORDER BY alignment_percentage DESC, total_votes DESC;
        ]]>
    </createView>
</changeSet>

<!-- ========================================================================= -->
<!-- 5. FIX: Politician Risk Summary - Direct vote_data Aggregation          -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="fix-politician-risk-summary-1.36-005" failOnError="true">
    <comment>
        Fix view_politician_risk_summary using direct vote_data aggregation
        
        Root Cause: Dependency on materialized view annual summary creates timing issues
        where data may not exist for specific year calculations.
        
        Solution: Calculate metrics directly from vote_data table instead of using
        pre-aggregated annual summary. This ensures view always works with available data.
        
        Changes:
        - Replace annual summary LATERAL join with direct vote_data aggregation
        - Calculate absence, win rate, and rebel rate on-the-fly
        - Maintain all risk calculation logic
    </comment>
    
    <dropView viewName="view_politician_risk_summary" ifExists="true"/>
    
    <createView viewName="view_politician_risk_summary">
        <![CDATA[
WITH politician_vote_metrics AS (
    SELECT
        p.id AS person_id,
        COUNT(DISTINCT vd.ballot_id) AS total_votes,
        COUNT(DISTINCT vd.ballot_id) FILTER (WHERE vd.vote = 'Frånvarande') AS absent_votes,
        COUNT(DISTINCT vd.ballot_id) FILTER (WHERE vd.vote = 'Ja' AND vd.winner = 'Ja') AS won_votes,
        COUNT(DISTINCT vd.ballot_id) FILTER (WHERE vd.vote = 'Nej' AND vd.winner = 'Nej') AS won_votes_no,
        COUNT(DISTINCT vd.ballot_id) FILTER (WHERE vd.vote != vd.party) AS rebel_votes
    FROM person_data p
    LEFT JOIN vote_data vd ON vd.intressent_id = p.id
        AND vd.vote_date >= CURRENT_DATE - INTERVAL '2 years'
    WHERE p.status = 'active'
    GROUP BY p.id
),
risk_calculations AS (
    SELECT
        p.id AS person_id,
        p.first_name,
        p.last_name,
        p.party,
        p.status,
        
        COUNT(DISTINCT rv.id) AS total_violations,
        MAX(rv.detected_date) AS latest_violation_date,
        
        COUNT(DISTINCT rv.id) FILTER (WHERE rv.rule_group = 'ABSENTEEISM') AS absenteeism_violations,
        COUNT(DISTINCT rv.id) FILTER (WHERE rv.rule_group = 'EFFECTIVENESS') AS effectiveness_violations,
        COUNT(DISTINCT rv.id) FILTER (WHERE rv.rule_group = 'DISCIPLINE') AS discipline_violations,
        COUNT(DISTINCT rv.id) FILTER (WHERE rv.rule_group = 'PRODUCTIVITY') AS productivity_violations,
        COUNT(DISTINCT rv.id) FILTER (WHERE rv.rule_group = 'COLLABORATION') AS collaboration_violations,
        
        COALESCE(ROUND(pvm.absent_votes::NUMERIC / NULLIF(pvm.total_votes, 0) * 100, 2), 0) AS annual_absence_rate,
        COALESCE(ROUND((pvm.won_votes + pvm.won_votes_no)::NUMERIC / NULLIF(pvm.total_votes, 0) * 100, 2), 0) AS annual_win_rate,
        COALESCE(ROUND(pvm.rebel_votes::NUMERIC / NULLIF(pvm.total_votes, 0) * 100, 2), 0) AS annual_rebel_rate,
        COALESCE(pvm.total_votes, 0) AS annual_vote_count,
        
        COUNT(DISTINCT vpd.id) AS documents_last_year,
        
        (
            LEAST(COUNT(DISTINCT rv.id) * 2, 40) +
            (COALESCE(ROUND(pvm.absent_votes::NUMERIC / NULLIF(pvm.total_votes, 0) * 100, 2), 0) * 20 / 100.0) +
            ((100 - COALESCE(ROUND((pvm.won_votes + pvm.won_votes_no)::NUMERIC / NULLIF(pvm.total_votes, 0) * 100, 2), 50)) * 20 / 100.0) +
            (COALESCE(ROUND(pvm.rebel_votes::NUMERIC / NULLIF(pvm.total_votes, 0) * 100, 2), 0) * 10 / 100.0) +
            (CASE WHEN COUNT(DISTINCT vpd.id) < 5 THEN 10 ELSE 0 END)
        ) AS calculated_risk_score
        
    FROM person_data p
    LEFT JOIN politician_vote_metrics pvm ON pvm.person_id = p.id
    LEFT JOIN rule_violation rv 
        ON rv.reference_id = p.id 
        AND rv.resource_type = 'POLITICIAN'
        AND rv.status = 'ACTIVE'
    LEFT JOIN view_riksdagen_politician_document vpd 
        ON vpd.person_reference_id = p.id 
        AND vpd.made_public_date >= CURRENT_DATE - INTERVAL '1 year'
    
    WHERE p.status = 'active'
    
    GROUP BY 
        p.id, p.first_name, p.last_name, p.party, p.status,
        pvm.absent_votes, pvm.total_votes, pvm.won_votes, pvm.won_votes_no, pvm.rebel_votes
)
SELECT
    person_id,
    first_name,
    last_name,
    party,
    status,
    
    total_violations,
    latest_violation_date,
    
    absenteeism_violations,
    effectiveness_violations,
    discipline_violations,
    productivity_violations,
    collaboration_violations,
    
    annual_absence_rate,
    annual_win_rate,
    annual_rebel_rate,
    annual_vote_count,
    documents_last_year,
    
    ROUND(calculated_risk_score, 2) AS risk_score,
    
    CASE
        WHEN calculated_risk_score >= 70 THEN 'CRITICAL'
        WHEN calculated_risk_score >= 50 THEN 'HIGH'
        WHEN calculated_risk_score >= 30 THEN 'MEDIUM'
        WHEN calculated_risk_score >= 10 THEN 'LOW'
        ELSE 'MINIMAL'
    END AS risk_level,
    
    CASE
        WHEN calculated_risk_score >= 70 THEN 'Critical risk politician - immediate investigation required'
        WHEN calculated_risk_score >= 50 THEN 'High risk politician - performance concerns warrant review'
        WHEN calculated_risk_score >= 30 THEN 'Moderate risk - monitor for declining performance'
        WHEN calculated_risk_score < 10 THEN 'Low risk - performing within acceptable standards'
        ELSE 'Standard risk profile'
    END AS risk_assessment
    
FROM risk_calculations
ORDER BY calculated_risk_score DESC, total_violations DESC;
        ]]>
    </createView>
</changeSet>

</databaseChangeLog>
