<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

<!-- 
===================================================================================
 Database Changelog v1.66 - Network Analysis Framework Performance Indexes
 
 Purpose: Create performance indexes for Network Analysis framework (11 views) 
 based on NETWORK_ANALYSIS_PERFORMANCE_REPORT.md future optimization recommendations.
 
 Current Performance Status: ✅ EXCELLENT
 - All 11 network analysis views demonstrate excellent performance (0.032-0.846ms)
 - Query times are 99.9%+ faster than targets (sub-millisecond to low millisecond)
 
 Index Strategy:
 These indexes are created to support future data growth and enable testing with
 sample data. While current production performance is excellent with small datasets,
 these indexes will benefit development/testing environments and future data volumes.
 
 Framework Components:
 - Coalition Matrix (1 view): view_riksdagen_coalition_alignment_matrix
 - Collaboration Networks (2 views): politician & party collaboration
 - Influence Networks (3 views): politician, party & committee influence metrics
 - Ministry Networks (2 views): collaboration matrix & leadership network
 - Decision Networks (3 views): collaboration patterns & decision alignment
 
 Performance Metrics (Current Production):
 - Simple Network Queries: 0.032-0.151ms (target: < 1s) ✅ 99.98% faster
 - Coalition Matrix: 0.070ms (target: < 2s) ✅ 99.996% faster
 - Complex Graph Traversal: 0.065-0.389ms (target: < 3s) ✅ 99.99% faster
 - Influence Mapping: 0.047-0.846ms (target: < 2.5s) ✅ 99.97% faster
 
 Expected Future Impact (with larger datasets):
 - Co-voting analysis: 10-20% improvement at scale
 - Coalition matrix: 5-10% improvement at scale
 - Materialized view queries: 50-80% improvement after population
 
 Related Issues:
 - GitHub Issue: Hack23/cia#8280 (Network Analysis Framework Fixes)
 - NETWORK_ANALYSIS_PERFORMANCE_REPORT.md (52 KB comprehensive analysis)
 - Issue #8282: Materialized view population (prerequisite for 4 views)
 
 Testing:
 Indexes can be tested with sample data (300 rows) in service.data.impl/sample-data/
===================================================================================
-->

<changeSet id="1.66-intro" author="performance-engineer">
    <comment>
        Database Changelog v1.66 - Network Analysis Framework Performance Indexes
        
        Creates 4 performance indexes for Network Analysis framework to support
        future data growth and enable testing with sample data.
        
        Current Performance: Excellent (sub-millisecond queries)
        Expected Impact: 5-80% improvement with larger datasets and materialized views
        
        Indexes Created:
        1. idx_vote_data_covoting - Co-voting analysis (10-20% improvement at scale)
        2. idx_vote_data_coalition - Coalition matrix (5-10% improvement at scale)  
        3. idx_politician_doc_summary_person_id - Party member queries (50-80% after MV population)
        4. idx_ballot_party_summary_party - Party support queries (50-80% after MV population)
    </comment>
</changeSet>

<!-- 
===================================================================================
 NETWORK ANALYSIS PERFORMANCE INDEXES
 
 The following indexes support network analysis queries and enable testing with
 sample data. While current production performance is excellent, these indexes
 benefit development/testing and prepare for future data volumes.
===================================================================================
-->

<!-- Index 1: Co-Voting Analysis Composite Index -->
<changeSet id="1.66-idx-vote-data-covoting" author="performance-engineer">
    <preConditions onFail="MARK_RAN">
        <tableExists tableName="vote_data"/>
        <not>
            <indexExists indexName="idx_vote_data_covoting"/>
        </not>
    </preConditions>
    <comment>
        Composite index for co-voting analysis in view_riksdagen_politician_influence_metrics.
        
        Supports: Politician influence network analysis, co-voting pair detection
        Expected Impact: 10-20% improvement with larger datasets
        
        Current Status: Excellent performance (0.389ms) maintained, index supports future scale
    </comment>
    <sql>
        CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_vote_data_covoting 
        ON vote_data (embedded_id_ballot_id, embedded_id_intressent_id, vote, vote_date)
        WHERE vote_date >= CURRENT_DATE - INTERVAL '3 years'
          AND vote IN ('Ja', 'Nej');
    </sql>
    <rollback>
        DROP INDEX IF EXISTS idx_vote_data_covoting;
    </rollback>
</changeSet>

<!-- Index 2: Coalition Matrix Composite Index -->
<changeSet id="1.66-idx-vote-data-coalition" author="performance-engineer">
    <preConditions onFail="MARK_RAN">
        <tableExists tableName="vote_data"/>
        <not>
            <indexExists indexName="idx_vote_data_coalition"/>
        </not>
    </preConditions>
    <comment>
        Composite index for coalition matrix in view_riksdagen_coalition_alignment_matrix.
        
        Supports: Party coalition alignment analysis, voting pattern heatmaps
        Expected Impact: 5-10% improvement with larger datasets
        
        Current Status: Excellent performance (0.070ms) maintained, index supports future scale
    </comment>
    <sql>
        CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_vote_data_coalition
        ON vote_data (party, embedded_id_ballot_id, vote, vote_date)
        WHERE vote_date >= CURRENT_DATE - INTERVAL '5 years'
          AND party IS NOT NULL;
    </sql>
    <rollback>
        DROP INDEX IF EXISTS idx_vote_data_coalition;
    </rollback>
</changeSet>

<!-- Index 3: Politician Document Summary Index (After Materialized View Population) -->
<changeSet id="1.66-idx-politician-doc-summary" author="performance-engineer">
    <preConditions onFail="MARK_RAN">
        <!-- Only create after materialized view exists and is populated -->
        <sqlCheck expectedResult="1">
            SELECT CASE 
                WHEN EXISTS (
                    SELECT 1 FROM pg_matviews 
                    WHERE schemaname = 'public' 
                    AND matviewname = 'view_riksdagen_politician_document_summary'
                    AND ispopulated = true
                ) THEN 1 
                ELSE 0 
            END;
        </sqlCheck>
        <not>
            <indexExists indexName="idx_politician_doc_summary_person_id"/>
        </not>
    </preConditions>
    <comment>
        Index on materialized view for party member queries (after population).
        
        Supports: view_riksdagen_party_member queries
        Expected Impact: 50-80% improvement in party member queries
        
        Prerequisite: Materialized view must be populated first (Issue #8282)
        Current Status: Awaiting materialized view population
    </comment>
    <sql>
        CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_politician_doc_summary_person_id 
        ON view_riksdagen_politician_document_summary(person_id);
    </sql>
    <rollback>
        DROP INDEX IF EXISTS idx_politician_doc_summary_person_id;
    </rollback>
</changeSet>

<!-- Index 4: Ballot Party Summary Index (After Materialized View Population) -->
<changeSet id="1.66-idx-ballot-party-summary" author="performance-engineer">
    <preConditions onFail="MARK_RAN">
        <!-- Only create after materialized view exists and is populated -->
        <sqlCheck expectedResult="1">
            SELECT CASE 
                WHEN EXISTS (
                    SELECT 1 FROM pg_matviews 
                    WHERE schemaname = 'public' 
                    AND matviewname = 'view_riksdagen_vote_data_ballot_party_summary'
                    AND ispopulated = true
                ) THEN 1 
                ELSE 0 
            END;
        </sqlCheck>
        <not>
            <indexExists indexName="idx_ballot_party_summary_party"/>
        </not>
    </preConditions>
    <comment>
        Index on materialized view for party support queries (after population).
        
        Supports: Coalition evolution analysis
        Expected Impact: 50-80% improvement in party support queries
        
        Prerequisite: Materialized view must be populated first (Issue #8282)
        Current Status: Awaiting materialized view population
    </comment>
    <sql>
        CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_ballot_party_summary_party 
        ON view_riksdagen_vote_data_ballot_party_summary(party);
    </sql>
    <rollback>
        DROP INDEX IF EXISTS idx_ballot_party_summary_party;
    </rollback>
</changeSet>

<!-- Changelog Summary -->
<changeSet id="1.66-summary" author="performance-engineer">
    <comment>
        Database Changelog v1.66 - Network Analysis Performance Summary
        
        Indexes Created: 2 on vote_data table (available for testing)
        Indexes Awaiting: 2 on materialized views (requires population via Issue #8282)
        
        Performance Status: ✅ EXCELLENT
        - All 11 network views: 0.032-0.846ms (sub-millisecond to low millisecond)
        - Indexes support future data growth and enable sample data testing
        
        Testing: Load sample data from service.data.impl/sample-data/
        - table_vote_data_sample.csv (300 rows) validates idx_vote_data_* indexes
        
        Materialized View Prerequisites:
        - Issue #8282: Populate materialized views to activate remaining 2 indexes
        
        Expected Impact:
        
        Primary Issue: Data availability (4 views need materialized view population)
        Secondary Issue: None - performance is excellent
        
        - Co-voting analysis: 10-20% improvement with larger datasets
        - Coalition matrix: 5-10% improvement with larger datasets  
        - Materialized view queries: 50-80% improvement after population
        
        Next Steps:
        1. Test indexes with sample data (table_vote_data_sample.csv - 300 rows)
        2. Populate materialized views (issue #8282) to activate remaining 2 indexes
        3. Monitor performance as production data grows
        
        Related Issues:
        - #8280: Network Analysis Framework (75% → 100% operational)
        - #8282: Materialized View Population (prerequisite for 2 indexes)
    </comment>
</changeSet>

</databaseChangeLog>
