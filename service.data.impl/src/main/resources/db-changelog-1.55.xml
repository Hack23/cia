<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

<changeSet id="1.55-intro" author="intelligence-operative">
    <comment>v1.55 Historical Politician Party Transitions - Track MPs leaving their party while serving in Riksdagen</comment>
    <sql>SELECT 'v1.55' AS version, CURRENT_TIMESTAMP AS applied_at;</sql>
</changeSet>

<!-- ========================================================================= -->
<!-- VIEW 1: view_riksdagen_party_transition_history                          -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="create-party-transition-history-view-1.55-001" failOnError="true">
    <comment>
        Create view_riksdagen_party_transition_history to track all party changes since 2002.
        
        Purpose: Identify politicians who switched parties while serving as active MPs 
        (status = 'Tjänstgörande riksdagsledamot'). This tracks both mid-term defections 
        and returns to Riksdagen with new party affiliation.
        
        Key Features:
        - Uses LAG/LEAD window functions to detect party changes in assignment history
        - Calculates election proximity (months until next election, months since last election)
        - Distinguishes between "SWITCHED_WHILE_SERVING" vs "REJOINED_RIKSDAGEN" with new party
        - Filters out initial party assignments (where previous_party is NULL or '-')
        - Covers Swedish election cycles from 2002-2026
        
        Intelligence Value: ⭐⭐⭐⭐⭐ VERY HIGH
        - Tracks rare but significant political events
        - Enables party stability analysis  
        - Predicts future defection risk patterns
        - Measures timing relative to electoral cycle
        
        GitHub Issue: #8208 Historical Politician Transitions - Leaving Party While in Riksdagen
    </comment>
    
    <createView viewName="view_riksdagen_party_transition_history">
        <![CDATA[
WITH party_assignments AS (
    SELECT 
        a.intressent_id AS person_id,
        p.first_name,
        p.last_name,
        a.org_code AS party,
        a.from_date,
        a.to_date,
        a.status,
        LAG(a.org_code) OVER (PARTITION BY a.intressent_id ORDER BY a.from_date) AS previous_party,
        LEAD(a.org_code) OVER (PARTITION BY a.intressent_id ORDER BY a.from_date) AS next_party,
        LAG(a.to_date) OVER (PARTITION BY a.intressent_id ORDER BY a.from_date) AS previous_assignment_end
    FROM assignment_data a
    JOIN person_data p ON a.intressent_id = p.id
    WHERE a.status = 'Tjänstgörande riksdagsledamot' -- Active MP only
      AND a.assignment_type = 'Uppdrag'
      AND a.from_date >= '2002-01-01'
),
party_changes AS (
    SELECT 
        person_id, first_name, last_name,
        previous_party, party AS new_party,
        from_date AS transition_date,
        status,
        previous_assignment_end,
        CASE 
            WHEN previous_assignment_end IS NULL OR from_date - previous_assignment_end > INTERVAL '30 days'
            THEN 'REJOINED_RIKSDAGEN' -- Left parliament, came back with new party
            ELSE 'SWITCHED_WHILE_SERVING' -- Changed party while still serving
        END AS transition_type
    FROM party_assignments
    WHERE previous_party IS NOT NULL 
      AND previous_party != party
      AND previous_party NOT IN ('-', '') -- Exclude initial assignments
),
election_proximity AS (
    SELECT UNNEST(ARRAY['2002-09-15', '2006-09-17', '2010-09-19', 
                        '2014-09-14', '2018-09-09', '2022-09-11', '2026-09-13']::DATE[]) AS election_date
)
SELECT 
    pc.person_id, pc.first_name, pc.last_name,
    pc.previous_party, pc.new_party,
    pc.transition_date, pc.transition_type,
    EXTRACT(YEAR FROM pc.transition_date) AS transition_year,
    (SELECT MIN(ed.election_date) FROM election_proximity ed WHERE ed.election_date > pc.transition_date) AS next_election,
    EXTRACT(MONTH FROM AGE(
        (SELECT MIN(ed.election_date) FROM election_proximity ed WHERE ed.election_date > pc.transition_date),
        pc.transition_date
    ))::INTEGER AS months_until_next_election,
    (SELECT MAX(ed.election_date) FROM election_proximity ed WHERE ed.election_date < pc.transition_date) AS previous_election,
    EXTRACT(MONTH FROM AGE(
        pc.transition_date,
        (SELECT MAX(ed.election_date) FROM election_proximity ed WHERE ed.election_date < pc.transition_date)
    ))::INTEGER AS months_since_last_election
FROM party_changes pc
ORDER BY transition_date DESC
        ]]>
    </createView>
    
    <rollback>
        DROP VIEW IF EXISTS view_riksdagen_party_transition_history CASCADE;
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- VIEW 2: view_riksdagen_party_defector_analysis                           -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="create-party-defector-analysis-view-1.55-002" failOnError="true">
    <comment>
        Create view_riksdagen_party_defector_analysis to analyze defector characteristics.
        
        Purpose: Analyze behavioral patterns before/after party transitions - attendance, 
        document production, voting patterns. Classify defection timing as pre-election, 
        mid-term, or normal based on months until next election.
        
        Key Metrics:
        - Pre/post transition attendance rates (6 months window)
        - Document production before/after transition (6 months window)
        - Defection timing classification (PRE_ELECTION <12mo, MID_TERM >36mo, NORMAL 12-36mo)
        - Attendance change delta
        
        Intelligence Value: ⭐⭐⭐⭐⭐ VERY HIGH
        - Identifies early warning signals of defection (declining participation)
        - Measures impact of transition on politician activity
        - Classifies defection strategic timing
        - Enables predictive modeling of defection risk
        
        GitHub Issue: #8208 Historical Politician Transitions - Leaving Party While in Riksdagen
    </comment>
    
    <createView viewName="view_riksdagen_party_defector_analysis">
        <![CDATA[
WITH defector_performance AS (
    SELECT 
        pt.person_id, pt.first_name, pt.last_name,
        pt.previous_party, pt.new_party, pt.transition_date,
        pt.months_until_next_election,
        -- Performance before transition (6 months prior)
        ROUND(
            (AVG(CASE WHEN vd.ballot_date BETWEEN pt.transition_date - INTERVAL '6 months' AND pt.transition_date
                     THEN CASE WHEN vd.vote != 'Frånvarande' THEN 1 ELSE 0 END END) * 100)::NUMERIC,
            2
        ) AS pre_transition_attendance,
        -- Performance after transition (6 months after)
        ROUND(
            (AVG(CASE WHEN vd.ballot_date BETWEEN pt.transition_date AND pt.transition_date + INTERVAL '6 months'
                     THEN CASE WHEN vd.vote != 'Frånvarande' THEN 1 ELSE 0 END END) * 100)::NUMERIC,
            2
        ) AS post_transition_attendance,
        COUNT(DISTINCT dd.document_id) FILTER (WHERE dd.made_public_date < pt.transition_date 
                                                AND dd.made_public_date > pt.transition_date - INTERVAL '6 months') AS docs_before,
        COUNT(DISTINCT dd.document_id) FILTER (WHERE dd.made_public_date > pt.transition_date 
                                                AND dd.made_public_date < pt.transition_date + INTERVAL '6 months') AS docs_after
    FROM view_riksdagen_party_transition_history pt
    LEFT JOIN vote_data vd ON pt.person_id = vd.embedded_id_intressent_id
    LEFT JOIN document_data dd ON pt.person_id = dd.person_reference_id
    WHERE pt.transition_type = 'SWITCHED_WHILE_SERVING'
    GROUP BY pt.person_id, pt.first_name, pt.last_name, pt.previous_party, pt.new_party, 
             pt.transition_date, pt.months_until_next_election
)
SELECT 
    person_id, first_name, last_name, previous_party, new_party, transition_date,
    months_until_next_election,
    pre_transition_attendance, post_transition_attendance,
    ROUND((post_transition_attendance - pre_transition_attendance)::NUMERIC, 2) AS attendance_change,
    docs_before, docs_after,
    CASE 
        WHEN months_until_next_election < 12 THEN 'PRE_ELECTION_DEFECTION'
        WHEN months_until_next_election > 36 THEN 'MID_TERM_DEFECTION'
        ELSE 'NORMAL_DEFECTION'
    END AS defection_timing
FROM defector_performance
WHERE pre_transition_attendance IS NOT NULL OR post_transition_attendance IS NOT NULL
ORDER BY transition_date DESC
        ]]>
    </createView>
    
    <rollback>
        DROP VIEW IF EXISTS view_riksdagen_party_defector_analysis CASCADE;
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- VIEW 3: view_riksdagen_party_switcher_outcomes                           -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="create-party-switcher-outcomes-view-1.55-003" failOnError="true">
    <comment>
        Create view_riksdagen_party_switcher_outcomes to measure post-transition career success.
        
        Purpose: Track political career trajectory after party switch - did they continue 
        serving, get re-elected, attain leadership positions? Measures success rate and 
        career longevity.
        
        Key Metrics:
        - Continued serving after switch (active MP post-transition)
        - Total days served after transition
        - Re-election success (served in next election cycle)
        - Leadership positions attained post-switch
        - Current political status
        
        Intelligence Value: ⭐⭐⭐⭐ HIGH
        - Assesses political viability of party switching
        - Measures electoral consequences of defection
        - Tracks career survival rates
        - Informs strategic defection timing analysis
        
        GitHub Issue: #8208 Historical Politician Transitions - Leaving Party While in Riksdagen
    </comment>
    
    <createView viewName="view_riksdagen_party_switcher_outcomes">
        <![CDATA[
WITH switcher_subsequent_assignments AS (
    SELECT 
        pt.person_id, pt.first_name, pt.last_name,
        pt.previous_party, pt.new_party, pt.transition_date,
        pt.next_election,
        pt.months_until_next_election,
        -- Assignments after transition
        a.from_date AS subsequent_from_date,
        a.to_date AS subsequent_to_date,
        a.status AS subsequent_status,
        a.role_code AS subsequent_role,
        a.assignment_type AS subsequent_assignment_type,
        CASE 
            WHEN a.to_date IS NULL THEN (CURRENT_DATE - a.from_date)
            ELSE (a.to_date - a.from_date)
        END AS days_in_subsequent_role,
        -- Check if this assignment overlaps next election cycle
        CASE 
            WHEN a.from_date <= pt.next_election AND (a.to_date IS NULL OR a.to_date >= pt.next_election)
            THEN true
            ELSE false
        END AS served_in_next_election_cycle
    FROM view_riksdagen_party_transition_history pt
    LEFT JOIN assignment_data a ON pt.person_id = a.intressent_id
        AND a.from_date >= pt.transition_date
    WHERE pt.transition_type = 'SWITCHED_WHILE_SERVING'
)
SELECT 
    person_id, first_name, last_name, 
    previous_party, new_party, transition_date,
    next_election,
    months_until_next_election,
    -- Career outcome metrics
    COUNT(DISTINCT subsequent_from_date) AS total_subsequent_assignments,
    SUM(days_in_subsequent_role) AS total_days_served_after_switch,
    MAX(CASE WHEN subsequent_status = 'Tjänstgörande riksdagsledamot' THEN 1 ELSE 0 END) AS continued_as_active_mp,
    MAX(CASE WHEN served_in_next_election_cycle = true THEN 1 ELSE 0 END) AS served_in_next_election,
    MAX(CASE WHEN subsequent_role IN ('Partiledare', 'Gruppledare', 'Partisekreterare', 'Ordförande', 'Vice ordförande') 
             THEN 1 ELSE 0 END) AS attained_leadership_post_switch,
    STRING_AGG(DISTINCT subsequent_role, ', ') FILTER (WHERE subsequent_role IS NOT NULL) AS post_switch_roles,
    MAX(p.status) AS current_status
FROM switcher_subsequent_assignments ssa
LEFT JOIN person_data p ON ssa.person_id = p.id
GROUP BY person_id, first_name, last_name, previous_party, new_party, transition_date, 
         next_election, months_until_next_election
ORDER BY transition_date DESC
        ]]>
    </createView>
    
    <rollback>
        DROP VIEW IF EXISTS view_riksdagen_party_switcher_outcomes CASCADE;
    </rollback>
</changeSet>

</databaseChangeLog>
