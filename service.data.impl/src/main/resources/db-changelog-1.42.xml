<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

<!-- 
  Fix Empty Ministry Views v1.42
  Author: Intelligence Operative & Political Analyst
  Date: 2025-12-02
  GitHub Issue: #8007 - Fix Empty View: view_ministry_productivity_matrix
  
  This changelog fixes THREE ministry views which return 0 rows or fail with
  "materialized view not populated" error due to dependency on unpopulated 
  materialized view view_riksdagen_politician_document:
  
  1. view_ministry_productivity_matrix
  2. view_ministry_effectiveness_trends
  3. view_ministry_risk_evolution
  
  Root Cause Identified:
  All three views depend on view_riksdagen_politician_document (MATERIALIZED VIEW) via LEFT JOIN.
  Even with LEFT JOIN, PostgreSQL throws an error if the materialized view hasn't been 
  populated with REFRESH MATERIALIZED VIEW:
  
    ERROR: materialized view "view_riksdagen_politician_document" has not been populated
    HINT: Use the REFRESH MATERIALIZED VIEW command.
  
  Previous Fix Attempts:
  - Changelog v1.31: Created views with materialized view dependency
  - Changelog v1.37: Added case-insensitive matching - INCOMPLETE (still had mat view dep)
  - Changelog v1.39: Removed LIKE '%departement%' filter - INCOMPLETE (still had mat view dep)
  - Issue #7883, #7886: Closed prematurely without fixing materialized view dependency
  
  Solution:
  Replace materialized view reference with direct query to base tables:
  - document_status_container (document status)
  - document_data (document metadata including made_public_date, org, document_type)
  - document_person_reference_da_0 (person-document associations)
  - document_person_reference_co_0 (container)
  
  This is the same approach successfully used for view_politician_risk_summary in v1.39.
  
  Impact:
  - Enables all ministry views in fresh database installations
  - Removes dependency on materialized view refresh schedule
  - Maintains all existing calculation logic unchanged
  - Performance: Slightly slower but ensures data availability
-->

<!-- ========================================================================= -->
<!-- FIX: view_ministry_productivity_matrix - Remove Materialized View Dependency -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="fix-ministry-productivity-matrix-matview-1.42-001" failOnError="true">
    <comment>
        Fix view_ministry_productivity_matrix by removing materialized view dependency
        
        Root Cause: The view uses LEFT JOIN on view_riksdagen_politician_document
        (materialized view). Even with LEFT JOIN, PostgreSQL cannot execute the
        query if the materialized view hasn't been populated with REFRESH MATERIALIZED VIEW.
        
        Solution: Replace the materialized view reference with a direct query to
        the underlying base tables (document_status_container, document_data,
        document_person_reference_da_0, document_person_reference_co_0) to calculate
        document counts inline.
        
        The ministry_document_data CTE mirrors the structure of the materialized view
        but queries the base tables directly, ensuring the view always works regardless
        of materialized view population status.
        
        Changes:
        - Add ministry_document_data CTE that directly queries base tables
        - Replace view_riksdagen_politician_document reference with CTE
        - Maintain all productivity calculation logic unchanged
        - Keep LEFT JOIN semantics to handle missing documents gracefully
    </comment>
    
    <dropView viewName="view_ministry_productivity_matrix" ifExists="true" cascadeConstraints="true"/>
    
    <createView viewName="view_ministry_productivity_matrix">
        <![CDATA[
WITH ministry_base AS (
    -- Get distinct ministry assignments from assignment_data
    -- Uses assignment_type = 'Departement' to identify ministries
    SELECT DISTINCT
        org_code,
        LOWER(org_code) AS org_code_lower,
        org_code AS short_code,
        detail AS name
    FROM assignment_data
    WHERE assignment_type = 'Departement'
        AND org_code IS NOT NULL
),
ministry_document_data AS (
    -- Direct query to base tables instead of materialized view
    -- This avoids the "materialized view not populated" error
    -- Mirrors the structure of view_riksdagen_politician_document
    SELECT 
        dsc.hjid AS id,
        dd.document_type,
        dd.made_public_date,
        dd.org,
        dpr.person_reference_id
    FROM document_status_container dsc
    LEFT JOIN document_data dd 
        ON dsc.document_document_status_con_0 = dd.id
    LEFT JOIN document_person_reference_co_0 dprc 
        ON dsc.hjid = dprc.hjid
    LEFT JOIN document_person_reference_da_0 dpr 
        ON dpr.document_person_reference_li_1 = dprc.hjid
    WHERE dd.made_public_date IS NOT NULL
),
ministry_annual_metrics AS (
    -- Calculate annual document metrics per ministry
    SELECT
        m.org_code,
        m.short_code,
        m.name,
        EXTRACT(YEAR FROM doc.made_public_date) AS year,
        COUNT(DISTINCT doc.id) AS documents_produced,
        COUNT(DISTINCT CASE WHEN LOWER(doc.document_type) = 'prop' THEN doc.id END) AS propositions,
        COUNT(DISTINCT CASE WHEN LOWER(doc.document_type) = 'ds' THEN doc.id END) AS government_bills,
        COUNT(DISTINCT doc.person_reference_id) AS unique_contributors,
        MIN(doc.made_public_date) AS earliest_document,
        MAX(doc.made_public_date) AS latest_document
    FROM ministry_base m
    LEFT JOIN ministry_document_data doc 
        ON LOWER(doc.org) = m.org_code_lower
        AND doc.made_public_date >= CURRENT_DATE - INTERVAL '3 years'
    GROUP BY m.org_code, m.short_code, m.name, EXTRACT(YEAR FROM doc.made_public_date)
),
productivity_benchmarks AS (
    -- Calculate productivity benchmarks per year for quartile analysis
    SELECT
        year,
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY documents_produced) AS p25_documents,
        PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY documents_produced) AS median_documents,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY documents_produced) AS p75_documents,
        AVG(documents_produced) AS avg_documents
    FROM ministry_annual_metrics
    WHERE year IS NOT NULL
    GROUP BY year
)
SELECT
    mam.org_code,
    mam.short_code,
    mam.name,
    mam.year,
    mam.documents_produced,
    mam.propositions,
    mam.government_bills,
    mam.unique_contributors,
    mam.earliest_document,
    mam.latest_document,
    pb.median_documents,
    pb.avg_documents,
    pb.p25_documents,
    pb.p75_documents,
    ROUND((CAST(mam.documents_produced AS NUMERIC) - pb.avg_documents) / NULLIF(pb.avg_documents, 0) * 100, 2) AS pct_vs_average,
    
    -- Productivity quartile classification
    CASE
        WHEN CAST(mam.documents_produced AS NUMERIC) >= pb.p75_documents THEN 'TOP_QUARTILE'
        WHEN CAST(mam.documents_produced AS NUMERIC) >= pb.median_documents THEN 'ABOVE_MEDIAN'
        WHEN CAST(mam.documents_produced AS NUMERIC) >= pb.p25_documents THEN 'BELOW_MEDIAN'
        ELSE 'BOTTOM_QUARTILE'
    END AS productivity_quartile,
    
    -- Performance assessment
    CASE
        WHEN CAST(mam.documents_produced AS NUMERIC) >= pb.p75_documents THEN 'High-performing ministry'
        WHEN CAST(mam.documents_produced AS NUMERIC) < pb.p25_documents THEN 'Underperforming ministry - review needed'
        ELSE 'Standard ministry performance'
    END AS performance_assessment
FROM ministry_annual_metrics mam
LEFT JOIN productivity_benchmarks pb ON pb.year = mam.year
WHERE mam.year IS NOT NULL
ORDER BY mam.year DESC, mam.documents_produced DESC
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_ministry_productivity_matrix"/>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- FIX: view_ministry_effectiveness_trends - Remove Materialized View Dependency -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="fix-ministry-effectiveness-trends-matview-1.42-002" failOnError="true">
    <comment>
        Fix view_ministry_effectiveness_trends by removing materialized view dependency
        
        Root Cause: The view uses LEFT JOIN on view_riksdagen_politician_document
        (materialized view). Even with LEFT JOIN, PostgreSQL cannot execute the
        query if the materialized view hasn't been populated.
        
        Solution: Replace the materialized view reference with a direct query to
        the underlying base tables using ministry_document_data CTE.
    </comment>
    
    <dropView viewName="view_ministry_effectiveness_trends" ifExists="true" cascadeConstraints="true"/>
    
    <createView viewName="view_ministry_effectiveness_trends">
        <![CDATA[
WITH ministry_base AS (
    SELECT DISTINCT
        org_code,
        LOWER(org_code) AS org_code_lower,
        org_code AS short_code,
        detail AS name
    FROM assignment_data
    WHERE assignment_type = 'Departement'
        AND org_code IS NOT NULL
),
ministry_document_data AS (
    -- Direct query to base tables instead of materialized view
    SELECT 
        dsc.hjid AS id,
        dd.document_type,
        dd.made_public_date,
        dd.org,
        dpr.person_reference_id
    FROM document_status_container dsc
    LEFT JOIN document_data dd 
        ON dsc.document_document_status_con_0 = dd.id
    LEFT JOIN document_person_reference_co_0 dprc 
        ON dsc.hjid = dprc.hjid
    LEFT JOIN document_person_reference_da_0 dpr 
        ON dpr.document_person_reference_li_1 = dprc.hjid
    WHERE dd.made_public_date IS NOT NULL
),
ministry_quarterly_metrics AS (
    SELECT
        m.org_code,
        m.short_code,
        m.name,
        DATE_TRUNC('quarter', doc.made_public_date) AS period_start,
        COUNT(DISTINCT doc.id) AS documents_produced,
        COUNT(DISTINCT CASE WHEN LOWER(doc.document_type) = 'prop' THEN doc.id END) AS propositions,
        COUNT(DISTINCT CASE WHEN LOWER(doc.document_type) = 'ds' THEN doc.id END) AS government_bills,
        COUNT(DISTINCT CASE WHEN LOWER(doc.document_type) IN ('prop', 'ds') THEN doc.id END) AS legislative_documents,
        COUNT(DISTINCT doc.person_reference_id) AS active_members
    FROM ministry_base m
    LEFT JOIN ministry_document_data doc 
        ON LOWER(doc.org) = m.org_code_lower
        AND doc.made_public_date >= CURRENT_DATE - INTERVAL '3 years'
    GROUP BY m.org_code, m.short_code, m.name, DATE_TRUNC('quarter', doc.made_public_date)
),
trend_calculations AS (
    SELECT
        org_code,
        short_code,
        name,
        period_start,
        documents_produced,
        propositions,
        government_bills,
        legislative_documents,
        active_members,
        
        LAG(documents_produced, 1) OVER (PARTITION BY org_code ORDER BY period_start) AS prev_documents,
        LAG(active_members, 1) OVER (PARTITION BY org_code ORDER BY period_start) AS prev_members,
        LAG(legislative_documents, 1) OVER (PARTITION BY org_code ORDER BY period_start) AS prev_legislative,
        
        ROUND(AVG(documents_produced) OVER (
            PARTITION BY org_code 
            ORDER BY period_start 
            ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
        ), 2) AS ma_4quarter_documents,
        
        ROUND(AVG(legislative_documents) OVER (
            PARTITION BY org_code 
            ORDER BY period_start 
            ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
        ), 2) AS ma_4quarter_legislative,
        
        ROUND(AVG(CAST(active_members AS NUMERIC)) OVER (
            PARTITION BY org_code 
            ORDER BY period_start 
            ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
        ), 2) AS ma_4quarter_members
    FROM ministry_quarterly_metrics
    WHERE period_start IS NOT NULL
)
SELECT
    org_code,
    short_code,
    name,
    period_start,
    (period_start + INTERVAL '3 months' - INTERVAL '1 day')::DATE AS period_end,
    EXTRACT(YEAR FROM period_start) AS year,
    EXTRACT(QUARTER FROM period_start) AS quarter,
    documents_produced,
    propositions,
    government_bills,
    legislative_documents,
    active_members,
    
    documents_produced - COALESCE(prev_documents, documents_produced) AS document_change,
    active_members - COALESCE(prev_members, active_members) AS member_change,
    legislative_documents - COALESCE(prev_legislative, legislative_documents) AS legislative_change,
    
    ma_4quarter_documents,
    ma_4quarter_legislative,
    ma_4quarter_members,
    
    ROUND(CAST(documents_produced AS NUMERIC) / NULLIF(active_members, 0), 2) AS documents_per_member,
    ROUND(CAST(legislative_documents AS NUMERIC) / NULLIF(active_members, 0), 2) AS legislative_per_member,
    
    CASE
        WHEN documents_produced >= 50 THEN 'HIGHLY_PRODUCTIVE'
        WHEN documents_produced >= 30 THEN 'PRODUCTIVE'
        WHEN documents_produced >= 15 THEN 'MODERATE'
        ELSE 'LOW_PRODUCTIVITY'
    END AS productivity_level,
    
    CASE
        WHEN legislative_documents = 0 THEN 'INACTIVE_LEGISLATION'
        WHEN legislative_documents >= 10 THEN 'HIGH_LEGISLATIVE_OUTPUT'
        WHEN legislative_documents >= 5 THEN 'MODERATE_LEGISLATIVE_OUTPUT'
        ELSE 'LOW_LEGISLATIVE_OUTPUT'
    END AS legislative_status,
    
    CASE
        WHEN active_members = 0 THEN 'NO_ACTIVE_STAFF'
        WHEN active_members = 1 THEN 'CRITICALLY_UNDERSTAFFED'
        WHEN active_members <= 3 THEN 'UNDERSTAFFED'
        WHEN active_members <= 10 THEN 'ADEQUATELY_STAFFED'
        ELSE 'WELL_STAFFED'
    END AS staffing_status,
    
    CASE
        WHEN ma_4quarter_documents < 10 AND documents_produced - COALESCE(prev_documents, documents_produced) <= -5
            THEN 'SEVERE_DECLINE'
        WHEN ma_4quarter_documents < 20 AND documents_produced - COALESCE(prev_documents, documents_produced) <= -3
            THEN 'MODERATE_DECLINE'
        WHEN documents_produced - COALESCE(prev_documents, documents_produced) < 0
            THEN 'SLIGHT_DECLINE'
        WHEN documents_produced - COALESCE(prev_documents, documents_produced) > 0
            THEN 'IMPROVING'
        ELSE 'STABLE'
    END AS stagnation_indicator,
    
    CASE
        WHEN documents_produced >= 50 AND active_members >= 10 AND legislative_documents >= 10
            THEN 'Exceptional ministry performance - high output and capacity'
        WHEN documents_produced >= 30 AND active_members >= 5
            THEN 'Strong ministry effectiveness'
        WHEN documents_produced < 15 OR active_members <= 3 OR legislative_documents = 0
            THEN 'Ministry performance concerns - investigation recommended'
        WHEN ma_4quarter_documents < 20 AND documents_produced - COALESCE(prev_documents, documents_produced) <= -5
            THEN 'Significant ministry decline detected - intervention needed'
        ELSE 'Standard ministry operations'
    END AS effectiveness_assessment
FROM trend_calculations
ORDER BY org_code, period_start DESC
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_ministry_effectiveness_trends"/>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- FIX: view_ministry_risk_evolution - Remove Materialized View Dependency -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="fix-ministry-risk-evolution-matview-1.42-003" failOnError="true">
    <comment>
        Fix view_ministry_risk_evolution by removing materialized view dependency
        
        Root Cause: The view uses LEFT JOIN on view_riksdagen_politician_document
        (materialized view). Even with LEFT JOIN, PostgreSQL cannot execute the
        query if the materialized view hasn't been populated.
        
        Solution: Replace the materialized view reference with a direct query to
        the underlying base tables using ministry_document_data CTE.
    </comment>
    
    <dropView viewName="view_ministry_risk_evolution" ifExists="true" cascadeConstraints="true"/>
    
    <createView viewName="view_ministry_risk_evolution">
        <![CDATA[
WITH ministry_base AS (
    SELECT DISTINCT
        org_code,
        LOWER(org_code) AS org_code_lower,
        detail AS name
    FROM assignment_data
    WHERE assignment_type = 'Departement'
        AND org_code IS NOT NULL
),
ministry_document_data AS (
    -- Direct query to base tables instead of materialized view
    SELECT 
        dsc.hjid AS id,
        dd.document_type,
        dd.made_public_date,
        dd.org,
        dpr.person_reference_id
    FROM document_status_container dsc
    LEFT JOIN document_data dd 
        ON dsc.document_document_status_con_0 = dd.id
    LEFT JOIN document_person_reference_co_0 dprc 
        ON dsc.hjid = dprc.hjid
    LEFT JOIN document_person_reference_da_0 dpr 
        ON dpr.document_person_reference_li_1 = dprc.hjid
    WHERE dd.made_public_date IS NOT NULL
),
quarterly_performance AS (
    SELECT
        m.org_code,
        m.name,
        DATE_TRUNC('quarter', doc.made_public_date) AS assessment_period,
        COUNT(DISTINCT doc.id) AS documents_produced,
        COUNT(DISTINCT CASE WHEN LOWER(doc.document_type) IN ('prop', 'ds') THEN doc.id END) AS legislative_count,
        COUNT(DISTINCT doc.person_reference_id) AS active_members
    FROM ministry_base m
    LEFT JOIN ministry_document_data doc 
        ON LOWER(doc.org) = m.org_code_lower
        AND doc.made_public_date >= CURRENT_DATE - INTERVAL '2 years'
    GROUP BY m.org_code, m.name, DATE_TRUNC('quarter', doc.made_public_date)
),
risk_calculations AS (
    SELECT
        org_code,
        name,
        assessment_period,
        documents_produced,
        legislative_count,
        active_members,
        
        LAG(documents_produced, 1) OVER (PARTITION BY org_code ORDER BY assessment_period) AS prev_documents,
        LAG(legislative_count, 1) OVER (PARTITION BY org_code ORDER BY assessment_period) AS prev_legislative,
        LAG(active_members, 1) OVER (PARTITION BY org_code ORDER BY assessment_period) AS prev_members,
        
        AVG(documents_produced) OVER (
            PARTITION BY org_code 
            ORDER BY assessment_period 
            ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
        ) AS rolling_avg_documents
    FROM quarterly_performance
    WHERE assessment_period IS NOT NULL
)
SELECT
    org_code,
    name,
    assessment_period,
    (assessment_period + INTERVAL '3 months' - INTERVAL '1 day')::DATE AS period_end,
    EXTRACT(YEAR FROM assessment_period) AS year,
    EXTRACT(QUARTER FROM assessment_period) AS quarter,
    documents_produced,
    legislative_count,
    active_members,
    
    documents_produced - COALESCE(prev_documents, documents_produced) AS document_trend,
    legislative_count - COALESCE(prev_legislative, legislative_count) AS legislative_trend,
    active_members - COALESCE(prev_members, active_members) AS staffing_trend,
    
    rolling_avg_documents,
    
    CASE
        WHEN documents_produced = 0 AND active_members = 0 THEN 'CRITICAL'
        WHEN documents_produced < 5 OR active_members <= 1 THEN 'HIGH'
        WHEN documents_produced < 10 OR active_members <= 2 THEN 'MEDIUM'
        WHEN documents_produced - COALESCE(prev_documents, documents_produced) < -5 THEN 'ELEVATED'
        ELSE 'LOW'
    END AS risk_level,
    
    CASE
        WHEN documents_produced = 0 AND active_members = 0 
            THEN 'Critical: No activity detected - immediate review required'
        WHEN documents_produced < 5 
            THEN 'High Risk: Minimal document production - capacity concerns'
        WHEN active_members <= 1 
            THEN 'High Risk: Critically understaffed ministry'
        WHEN documents_produced - COALESCE(prev_documents, documents_produced) < -5 
            THEN 'Elevated Risk: Significant production decline detected'
        WHEN documents_produced >= 20 AND active_members >= 5 
            THEN 'Low Risk: Healthy ministry operations'
        ELSE 'Medium Risk: Standard operations with minor concerns'
    END AS risk_assessment
FROM risk_calculations
ORDER BY org_code, assessment_period DESC
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_ministry_risk_evolution"/>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- POST-FLIGHT: Verify views return data                                    -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="verify-ministry-views-1.42-004" failOnError="false">
    <comment>
        Post-flight verification for all three ministry views
        
        Checks:
        1. Views exist and can be queried (no materialized view error)
        2. Views return data when ministry assignments exist
        3. Reports row counts for monitoring
    </comment>
    
    <sql>
        -- Verify views exist and can be queried
        SELECT 'Ministry Views verification:' AS check_description;
        
        -- Check ministry assignment count
        SELECT 
            COUNT(DISTINCT org_code) AS ministry_count,
            'Ministry assignments (assignment_type = Departement)' AS description
        FROM assignment_data
        WHERE assignment_type = 'Departement' AND org_code IS NOT NULL;
        
        -- Check view_ministry_productivity_matrix row count
        SELECT 
            COUNT(*) AS view_row_count,
            'Rows in view_ministry_productivity_matrix' AS description
        FROM view_ministry_productivity_matrix;
        
        -- Check view_ministry_effectiveness_trends row count
        SELECT 
            COUNT(*) AS view_row_count,
            'Rows in view_ministry_effectiveness_trends' AS description
        FROM view_ministry_effectiveness_trends;
        
        -- Check view_ministry_risk_evolution row count
        SELECT 
            COUNT(*) AS view_row_count,
            'Rows in view_ministry_risk_evolution' AS description
        FROM view_ministry_risk_evolution;
    </sql>
</changeSet>

<!-- ========================================================================= -->
<!-- FIX: view_risk_score_evolution - Remove Materialized View Dependency      -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="fix-risk-score-evolution-matview-1.42-005" failOnError="true">
    <comment>
        Fix view_risk_score_evolution by removing materialized view dependency
        
        Root Cause: The view was re-introduced in db-changelog-1.41.xml (for rebel rate fix)
        but still referenced view_riksdagen_politician_document (materialized view).
        
        Solution: Replace the materialized view reference with a direct query to
        the underlying base tables using politician_document_data CTE.
    </comment>
    
    <dropView viewName="view_risk_score_evolution" ifExists="true" cascadeConstraints="true"/>
    
    <createView viewName="view_risk_score_evolution">
        <![CDATA[
WITH party_ballot_majority AS (
    SELECT 
        embedded_id_ballot_id,
        party,
        SUM(CASE WHEN vote = 'Ja' THEN 1 ELSE 0 END) AS party_yes_count,
        SUM(CASE WHEN vote = 'Nej' THEN 1 ELSE 0 END) AS party_no_count,
        SUM(CASE WHEN vote = 'Ja' THEN 1 ELSE 0 END) > 
        SUM(CASE WHEN vote = 'Nej' THEN 1 ELSE 0 END) AS party_approved
    FROM vote_data
    WHERE vote_date >= CURRENT_DATE - INTERVAL '3 years'
        AND party IS NOT NULL
    GROUP BY embedded_id_ballot_id, party
),
politician_votes_with_rebel AS (
    SELECT 
        vd.embedded_id_intressent_id,
        vd.vote_date,
        vd.vote,
        vd.party,
        pbm.party_approved,
        CASE 
            WHEN vd.vote = 'Nej' AND pbm.party_approved = true THEN true
            WHEN vd.vote = 'Ja' AND pbm.party_approved = false THEN true
            ELSE false
        END AS is_rebel
    FROM vote_data vd
    INNER JOIN party_ballot_majority pbm 
        ON vd.embedded_id_ballot_id = pbm.embedded_id_ballot_id
        AND vd.party = pbm.party
    WHERE vd.vote_date >= CURRENT_DATE - INTERVAL '3 years'
),
politician_document_data AS (
    -- Direct query to base tables instead of materialized view
    SELECT 
        dsc.hjid AS id,
        dd.document_type,
        dd.made_public_date,
        dd.org,
        dpr.person_reference_id
    FROM document_status_container dsc
    LEFT JOIN document_data dd 
        ON dsc.document_document_status_con_0 = dd.id
    LEFT JOIN document_person_reference_co_0 dprc 
        ON dsc.hjid = dprc.hjid
    LEFT JOIN document_person_reference_da_0 dpr 
        ON dpr.document_person_reference_li_1 = dprc.hjid
    WHERE dd.made_public_date IS NOT NULL
),
monthly_risk_base AS (
    SELECT
        p.id AS person_id,
        p.first_name,
        p.last_name,
        p.party,
        DATE_TRUNC('month', pvr.vote_date) AS assessment_period,
        
        ROUND(
            COUNT(*) FILTER (WHERE pvr.vote = 'FrÃ¥nvarande')::NUMERIC / 
            NULLIF(COUNT(*), 0) * 100, 
            2
        ) AS absence_rate,
        
        ROUND(
            COUNT(*) FILTER (WHERE pvr.is_rebel = true)::NUMERIC / 
            NULLIF(COUNT(*) FILTER (WHERE pvr.vote IN ('Ja', 'Nej')), 0) * 100, 
            2
        ) AS rebel_rate,
        
        COUNT(*) AS ballot_count,
        COUNT(DISTINCT vpd.id) AS document_count
        
    FROM person_data p
    LEFT JOIN politician_votes_with_rebel pvr 
        ON pvr.embedded_id_intressent_id = p.id
    LEFT JOIN politician_document_data vpd 
        ON vpd.person_reference_id = p.id
        AND vpd.made_public_date >= CURRENT_DATE - INTERVAL '3 years'
        AND DATE_TRUNC('month', vpd.made_public_date) = DATE_TRUNC('month', pvr.vote_date)
    WHERE p.status IN ('active', 'Active', 'ACTIVE')
    GROUP BY p.id, p.first_name, p.last_name, p.party, DATE_TRUNC('month', pvr.vote_date)
),
monthly_violations AS (
    SELECT
        reference_id AS person_id,
        DATE_TRUNC('month', detected_date) AS assessment_period,
        COUNT(*) AS violation_count,
        COUNT(DISTINCT rule_group) AS violation_categories,
        STRING_AGG(DISTINCT rule_group::TEXT, ', ' ORDER BY rule_group::TEXT) AS violation_types
    FROM rule_violation
    WHERE resource_type = 'POLITICIAN'
        AND status = 'ACTIVE'
        AND detected_date >= CURRENT_DATE - INTERVAL '3 years'
    GROUP BY reference_id, DATE_TRUNC('month', detected_date)
),
risk_calculations AS (
    SELECT
        mrb.person_id,
        mrb.first_name,
        mrb.last_name,
        mrb.party,
        mrb.assessment_period,
        mrb.absence_rate,
        mrb.rebel_rate,
        mrb.ballot_count,
        mrb.document_count,
        
        COALESCE(mv.violation_count, 0) AS violation_count,
        COALESCE(mv.violation_categories, 0) AS violation_categories,
        COALESCE(mv.violation_types, '') AS violation_types,
        
        ROUND(
            LEAST(COALESCE(mv.violation_count, 0) * 2, 40) +
            (COALESCE(mrb.absence_rate, 0) * 30 / 100.0) +
            (COALESCE(mrb.rebel_rate, 0) * 20 / 100.0) +
            (CASE WHEN mrb.document_count < 5 THEN 10 ELSE 0 END),
            2
        ) AS calculated_risk_score,
        
        LAG(
            ROUND(
                LEAST(COALESCE(mv.violation_count, 0) * 2, 40) +
                (COALESCE(mrb.absence_rate, 0) * 30 / 100.0) +
                (COALESCE(mrb.rebel_rate, 0) * 20 / 100.0) +
                (CASE WHEN mrb.document_count < 5 THEN 10 ELSE 0 END),
                2
            ), 1
        ) OVER (PARTITION BY mrb.person_id ORDER BY mrb.assessment_period) AS prev_risk_score
        
    FROM monthly_risk_base mrb
    LEFT JOIN monthly_violations mv 
        ON mrb.person_id = mv.person_id 
        AND mrb.assessment_period = mv.assessment_period
    WHERE mrb.ballot_count >= 5
        AND mrb.assessment_period IS NOT NULL
)
SELECT
    person_id,
    first_name,
    last_name,
    party,
    assessment_period,
    (assessment_period + INTERVAL '1 month' - INTERVAL '1 day')::DATE AS assessment_period_end,
    absence_rate,
    rebel_rate,
    ballot_count,
    document_count,
    violation_count,
    violation_categories,
    violation_types,
    calculated_risk_score AS risk_score,
    prev_risk_score,
    ROUND(calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score), 2) AS risk_score_change,
    
    CASE
        WHEN calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) >= 10 THEN 'SIGNIFICANT_INCREASE'
        WHEN calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) >= 5 THEN 'MODERATE_INCREASE'
        WHEN calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) > 0 THEN 'SLIGHT_INCREASE'
        WHEN calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) <= -10 THEN 'SIGNIFICANT_DECREASE'
        WHEN calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) <= -5 THEN 'MODERATE_DECREASE'
        WHEN calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) < 0 THEN 'SLIGHT_DECREASE'
        ELSE 'STABLE'
    END AS risk_trend,
    
    CASE
        WHEN calculated_risk_score >= 70 THEN 'CRITICAL'
        WHEN calculated_risk_score >= 50 THEN 'HIGH'
        WHEN calculated_risk_score >= 30 THEN 'MODERATE'
        WHEN calculated_risk_score >= 15 THEN 'LOW'
        ELSE 'MINIMAL'
    END AS risk_severity,
    
    CASE
        WHEN COALESCE(prev_risk_score, 0) > 0 THEN
            CASE
                WHEN prev_risk_score < 30 AND calculated_risk_score >= 30 THEN 'ESCALATION_TO_MODERATE'
                WHEN prev_risk_score < 50 AND calculated_risk_score >= 50 THEN 'ESCALATION_TO_HIGH'
                WHEN prev_risk_score < 70 AND calculated_risk_score >= 70 THEN 'ESCALATION_TO_CRITICAL'
                WHEN prev_risk_score >= 70 AND calculated_risk_score < 70 THEN 'DEESCALATION_FROM_CRITICAL'
                WHEN prev_risk_score >= 50 AND calculated_risk_score < 50 THEN 'DEESCALATION_FROM_HIGH'
                WHEN prev_risk_score >= 30 AND calculated_risk_score < 30 THEN 'DEESCALATION_FROM_MODERATE'
                ELSE 'NO_SEVERITY_TRANSITION'
            END
        ELSE 'INITIAL_ASSESSMENT'
    END AS severity_transition,
    
    CASE
        WHEN calculated_risk_score >= 70 THEN 'CRITICAL: Immediate attention required'
        WHEN calculated_risk_score >= 50 AND calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) >= 5 
            THEN 'HIGH RISK: Escalating trend detected'
        WHEN calculated_risk_score >= 50 THEN 'HIGH RISK: Monitor closely'
        WHEN calculated_risk_score >= 30 AND calculated_risk_score - COALESCE(prev_risk_score, calculated_risk_score) >= 10 
            THEN 'MODERATE RISK: Rapid escalation warning'
        WHEN calculated_risk_score >= 30 THEN 'MODERATE RISK: Standard monitoring'
        WHEN prev_risk_score >= 50 AND calculated_risk_score < 30 
            THEN 'IMPROVING: Effective risk mitigation'
        ELSE 'LOW RISK: Normal operations'
    END AS risk_assessment
    
FROM risk_calculations
ORDER BY person_id, assessment_period DESC
        ]]>
    </createView>
    
    <rollback>
        <dropView viewName="view_risk_score_evolution"/>
    </rollback>
</changeSet>

<!-- ========================================================================= -->
<!-- DOCUMENTATION: Update changelog and troubleshooting guide                -->
<!-- ========================================================================= -->

<changeSet author="intelligence-operative" id="document-ministry-views-fix-1.42-006" failOnError="false">
    <comment>
        Documentation for v1.42 views fix
        
        Summary:
        - Root cause: Dependency on unpopulated materialized view view_riksdagen_politician_document
        - Solution: Replace materialized view with direct base table queries in all views
        - Impact: Views now work in fresh database installations without materialized view refresh
        
        Views Fixed:
        1. view_ministry_productivity_matrix - Annual productivity benchmarking
        2. view_ministry_effectiveness_trends - Quarterly effectiveness trends
        3. view_ministry_risk_evolution - Quarterly risk assessment
        4. view_risk_score_evolution - Monthly risk score tracking (re-introduced in 1.41, now fixed)
        
        For CHANGELOG_DATABASE_VIEWS.md:
        - v1.42: Fixed all views materialized view dependency
        - Replaced view_riksdagen_politician_document reference with direct base table CTEs
        - CTEs query document_status_container, document_data, document_person_reference_* tables
        - No change to output columns or calculations
    </comment>
    
    <sql>
        SELECT 
            'v1.42 Fix Applied: All Views with Mat View Dependency' AS changelog_entry,
            'Removed materialized view dependency from 4 views' AS change_description,
            'Views now query base tables directly via CTEs' AS technical_details;
    </sql>
</changeSet>

</databaseChangeLog>
