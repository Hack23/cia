<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet id="create-view-riksdagen-coalition-alignment-matrix" author="system">
        <sql> CREATE VIEW view_riksdagen_coalition_alignment_matrix AS WITH party_votes AS ( SELECT
            embedded_id_party AS party, embedded_id_ballot_id, embedded_id_issue,
            embedded_id_concern, party_won FROM view_riksdagen_vote_data_ballot_party_summary WHERE
            embedded_id_party IS NOT NULL ), party_pairs AS ( SELECT p1.party AS party1, p2.party AS
            party2, p1.embedded_id_ballot_id, p1.embedded_id_issue, p1.embedded_id_concern, CASE
            WHEN p1.party_won = p2.party_won THEN 1 ELSE 0 END AS aligned FROM party_votes p1 CROSS
            JOIN party_votes p2 WHERE p1.party < p2.party
                AND p1.embedded_id_ballot_id= p2.embedded_id_ballot_id
                AND
                p1.embedded_id_issue= p2.embedded_id_issue
                AND p1.embedded_id_concern= p2.embedded_id_concern
                )
                SELECT
                party1,
                party2,
                COUNT(*) AS total_votes,
                SUM(aligned) AS aligned_votes,
                ROUND(CAST(SUM(aligned) AS NUMERIC) / COUNT(*), 4) AS alignment_rate
                FROM party_pairs
                GROUP BY party1, party2;
        </sql>
    </changeSet>

</databaseChangeLog>