<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

    <!-- 
      CIA Database Update v1.51
      Author: Intelligence Operative
      Date: 2026-02-12
      
      Changes:
      - Recreates view_riksdagen_politician_document_summary (Materialized View) with added document type
    counters (Questions, Interpellations).
      - Recreates dependent views dropped by CASCADE:
        - view_riksdagen_party_member
        - view_riksdagen_party
        - view_riksdagen_politician
        - view_riksdagen_politician_ballot_summary
    -->

    <changeSet author="intelligence-operative" id="cia-db-update-v1.51" failOnError="true">
        <comment>Recreate views with cascading dependencies for v1.51 update</comment>

        <!-- 1. Recreate Materialized View: view_riksdagen_politician_document_summary -->
        <sql splitStatements="false" stripComments="false">
<![CDATA[
DROP MATERIALIZED VIEW IF EXISTS view_riksdagen_politician_document_summary CASCADE;

CREATE MATERIALIZED VIEW view_riksdagen_politician_document_summary AS 
 SELECT document_data.person_reference_id AS person_id,
    count(document_data.id) AS total_documents,
    sum(CASE WHEN ((document_data.document_type)::text = 'mot'::text) THEN 1 ELSE 0 END) AS total_motions_documents,
    sum(CASE WHEN ((document_data.document_type)::text = 'prop'::text) THEN 1 ELSE 0 END) AS total_propositions_documents,
    sum(CASE WHEN ((document_data.document_type)::text = 'fr'::text) THEN 1 ELSE 0 END) AS total_questions_documents,
    sum(CASE WHEN ((document_data.document_type)::text = 'ip'::text) THEN 1 ELSE 0 END) AS total_interpellations_documents,
    
    sum(CASE WHEN ((document_data.document_type)::text = 'mot'::text) AND (document_data.made_public_date > (CURRENT_DATE - '1 year'::interval)) THEN 1 ELSE 0 END) AS total_motions_documents_last_year,
    sum(CASE WHEN ((document_data.document_type)::text = 'prop'::text) AND (document_data.made_public_date > (CURRENT_DATE - '1 year'::interval)) THEN 1 ELSE 0 END) AS total_propositions_documents_last_year,
    sum(CASE WHEN ((document_data.document_type)::text = 'fr'::text) AND (document_data.made_public_date > (CURRENT_DATE - '1 year'::interval)) THEN 1 ELSE 0 END) AS total_questions_documents_last_year,
    sum(CASE WHEN ((document_data.document_type)::text = 'ip'::text) AND (document_data.made_public_date > (CURRENT_DATE - '1 year'::interval)) THEN 1 ELSE 0 END) AS total_interpellations_documents_last_year,

    sum(CASE WHEN (document_data.made_public_date > (CURRENT_DATE - '1 year'::interval)) THEN 1 ELSE 0 END) AS total_documents_last_year,
    min(document_data.made_public_date) AS first_document_date,
    max(document_data.made_public_date) AS last_document_date
   FROM ( SELECT doc.id,
            doc.document_type,
            doc.made_public_date,
            ref.person_reference_id
           FROM (document_data doc
             JOIN document_person_reference_da_0 ref ON (((doc.id)::text = (ref.document_data_id)::text)))
          WHERE (ref.person_reference_id IS NOT NULL)) document_data
  GROUP BY document_data.person_reference_id;
]]>
        </sql>

        <!-- 2. Recreate View: view_riksdagen_party_member -->
        <sql splitStatements="false" stripComments="false">
<![CDATA[
CREATE OR REPLACE VIEW view_riksdagen_party_member AS 
 SELECT person.id,
    person.first_name,
    person.last_name,
    person.party,
    image.image_url,
    COALESCE(document.total_documents, (0)::bigint) AS total_documents,
    COALESCE(document.total_documents_last_year, (0)::bigint) AS total_documents_last_year
   FROM ((person_data person
     LEFT JOIN view_riksdagen_politician_image image ON (((person.id)::text = (image.person_id)::text)))
     LEFT JOIN view_riksdagen_politician_document_summary document ON (((person.id)::text = (document.person_id)::text)));
]]>
        </sql>

        <!-- 3. Recreate View: view_riksdagen_party -->
        <sql splitStatements="false" stripComments="false">
<![CDATA[
CREATE OR REPLACE VIEW view_riksdagen_party AS 
 SELECT view_riksdagen_party_member.party,
    count(view_riksdagen_party_member.id) AS total_members,
    sum(view_riksdagen_party_member.total_documents) AS total_documents,
    sum(view_riksdagen_party_member.total_documents_last_year) AS total_documents_last_year
   FROM view_riksdagen_party_member
  GROUP BY view_riksdagen_party_member.party;
]]>
        </sql>

        <!-- 4. Recreate View: view_riksdagen_politician -->
        <sql splitStatements="false" stripComments="false">
<![CDATA[
CREATE OR REPLACE VIEW view_riksdagen_politician AS 
 SELECT person.id,
    person.first_name,
    person.last_name,
    person.born_year,
    person.party,
    person.gender,
    image.image_url,
    COALESCE(document.total_documents, (0)::bigint) AS total_documents,
    COALESCE(document.total_documents_last_year, (0)::bigint) AS total_documents_last_year,
    
    COALESCE(document.total_motions_documents, (0)::bigint) AS total_motions_documents,
    COALESCE(document.total_propositions_documents, (0)::bigint) AS total_propositions_documents,
    COALESCE(document.total_questions_documents, (0)::bigint) AS total_questions_documents,
    COALESCE(document.total_interpellations_documents, (0)::bigint) AS total_interpellations_documents,
    
    COALESCE(document.total_motions_documents_last_year, (0)::bigint) AS total_motions_documents_last_year,
    COALESCE(document.total_propositions_documents_last_year, (0)::bigint) AS total_propositions_documents_last_year,
    COALESCE(document.total_questions_documents_last_year, (0)::bigint) AS total_questions_documents_last_year,
    COALESCE(document.total_interpellations_documents_last_year, (0)::bigint) AS total_interpellations_documents_last_year,

    document.first_document_date,
    document.last_document_date,
    COALESCE(assignment.total_assignments, (0)::bigint) AS total_assignments,
    assignment.first_assignment_date,
    assignment.last_assignment_date,
    COALESCE(assignment.total_days_served, (0)::bigint) AS total_days_served,
    COALESCE(assignment.total_days_served_last_year, (0)::bigint) AS total_days_served_last_year,
    COALESCE(assignment.active, false) AS active,
    COALESCE(vote.total_votes, (0)::bigint) AS total_votes,
    COALESCE(vote.total_votes_last_year, (0)::bigint) AS total_votes_last_year,
    COALESCE(ticket.total_votes_present, (0)::bigint) AS total_votes_present,
    COALESCE(ticket.total_votes_absent, (0)::bigint) AS total_votes_absent,
    COALESCE(ticket.total_votes_abstained, (0)::bigint) AS total_votes_abstained,
    COALESCE(ticket.total_votes_yes, (0)::bigint) AS total_votes_yes,
    COALESCE(ticket.total_votes_no, (0)::bigint) AS total_votes_no
   FROM (((((person_data person
     LEFT JOIN view_riksdagen_politician_image image ON (((person.id)::text = (image.person_id)::text)))
     LEFT JOIN view_riksdagen_politician_document_summary document ON (((person.id)::text = (document.person_id)::text)))
     LEFT JOIN view_riksdagen_politician_assignment_summary assignment ON (((person.id)::text = (assignment.person_id)::text)))
     LEFT JOIN view_riksdagen_politician_vote_summary vote ON (((person.id)::text = (vote.person_id)::text)))
     LEFT JOIN view_riksdagen_vote_data_politician_summary ticket ON (((person.id)::text = (ticket.person_id)::text)));
]]>
        </sql>

        <!-- 5. Recreate View: view_riksdagen_politician_ballot_summary -->
        <sql splitStatements="false" stripComments="false">
<![CDATA[
CREATE OR REPLACE VIEW view_riksdagen_politician_ballot_summary AS 
 SELECT person.id AS person_id,
    person.first_name,
    person.last_name,
    person.party,
    vote.total_votes,
    ticket.total_votes_present,
    ticket.total_votes_absent,
    ticket.total_votes_abstained,
    ticket.total_votes_yes,
    ticket.total_votes_no,
    ((ticket.total_votes_present)::double precision / (vote.total_votes)::double precision) AS presence_rate,
    ((ticket.total_votes_absent)::double precision / (vote.total_votes)::double precision) AS absence_rate,
    COALESCE(won.number_ballots_won, (0)::bigint) AS number_ballots_won,
    COALESCE(won.number_ballots_lost, (0)::bigint) AS number_ballots_lost,
    COALESCE(party_rebel.number_ballots_rebel, (0)::bigint) AS number_ballots_party_rebel,
    ((COALESCE(won.number_ballots_won, (0)::bigint))::double precision / (vote.total_votes)::double precision) AS success_rate,
    ((COALESCE(party_rebel.number_ballots_rebel, (0)::bigint))::double precision / (vote.total_votes)::double precision) AS rebel_rate
   FROM ((((view_riksdagen_politician person
     LEFT JOIN view_riksdagen_politician_vote_summary vote ON (((person.id)::text = (vote.person_id)::text)))
     LEFT JOIN view_riksdagen_vote_data_politician_summary ticket ON (((person.id)::text = (ticket.person_id)::text)))
     LEFT JOIN view_riksdagen_politician_ballot_won_summary won ON (((person.id)::text = (won.person_id)::text)))
     LEFT JOIN view_riksdagen_politician_ballot_party_rebel_summary party_rebel ON (((person.id)::text = (party_rebel.person_id)::text)));
]]>
        </sql>

    </changeSet>

</databaseChangeLog>