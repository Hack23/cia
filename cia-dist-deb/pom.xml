<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <parent>
    <artifactId>parent-web-pom</artifactId>
    <groupId>com.hack23.cia</groupId>
    <version>2017.9.15</version>
    <relativePath>../parent-web-pom/pom.xml</relativePath>
  </parent>
  <artifactId>cia-dist-deb</artifactId>
  <packaging>deb</packaging>
  <name>cia-dist-deb</name>
  <url>github:http://hack23.github.io/cia/cia-dist-deb</url>
  <scm>
    <connection>scm:git:https://github.com/Hack23/cia.git</connection>
    <developerConnection>scm:git:https://github.com/Hack23/cia.git</developerConnection>
    <tag>cia-all-2017.9.15</tag>
    <url>https://github.com/Hack23/cia/tree/master/cia-dist-deb</url>
  </scm>
  <distributionManagement>
    <site>
      <id>github</id>
      <url>github:http://hack23.github.io/cia/cia-dist-deb</url>
    </site>
  </distributionManagement>
  <properties>
    <sonar.dependencyCheck.reportPath>${project.basedir}/../parent-pom/src/config/dependency-check-report.xml</sonar.dependencyCheck.reportPath>
  </properties>
  <dependencies>
    <dependency>
      <groupId>org.eclipse.jetty</groupId>
      <artifactId>jetty-distribution</artifactId>
      <version>${cia.project.versions.jetty}</version>
      <type>zip</type>
      <exclusions>
        <exclusion>
          <artifactId>jetty-home</artifactId>
          <groupId>org.eclipse.jetty</groupId>
        </exclusion>
        <exclusion>
          <artifactId>test-jetty-webapp</artifactId>
          <groupId>org.eclipse.jetty</groupId>
        </exclusion>
        <exclusion>
          <artifactId>test-proxy-webapp</artifactId>
          <groupId>org.eclipse.jetty</groupId>
        </exclusion>
      </exclusions>
    </dependency>
    <dependency>
      <groupId>com.hack23.cia</groupId>
      <artifactId>citizen-intelligence-agency</artifactId>
      <version>${project.version}</version>
      <type>war</type>
    </dependency>
    <dependency>
      <groupId>org.ow2.asm</groupId>
      <artifactId>asm-commons</artifactId>
      <version>${cia.project.versions.asm}</version>
    </dependency>
    <dependency>
      <groupId>org.ow2.asm</groupId>
      <artifactId>asm</artifactId>
      <version>${cia.project.versions.asm}</version>
    </dependency>
  </dependencies>
  <build>
    <plugins>
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>keytool-maven-plugin</artifactId>
        <version>1.5</version>
        <executions>
          <execution>
            <id>generateKeyPair</id>
            <phase>generate-resources</phase>
            <goals>
              <goal>generateKeyPair</goal>
            </goals>
            <configuration>
              <alias>ciadistdebkeys</alias>
              <dname>cn=cia.hack23.com, ou=None, L=None, ST=None, o=None, c=SE</dname>
              <sigalg>SHA256withRSA</sigalg>
              <ext></ext>
              <validity>365</validity>
              <keyalg>RSA</keyalg>
              <keysize>4096</keysize>
            </configuration>
          </execution>
          <execution>
            <id>removekeystore</id>
            <phase>clean</phase>
            <goals>
              <goal>clean</goal>
            </goals>
          </execution>
        </executions>
        <configuration>
          <keystore>${project.build.directory}/keystore.jceks</keystore>
          <storepass>changeit</storepass>
          <storetype>JCEKS</storetype>
          <keypass>changeit</keypass>
          <skipIfExist>true</skipIfExist>
        </configuration>
      </plugin>
      <plugin>
        <groupId>com.stratio.mojo.unix</groupId>
        <artifactId>unix-maven-plugin</artifactId>
        <extensions>true</extensions>
        <configuration>
          <contact>cia</contact>
          <id>cia-dist-deb</id>
          <contactEmail>cia@hack23.com</contactEmail>
          <deb>
            <section>devel</section>
            <!-- <depends>zip</depends> -->
            <preDepends>openjdk-8-jdk, ca-certificates-java</preDepends>
            <suggests>postgresql</suggests>
            <!-- <priority></priority> <provides></provides> <recommends></recommends>
							<replaces></replaces> <suggests></suggests> -->
          </deb>
          <packages>
            <package>
              <id>cia-dist-deb</id>
            </package>
          </packages>
          <defaults>
            <fileAttributes>
              <user>cia</user>
              <group>cia</group>
              <mode>0755</mode>
            </fileAttributes>
            <directoryAttributes>
              <user>cia</user>
              <group>cia</group>
              <mode>0755</mode>
            </directoryAttributes>
          </defaults>
          <assembly>
            <extract-artifact>
              <artifact>org.eclipse.jetty:jetty-distribution:zip</artifact>
              <to>/opt/cia</to>
              <pattern>jetty-distribution-${cia.project.versions.jetty}</pattern>
              <replacement>.</replacement>
              <excludes>
                <exclude>**/demo-base/**</exclude>
                <exclude>**/start.ini</exclude>
                <exclude>**/etc/jetty-gzip.xml</exclude>
                <!--  <exclude>**/lib/annotations/asm-5.1.jar</exclude>
                <exclude>**/lib/annotations/asm-commons-5.1.jar</exclude>-->
              </excludes>
            </extract-artifact>
            <!-- 
            <copyArtifact>
              <artifact>org.ow2.asm:asm:jar</artifact>
              <toFile>/opt/cia/lib/annotations/asm-5.1.jar</toFile>
            </copyArtifact>
            <copyArtifact>
              <artifact>org.ow2.asm:asm-commons:jar</artifact>
              <toFile>/opt/cia/lib/annotations/asm-commons-5.1.jar</toFile>
            </copyArtifact>
            -->
            <extract-artifact>
              <artifact>com.hack23.cia:citizen-intelligence-agency:war</artifact>
              <to>/opt/cia/webapps/cia</to>
            </extract-artifact>
            <copyFile>
              <path>src/main/config/jetty/webapps/cia.xml</path>
              <toFile>/opt/cia/webapps/cia.xml</toFile>
            </copyFile>
            <copyFile>
              <path>src/main/config/etc/default/cia</path>
              <toFile>/etc/default/cia</toFile>
            </copyFile>
            <copyFile>
              <path>src/main/config/jetty/start.ini</path>
              <toFile>/opt/cia/start.ini</toFile>
            </copyFile>
            <copyFile>
              <path>${project.build.directory}/keystore.jceks</path>
              <toFile>/opt/cia/etc/keystore.jceks</toFile>
            </copyFile>
            <copyFile>
              <path>src/main/config/jetty/etc/jetty-gzip.xml</path>
              <toFile>/opt/cia/etc/jetty-gzip.xml</toFile>
            </copyFile>
            <copyFile>
              <path>src/main/config/jetty/etc/jetty-start.policy</path>
              <toFile>/opt/cia/etc/jetty-start.policy</toFile>
            </copyFile>
            <copyFile>
              <path>src/main/config/jetty/etc/jetty-cia.policy</path>
              <toFile>/opt/cia/etc/jetty-cia.policy</toFile>
            </copyFile>
          </assembly>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-enforcer-plugin</artifactId>
        <executions>
          <execution>
            <id>enforce-versions</id>
            <goals>
              <goal>enforce</goal>
            </goals>
            <configuration combine.self="override">
              <rules>
                <requireMavenVersion>
                  <version>${cia.project.versions.maven}</version>
                </requireMavenVersion>
                <requireJavaVersion>
                  <version>${jdk.src.version}</version>
                </requireJavaVersion>
              </rules>
            </configuration>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>
</project>
